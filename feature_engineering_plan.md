# План Feature Engineering для Обнаружения Аномалий

Этот документ описывает план добавления новых признаков для улучшения моделей обнаружения аномалий. Признаки сгруппированы по категориям и приоритету.

## Приоритет 1: Ключевые признаки для первого улучшения

Эти признаки выбраны как наиболее перспективные для первой итерации улучшения моделей (VAE, AE, IF).

### А. Базовые + Категория

1.  **`price`**: Цена товара (уже используется).
2.  **`freight_value`**: Стоимость доставки (уже используется).
3.  **`price_deviation_from_category_mean`**: Отклонение цены товара от среднего по его категории.
    *   *Расчет:* `price - category_avg_price`. Требует предварительного расчета `category_avg_price`.
    *   *Значимость:* Выявляет необычно дорогие/дешевые товары для своей категории.
4.  **`freight_deviation_from_category_mean`**: Отклонение стоимости доставки от среднего по категории.
    *   *Расчет:* `freight_value - category_avg_freight`. Требует предварительного расчета `category_avg_freight`.
    *   *Значимость:* Выявляет аномально дорогую/дешевую доставку для категории.

### Б. Временные Характеристики Заказа

5.  **`time_to_approval`**: Время между покупкой и подтверждением оплаты (в часах или днях).
    *   *Расчет:* `order_approved_at - order_purchase_timestamp`.
    *   *Значимость:* Аномально долгое подтверждение может быть подозрительным.
6.  **`shipping_time`**: Время фактической доставки (в днях).
    *   *Расчет:* `order_delivered_customer_date - order_delivered_carrier_date`.
    *   *Значимость:* Слишком быстрая или долгая доставка.
7.  **`estimated_vs_actual_delivery_diff`**: Разница между фактической и оценочной датой доставки (в днях).
    *   *Расчет:* `order_delivered_customer_date - order_estimated_delivery_date`.
    *   *Значимость:* Большие отклонения (особенно сильное опережение или опоздание).

### В. Характеристики Платежей Заказа

8.  **`order_total_payment_value`**: Общая сумма платежей по заказу.
    *   *Расчет:* Агрегация (сумма) `payment_value` из `order_payments` по `order_id`.
    *   *Значимость:* Необычно крупные или мелкие заказы.
9.  **`order_payment_installments_max`**: Максимальное количество платежей по заказу.
    *   *Расчет:* Агрегация (максимум) `payment_installments` из `order_payments` по `order_id`.
    *   *Значимость:* Аномально большое количество платежей в рассрочку.

### Г. Характеристики Состава Заказа

10. **`order_num_items`**: Количество товарных позиций в заказе.
    *   *Расчет:* Агрегация (количество) `order_item_id` по `order_id`.
    *   *Значимость:* Необычно много или мало товаров.
11. **`order_num_sellers`**: Количество уникальных продавцов в заказе.
    *   *Расчет:* Агрегация (количество уникальных) `seller_id` из `order_items` по `order_id`.
    *   *Значимость:* Заказ от множества разных продавцов.
12. **`order_num_categories`**: Количество уникальных категорий товаров в заказе.
    *   *Расчет:* Агрегация (количество уникальных) `product_category_name` из `products` (присоединенных к `order_items`) по `order_id`.
    *   *Значимость:* Слишком разношерстный или слишком однородный заказ.

### Д. Характеристики Отзывов

13. **`review_score`**: Оценка заказа (1-5).
    *   *Расчет:* Взять из `order_reviews` по `order_id`. (Учесть, что отзыв может быть один на заказ).
    *   *Значимость:* Очень низкие оценки могут указывать на проблемные заказы.

## Приоритет 2: Дальнейшие улучшения

Эти признаки можно добавить после реализации и оценки признаков из Приоритета 1.

### А. Физические Характеристики Товара

*   `product_weight_g`
*   `product_volume_cm3`
*   `price_per_weight`
*   `price_per_volume`

### Б. Дополнительные Временные Признаки

*   `processing_time` (Оплата -> Перевозчик)
*   `is_late_delivery` (Флаг опоздания)
*   `purchase_hour`, `purchase_day_of_week`

### В. Дополнительные Признаки Платежей

*   `payment_type_encoded` (One-Hot)
*   `order_value_vs_payment_diff`

### Г. Агрегированные Признаки по Сущностям

*   **Клиент:** `customer_order_count`, `customer_avg_order_value`
*   **Продавец:** `seller_order_count`, `seller_avg_review_score`

### Д. Географические и Графовые Признаки

*   `customer_seller_same_state`
*   `geo_distance_customer_seller` (требует `geolocation`)
*   Другие графовые метрики (центральности, кластеризация)

## Примечания по реализации

*   Большинство признаков (особенно агрегированные) требуют предварительных расчетов и объединения данных из разных таблиц (CSV-файлов). Эту логику удобно реализовать в функции `common.engineer_features` или в `common.load_data_from_db` при загрузке.
*   Категориальные признаки (`product_category_name`, `seller_state` и т.д.) потребуют кодирования перед подачей в модели (кроме, возможно, графовых).
*   При добавлении агрегированных признаков важно избегать утечки данных (data leakage), особенно если признаки рассчитываются на основе будущих событий или информации, недоступной на момент принятия решения.

# Доработки системы обнаружения аномалий (май 2025)

## Исправленные проблемы

1. **Проблемы с StandardScaler**:
   - Исправлено сохранение/загрузка скейлера в VAEDetector
   - Заменена проверка обученности с is_fitted_ на более надежную mean_
   - Улучшена передача данных через numpy.array вместо DataFrame в transform()

2. **Сохранение порога аномалий**:
   - Добавлено сохранение и загрузка параметра threshold_ в VAEDetector
   - Улучшена проверка is_trained с учетом наличия порога
   - Порог теперь используется в логике определения аномалий

3. **Исправление работы с SHAP объяснениями**:
   - Заменен DeepExplainer на GradientExplainer для совместимости с VAE
   - Добавлено сохранение и загрузка фоновых данных для SHAP
   - Перемещение вычислений на CPU для предотвращения проблем с device

4. **Слияние временных данных**:
   - Исправлено слияние по дате в MultilevelDetector
   - Добавлено заполнение пропусков после слияния

5. **Улучшение объяснений детекторов**:
   - Добавлены методы get_explanation_details для временных детекторов
   - Обеспечены подробные объяснения причин аномалий с метриками и пояснениями

## План калибровки системы

1. **Оптимизация порогов**:
   - Снижен final_threshold с 0.5 до 0.4
   - Снижены пороги для временных детекторов с 3.0 до 2.5
   - Снижены пороги уровней transaction_threshold и behavior_threshold с 0.5 до 0.45
   - Скорректированы веса уровней: временной уровень усилен (0.2 → 0.3)

2. **Улучшение объяснений аномалий**:
   - Добавлены детальные методы get_explanation_details для SeasonalDeviationDetector
   - Добавлены детальные методы get_explanation_details для CumulativeSumDetector
   - Улучшена информативность объяснений с конкретными численными метриками
   - Добавлены пояснения на естественном языке в поле explanation_text

3. **Улучшения в работе с SHAP**:
   - Улучшено логирование инициализации SHAP GradientExplainer
   - Добавлены информативные сообщения о состоянии background_data и device

4. **Процесс мониторинга**:
   - Отслеживать количество обнаруживаемых аномалий
   - Анализировать распределение скоров по уровням
   - Оценивать информативность объяснений аномалий
   - Отслеживать соотношение ложноположительных срабатываний

5. **Будущие улучшения**:
   - Добавить интерактивную настройку порогов через UI
   - Реализовать автоматическую калибровку порогов на основе обратной связи
   - Расширить набор метрик для объяснений аномалий 