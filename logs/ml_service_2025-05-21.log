2025-05-21 05:19:47,998 - backend.ml_service - INFO - Логирование настроено с уровнем DEBUG
2025-05-21 05:19:47,999 - backend.ml_service - INFO - Логи записываются в файл: C:\Users\alex\Desktop\AnomaLens3.0\logs\ml_service_2025-05-21.log
2025-05-21 05:19:50,946 - backend.ml_service.multilevel_service - INFO - Базовый путь для моделей (MultilevelService): C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models
2025-05-21 05:19:50,946 - backend.ml_service.multilevel_service - INFO - Создание/инициализация многоуровневой системы на основе настроек из config.yaml.
2025-05-21 05:19:50,947 - backend.ml_service.multilevel_service - DEBUG - Используется следующая конфигурация для MultilevelAnomalyDetector: {
  "transaction_level": [
    {
      "type": "transaction_vae",
      "model_filename": "ml_trans_vae_model.joblib",
      "weight": 1.0,
      "features": [
        "price",
        "freight_value",
        "product_weight_g",
        "freight_to_price_ratio"
      ],
      "encoding_dim": 10,
      "hidden_dim1": 32,
      "hidden_dim2": 16,
      "epochs": 25,
      "kld_weight": 0.5,
      "dropout_rate": 0.1,
      "shap_background_samples": 50
    },
    {
      "type": "category_price_outlier",
      "model_filename": "ml_category_price_model.joblib",
      "weight": 1.0,
      "category_col": "product_category_name",
      "price_col": "price",
      "threshold": 2.8,
      "min_samples_per_category": 10
    }
  ],
  "behavior_level": [
    {
      "type": "graph",
      "model_filename": "ml_graph_model_v3.joblib",
      "weight": 1.0,
      "use_seller_state_spread": true,
      "use_category_diversity": true,
      "use_seller_degree": true,
      "seller_state_weight": 0.3,
      "category_diversity_weight": 0.4,
      "seller_degree_weight": 0.3
    },
    {
      "type": "seller_pricing_behavior",
      "model_filename": "ml_seller_pricing_model.joblib",
      "weight": 1.0,
      "volatility_threshold": 0.5,
      "range_threshold": 5.0,
      "freight_ratio_threshold": 1.0,
      "min_transactions": 5
    }
  ],
  "time_series_level": [
    {
      "type": "seasonal_deviation",
      "model_filename": "seasonal_deviation_model.joblib",
      "weight": 1.0,
      "window_size": 7,
      "threshold": 2.5
    },
    {
      "type": "cumulative_sum",
      "model_filename": "cumulative_sum_model.joblib",
      "weight": 1.0,
      "window_size": 14,
      "threshold": 2.5,
      "drift_threshold": 4.5
    }
  ],
  "combination_weights": {
    "transaction": 0.4,
    "behavior": 0.3,
    "time_series": 0.3
  },
  "transaction_level_combination_method": "weighted_average",
  "behavior_level_combination_method": "weighted_average",
  "time_series_level_combination_method": "average"
}
2025-05-21 05:19:50,948 - backend.ml_service.multilevel_detector - INFO - Инициализация многоуровневой системы обнаружения аномалий...
2025-05-21 05:19:50,948 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'transaction'...
2025-05-21 05:19:50,948 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) VAEDetector инициализирован. Устройство: cpu, Входная размерность: 4, Признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio']
2025-05-21 05:19:50,949 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Сброс базового состояния детектора (из AnomalyDetector._reset_state).
2025-05-21 05:19:50,949 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Специфичное состояние VAEDetector (порог, SHAP) сброшено.
2025-05-21 05:19:50,949 - backend.ml_service.transaction_detectors - INFO - (transaction_vae_price) TransactionVAEDetector инициализирован. Конфигурационные признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], Реально используемые признаки (с генерируемыми): ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], encoding_dim(latent_dim): 10, hidden_dim1(hidden_dim): 32, hidden_dim2: 16, epochs: 25, batch_size: 64, lr: 0.001, kld_w: 0.5, dropout: 0.1
2025-05-21 05:19:50,949 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора transaction_vae_price типа transaction_vae
2025-05-21 05:19:50,950 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_trans_vae_model.joblib' установлен для transaction_vae_price
2025-05-21 05:19:50,950 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib'
2025-05-21 05:19:50,950 - backend.ml_service.detector - INFO - Попытка загрузки модели transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib...
2025-05-21 05:19:50,958 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Загружен порог аномальности: 3.656726
2025-05-21 05:19:50,959 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler успешно инициализирован с параметрами: n_features_in_=4, mean_=(4,), scale_=(4,)
2025-05-21 05:19:50,959 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Фоновые данные SHAP загружены (torch.Size([50, 4]))
2025-05-21 05:19:50,962 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Модель VAE успешно загружена и перемещена на cpu.
2025-05-21 05:19:50,963 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Попытка пересоздания SHAP GradientExplainer после загрузки...
2025-05-21 05:19:50,969 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно ПЕРЕСОЗДАН при загрузке модели. Device=cpu, background_data.shape=torch.Size([50, 4])
2025-05-21 05:19:50,969 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Статус SHAP после загрузки: background_data shape=torch.Size([50, 4]), device=cpu, explainer=создан
2025-05-21 05:19:50,970 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детектор VAE (is_trained=True) успешно загружен.
2025-05-21 05:19:50,970 - backend.ml_service.detector - INFO - Модель transaction_vae_price успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib. is_trained=True
2025-05-21 05:19:50,970 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib
2025-05-21 05:19:50,970 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib.
2025-05-21 05:19:50,970 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) инициализирован с весом 1.0.
2025-05-21 05:19:50,970 - backend.ml_service.transaction_detectors - INFO - CategoryPriceOutlierDetector 'category_price_outlier_model' инициализирован с параметрами: category_col='product_category_name', price_col='price', threshold=2.8, min_samples_per_category=10
2025-05-21 05:19:50,971 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора category_price_outlier_model типа category_price_outlier
2025-05-21 05:19:50,971 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_category_price_model.joblib' установлен для category_price_outlier_model
2025-05-21 05:19:50,971 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib'
2025-05-21 05:19:50,971 - backend.ml_service.detector - INFO - Попытка загрузки модели category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib...
2025-05-21 05:19:50,973 - backend.ml_service.detector - INFO - Модель category_price_outlier_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib. is_trained=True
2025-05-21 05:19:50,974 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib
2025-05-21 05:19:50,974 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib.
2025-05-21 05:19:50,974 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) инициализирован с весом 1.0.
2025-05-21 05:19:50,974 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'behavior'...
2025-05-21 05:19:50,975 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора graph_graph_analysis типа graph
2025-05-21 05:19:50,975 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_graph_model_v3.joblib' установлен для graph_graph_analysis
2025-05-21 05:19:50,975 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib'
2025-05-21 05:19:50,975 - backend.ml_service.detector - INFO - Попытка загрузки модели graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib...
2025-05-21 05:19:50,976 - backend.ml_service.detector - INFO - Модель graph_graph_analysis успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib. is_trained=True
2025-05-21 05:19:50,976 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib
2025-05-21 05:19:50,976 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib.
2025-05-21 05:19:50,976 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) инициализирован с весом 1.0.
2025-05-21 05:19:50,976 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seller_pricing_behavior_model типа seller_pricing_behavior
2025-05-21 05:19:50,976 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_seller_pricing_model.joblib' установлен для seller_pricing_behavior_model
2025-05-21 05:19:50,977 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib'
2025-05-21 05:19:50,977 - backend.ml_service.detector - INFO - Попытка загрузки модели seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib...
2025-05-21 05:19:50,977 - backend.ml_service.detector - INFO - Модель seller_pricing_behavior_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib. is_trained=True
2025-05-21 05:19:50,977 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib
2025-05-21 05:19:50,978 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib.
2025-05-21 05:19:50,978 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) инициализирован с весом 1.0.
2025-05-21 05:19:50,978 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'time_series'...
2025-05-21 05:19:50,978 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seasonal_deviation_model типа seasonal_deviation
2025-05-21 05:19:50,978 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='seasonal_deviation_model.joblib' установлен для seasonal_deviation_model
2025-05-21 05:19:50,979 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib'
2025-05-21 05:19:50,979 - backend.ml_service.detector - INFO - Попытка загрузки модели seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib...
2025-05-21 05:19:50,980 - backend.ml_service.detector - INFO - Модель seasonal_deviation_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib. is_trained=True
2025-05-21 05:19:50,980 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib
2025-05-21 05:19:50,980 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib.
2025-05-21 05:19:50,980 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) инициализирован с весом 1.0.
2025-05-21 05:19:50,981 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора cumulative_sum_model типа cumulative_sum
2025-05-21 05:19:50,981 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='cumulative_sum_model.joblib' установлен для cumulative_sum_model
2025-05-21 05:19:50,981 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib'
2025-05-21 05:19:50,981 - backend.ml_service.detector - INFO - Попытка загрузки модели cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib...
2025-05-21 05:19:50,982 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Загружены baseline_mean=3696.0057142857145, baseline_std=4060.74644512314 из model_state.
2025-05-21 05:19:50,982 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Детектор CUSUM успешно загружен и помечен как обученный.
2025-05-21 05:19:50,982 - backend.ml_service.detector - INFO - Модель cumulative_sum_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib. is_trained=True
2025-05-21 05:19:50,982 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib
2025-05-21 05:19:50,983 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib.
2025-05-21 05:19:50,983 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) инициализирован с весом 1.0.
2025-05-21 05:19:50,983 - backend.ml_service.multilevel_detector - INFO - Многоуровневая система инициализирована: 2 транзакционных детекторов (метод: weighted_average), 2 поведенческих детекторов (метод: weighted_average), 2 детекторов временных рядов (метод: average)
2025-05-21 05:19:50,983 - backend.ml_service.multilevel_service - INFO - Многоуровневая система успешно создана на основе конфигурации из settings.yaml.
2025-05-21 05:19:50,992 - backend.ml_service - INFO - ML Service Logger активен. Уровень: DEBUG. Директория логов ml_service: C:\Users\alex\Desktop\AnomaLens3.0\logs
2025-05-21 05:19:57,729 - backend.ml_service.multilevel_service - INFO - [TaskID: 0647c553-56e9-4bea-a447-7ff120d02259] Обертка detect_async_task_wrapper запущена.
2025-05-21 05:19:57,730 - backend.ml_service.multilevel_service - INFO - Начало обнаружения аномалий (multilevel) с сохранением в БД...
2025-05-21 05:19:57,730 - backend.ml_service.multilevel_service - INFO - Загрузка данных из БД для multilevel detect...
2025-05-21 05:19:57,731 - backend.ml_service.common - INFO - Загрузка данных из БД за период: 1998-01-03 05:19:57.727796 - None (с ассоциациями)
2025-05-21 05:20:01,345 - backend.ml_service.common - INFO - Загружено 118310 записей OrderItem.
2025-05-21 05:20:01,346 - backend.ml_service.multilevel_service - INFO - Данные для multilevel detect (118310 строк) подготовлены. Применение инженерии признаков...
2025-05-21 05:20:01,472 - backend.ml_service.common - INFO - Добавлен признак: 'price_deviation_from_category_mean'
2025-05-21 05:20:01,473 - backend.ml_service.common - INFO - Добавлен признак: 'freight_to_price_ratio'
2025-05-21 05:20:01,474 - backend.ml_service.multilevel_service - INFO - Инженерия признаков для детекции завершена.
2025-05-21 05:20:01,474 - backend.ml_service.multilevel_service - INFO - Запуск multilevel_detector.detect()...
2025-05-21 05:20:01,499 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: transaction...
2025-05-21 05:20:01,500 - backend.ml_service.multilevel_detector - INFO - Уровень 'transaction': Запуск детектора 'transaction_vae_price'...
2025-05-21 05:20:01,526 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Запуск детекции...
2025-05-21 05:20:01,787 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:20:01,788 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:20:01,788 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:20:01,788 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:20:01,788 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:20:02,798 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детекция завершена. Время: 1.27 сек.
2025-05-21 05:20:02,813 - backend.ml_service.multilevel_detector - INFO - Детектор 'transaction_vae_price' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0067
2025-05-21 05:20:02,814 - backend.ml_service.multilevel_detector - INFO - Уровень 'transaction': Запуск детектора 'category_price_outlier_model'...
2025-05-21 05:20:03,199 - backend.ml_service.transaction_detectors - INFO - Для 10 товаров с неизвестными категориями присвоен высокий скор аномальности.
2025-05-21 05:20:03,201 - backend.ml_service.transaction_detectors - INFO - Детектор category_price_outlier_model: обнаружено 2104 аномалий из 118310 транзакций
2025-05-21 05:20:03,225 - backend.ml_service.multilevel_detector - INFO - Детектор 'category_price_outlier_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0115
2025-05-21 05:20:03,240 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction): Матрица скоров (shape (2, 118310)), метод: weighted_average
2025-05-21 05:20:03,246 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction, метод: weighted_average): Используемые веса: {'transaction_vae_price': 1.0, 'category_price_outlier_model': 1.0}, массив весов: [1. 1.]
2025-05-21 05:20:03,247 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction, метод: weighted_average): Распределение combined_scores: Min=0.0001, Max=0.9663, Mean=0.0091
2025-05-21 05:20:03,269 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'transaction' завершен. Добавлен столбец 'transaction_score' и индивидуальные скоры детекторов.
2025-05-21 05:20:03,270 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: behavior...
2025-05-21 05:20:03,381 - backend.ml_service.multilevel_detector - INFO - Детектор 'graph_graph_analysis' типа GraphAnomalyDetector получит оригинальные данные, а не агрегированные
2025-05-21 05:20:03,382 - backend.ml_service.multilevel_detector - INFO - Уровень 'behavior': Запуск детектора 'graph_graph_analysis'...
2025-05-21 05:20:03,401 - backend.ml_service.graph_detector - INFO - Построение графа...
2025-05-21 05:20:07,729 - backend.ml_service.graph_detector - INFO - Граф построен за 4.26 сек. Узлов: 346028, Ребер: 436616
2025-05-21 05:20:07,790 - backend.ml_service.graph_detector - INFO - Расчет графовых аномальных скоров для 112650 узлов OrderItem...
2025-05-21 05:20:09,430 - backend.ml_service.graph_detector - INFO - Детектор graph_graph_analysis: обнаружено 0 аномалий из 118310 (112650 обработано графом)
2025-05-21 05:20:09,483 - backend.ml_service.multilevel_detector - INFO - Детектор 'graph_graph_analysis' обработан. Распределение нормализованных скоров: Min=0.0000, Max=0.6667, Mean=0.1571
2025-05-21 05:20:09,483 - backend.ml_service.multilevel_detector - INFO - Уровень 'behavior': Запуск детектора 'seller_pricing_behavior_model'...
2025-05-21 05:20:09,486 - backend.ml_service.behavior_detectors - INFO - Детектор seller_pricing_behavior_model: обнаружено 389 аномалий из 3095 продавцов
2025-05-21 05:20:09,496 - backend.ml_service.multilevel_detector - INFO - Детектор 'seller_pricing_behavior_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0644
2025-05-21 05:20:09,497 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior): Матрица скоров (shape (2, 3095)), метод: weighted_average
2025-05-21 05:20:09,498 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior, метод: weighted_average): Используемые веса: {'graph_graph_analysis': 1.0, 'seller_pricing_behavior_model': 1.0}, массив весов: [1. 1.]
2025-05-21 05:20:09,499 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior, метод: weighted_average): Распределение combined_scores: Min=0.0000, Max=0.5785, Mean=0.1108
2025-05-21 05:20:09,500 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'behavior' завершен. Добавлен столбец 'behavior_score' и индивидуальные скоры детекторов.
2025-05-21 05:20:09,649 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: time_series...
2025-05-21 05:20:09,725 - backend.ml_service.multilevel_detector - INFO - Уровень 'time_series': Запуск детектора 'seasonal_deviation_model'...
2025-05-21 05:20:09,728 - backend.ml_service.time_series_detectors - INFO - Детектор seasonal_deviation_model: обнаружено 160 аномалий из 616 временных точек
2025-05-21 05:20:09,729 - backend.ml_service.multilevel_detector - INFO - Детектор 'seasonal_deviation_model' обработан. Распределение нормализованных скоров: Min=0.0012, Max=1.0000, Mean=0.6384
2025-05-21 05:20:09,729 - backend.ml_service.multilevel_detector - INFO - Уровень 'time_series': Запуск детектора 'cumulative_sum_model'...
2025-05-21 05:20:09,758 - backend.ml_service.time_series_detectors - INFO - Детектор cumulative_sum_model: обнаружено 614 аномалий из 616 временных точек
2025-05-21 05:20:09,759 - backend.ml_service.multilevel_detector - INFO - Детектор 'cumulative_sum_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.3781
2025-05-21 05:20:09,760 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: time_series): Матрица скоров (shape (2, 616)), метод: average
2025-05-21 05:20:09,760 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: time_series, метод: average): Распределение combined_scores: Min=0.0298, Max=1.0000, Mean=0.5082
2025-05-21 05:20:09,761 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'time_series' завершен. Добавлен столбец 'time_series_score' и индивидуальные скоры детекторов.
2025-05-21 05:20:09,792 - backend.ml_service.multilevel_detector - INFO - Слияние временных данных: result_df имеет 118310 строк, 616 уникальных дат
2025-05-21 05:20:09,793 - backend.ml_service.multilevel_detector - INFO - Слияние временных данных: ts_scores_to_merge имеет 616 строк, 616 уникальных дат
2025-05-21 05:20:09,863 - backend.ml_service.multilevel_detector - DEBUG - Распределение transaction_level_score: Min=0.0001, Max=0.9663, Mean=0.0091
2025-05-21 05:20:09,864 - backend.ml_service.multilevel_detector - DEBUG - Распределение behavior_level_score: Min=0.0000, Max=0.5785, Mean=0.1589
2025-05-21 05:20:09,865 - backend.ml_service.multilevel_detector - DEBUG - Распределение time_series_level_score: Min=0.0298, Max=1.0000, Mean=0.5518
2025-05-21 05:20:09,865 - backend.ml_service.multilevel_detector - INFO - Расчет итогового многоуровневого скора...
2025-05-21 05:20:09,867 - backend.ml_service.multilevel_detector - DEBUG - Распределение multilevel_score (перед порогом): Min=0.0122, Max=0.6074, Mean=0.2169
2025-05-21 05:20:09,868 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8307, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,869 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:20:09,869 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-29 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:09,870 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-29 00:00:00
2025-05-21 05:20:09,873 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
583 2018-07-29          188      32085.4  145.842727             150               188               2018-07-29  35787.032857         0.896565           0.879612                           0.830683                       0.928541    2018-07-29
2025-05-21 05:20:09,873 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}]
2025-05-21 05:20:09,874 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:09,874 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.8306826658975347, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}]
2025-05-21 05:20:09,874 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9285, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,874 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:20:09,875 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-29 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:09,876 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-29 00:00:00
2025-05-21 05:20:09,877 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
583 2018-07-29          188      32085.4  145.842727             150               188               2018-07-29  35787.032857         0.896565           0.879612                           0.830683                       0.928541    2018-07-29
2025-05-21 05:20:09,878 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-07-29 00:00:00", "current_value": 32085.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 28389.394285714287, "deviation_in_std": 6.991176294646339, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (32085.40) отклоняется от базовой линии (3696.01) на 28389.39, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:20:09,878 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:09,878 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.8306826658975347, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.928540895759355, "explanation": {"detector_specific_info": {"date": "2018-07-29 00:00:00", "current_value": 32085.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 28389.394285714287, "deviation_in_std": 6.991176294646339, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (32085.40) отклоняется от базовой линии (3696.01) на 28389.39, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:20:09,879 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,879 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:20:09,880 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:09,881 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-03 00:00:00
2025-05-21 05:20:09,882 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales  avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
588 2018-08-03          314     45036.63  125.10175             216               314               2018-08-03  39138.992857         1.150684           0.972436                                1.0                       0.944872    2018-08-03
2025-05-21 05:20:09,883 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:20:09,883 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:09,883 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:20:09,883 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9449, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,884 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:20:09,884 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:09,885 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-03 00:00:00
2025-05-21 05:20:09,887 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales  avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
588 2018-08-03          314     45036.63  125.10175             216               314               2018-08-03  39138.992857         1.150684           0.972436                                1.0                       0.944872    2018-08-03
2025-05-21 05:20:09,888 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-03 00:00:00", "current_value": 45036.63, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 41340.624285714286, "deviation_in_std": 10.18054804563417, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (45036.63) отклоняется от базовой линии (3696.01) на 41340.62, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:20:09,888 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:09,888 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9448723295452219, "explanation": {"detector_specific_info": {"date": "2018-08-03 00:00:00", "current_value": 45036.63, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 41340.624285714286, "deviation_in_std": 10.18054804563417, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (45036.63) отклоняется от базовой линии (3696.01) на 41340.62, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:20:09,889 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,889 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:20:09,889 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:09,890 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-03 00:00:00
2025-05-21 05:20:09,892 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
527 2018-06-03          191      31535.8  137.112174             149               191               2018-06-03  27063.432857         1.165255           0.903771                                1.0                       0.807541    2018-06-03
2025-05-21 05:20:09,892 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}]
2025-05-21 05:20:09,893 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:09,893 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}]
2025-05-21 05:20:09,893 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8075, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,894 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:20:09,894 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:09,895 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-03 00:00:00
2025-05-21 05:20:09,897 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
527 2018-06-03          191      31535.8  137.112174             149               191               2018-06-03  27063.432857         1.165255           0.903771                                1.0                       0.807541    2018-06-03
2025-05-21 05:20:09,897 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-03 00:00:00", "current_value": 31535.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 27839.794285714284, "deviation_in_std": 6.855831720089102, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (31535.80) отклоняется от базовой линии (3696.01) на 27839.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:20:09,898 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:09,898 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8075414451585549, "explanation": {"detector_specific_info": {"date": "2018-06-03 00:00:00", "current_value": 31535.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 27839.794285714284, "deviation_in_std": 6.855831720089102, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (31535.80) отклоняется от базовой линии (3696.01) на 27839.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:20:09,898 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 26323, order_id: 0812eb902a67711a1cb742b3cdaa65ae, level: transaction): Detector Column: 'trans_transaction_vae_price_score', Score: 0.9326, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,898 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'transaction_vae_price': TransactionVAEDetector
2025-05-21 05:20:09,905 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'transaction_vae_price':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id  product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
26323              1  0812eb902a67711a1cb742b3cdaa65ae  489ae2aa008f021502940f251d4cce7f  e3b4998c7a498169dc7bce44e6bb6277  6735.0         194.31      2017-02-12 20:37:36  c6e2731c5b391845f6800c97401a43a9  utilidades_domesticas                 31.0                       875.0                 2.0           30000.0               60.0               61.0              33.0                    housewares             MS           SP  credit_card                   8.0        6929.31           5.0                           74.309637                0.028851                 0.966324                    True                           0.932648                                       1.0              0.398596                False                           0.15721                                   0.639983                 0.189451                           0.367431                        0.01147                   False          0.562944        True                       None
2025-05-21 05:20:09,905 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Метод get_explanation_details не реализован специфично, будет использована реализация get_shap_explanations (если есть).
2025-05-21 05:20:09,907 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:20:09,908 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:20:09,908 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:20:09,908 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:20:09,908 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:20:09,909 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Вычисление SHAP values для 1 экземпляров...
2025-05-21 05:20:09,909 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Используется nsamples=50 для SHAP
2025-05-21 05:20:09,909 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Запрос SHAP объяснений: explainer=True, background_data_exists=True, model=True
2025-05-21 05:20:09,910 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Создание GradientExplainer с размерами данных: torch.Size([50, 4])
2025-05-21 05:20:09,930 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw type: <class 'numpy.ndarray'>
2025-05-21 05:20:09,930 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw (ndarray) shape: (1, 4, 1)
2025-05-21 05:20:09,931 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно создан и вычислены SHAP-значения
2025-05-21 05:20:09,931 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values_raw уже является ndarray, shape: (1, 4, 1)
2025-05-21 05:20:09,931 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP values успешно вычислены для 1 экземпляров.
2025-05-21 05:20:09,931 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'transaction_vae_price': [{"shap_values": {"price": 38.59754215728619, "freight_value": -1.7667463581286023, "product_weight_g": 2.828550748642828, "freight_to_price_ratio": -0.3679422390794095}}]
2025-05-21 05:20:09,932 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'transaction_vae_price' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:09,932 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.9326477983089546, "explanation": {"shap_values": {"price": 38.59754215728619, "freight_value": -1.7667463581286023, "product_weight_g": 2.828550748642828, "freight_to_price_ratio": -0.3679422390794095}}}]
2025-05-21 05:20:09,932 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 26323, order_id: 0812eb902a67711a1cb742b3cdaa65ae, level: transaction): Detector Column: 'trans_category_price_outlier_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,932 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'category_price_outlier_model': CategoryPriceOutlierDetector
2025-05-21 05:20:09,939 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'category_price_outlier_model':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id  product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
26323              1  0812eb902a67711a1cb742b3cdaa65ae  489ae2aa008f021502940f251d4cce7f  e3b4998c7a498169dc7bce44e6bb6277  6735.0         194.31      2017-02-12 20:37:36  c6e2731c5b391845f6800c97401a43a9  utilidades_domesticas                 31.0                       875.0                 2.0           30000.0               60.0               61.0              33.0                    housewares             MS           SP  credit_card                   8.0        6929.31           5.0                           74.309637                0.028851                 0.966324                    True                           0.932648                                       1.0              0.398596                False                           0.15721                                   0.639983                 0.189451                           0.367431                        0.01147                   False          0.562944        True                       None
2025-05-21 05:20:09,940 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'category_price_outlier_model': [{"detector_specific_info": {"category": "utilidades_domesticas", "price": 6735.0, "category_mean_price": 90.63427371273713, "category_std_price": 140.19371115720259, "category_min_price": 3.06, "category_max_price": 6735.0, "category_count": 7380, "z_score": 47.394178179909765, "threshold": 2.8, "explanation": "Цена 6735.00 отличается от средней цены в категории 'utilidades_domesticas' (90.63) на 47.39 стандартных отклонений (порог: 2.8)."}}]
2025-05-21 05:20:09,941 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'category_price_outlier_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:09,941 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.9326477983089546, "explanation": {"shap_values": {"price": 38.59754215728619, "freight_value": -1.7667463581286023, "product_weight_g": 2.828550748642828, "freight_to_price_ratio": -0.3679422390794095}}}, {"detector_name": "category_price_outlier_model", "detector_type": "CategoryPriceOutlierDetector", "score": 1.0, "explanation": {"detector_specific_info": {"category": "utilidades_domesticas", "price": 6735.0, "category_mean_price": 90.63427371273713, "category_std_price": 140.19371115720259, "category_min_price": 3.06, "category_max_price": 6735.0, "category_count": 7380, "z_score": 47.394178179909765, "threshold": 2.8, "explanation": "Цена 6735.00 отличается от средней цены в категории 'utilidades_domesticas' (90.63) на 47.39 стандартных отклонений (порог: 2.8)."}}}]
2025-05-21 05:20:09,941 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,942 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:20:09,942 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-25 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:09,943 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-25 00:00:00
2025-05-21 05:20:09,944 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
579 2018-07-25          268     40753.19  122.750572             201               268               2018-07-25  35288.758571         1.154849           0.959618                                1.0                       0.919235    2018-07-25
2025-05-21 05:20:09,945 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:20:09,945 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:09,945 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:20:09,946 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9192, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,946 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:20:09,946 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-25 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:09,947 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-25 00:00:00
2025-05-21 05:20:09,950 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
579 2018-07-25          268     40753.19  122.750572             201               268               2018-07-25  35288.758571         1.154849           0.959618                                1.0                       0.919235    2018-07-25
2025-05-21 05:20:09,950 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-07-25 00:00:00", "current_value": 40753.19, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37057.18428571429, "deviation_in_std": 9.125707498979427, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (40753.19) отклоняется от базовой линии (3696.01) на 37057.18, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:20:09,951 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:09,951 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9192352183494302, "explanation": {"detector_specific_info": {"date": "2018-07-25 00:00:00", "current_value": 40753.19, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37057.18428571429, "deviation_in_std": 9.125707498979427, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (40753.19) отклоняется от базовой линии (3696.01) на 37057.18, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:20:09,952 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 42860, order_id: 90674f59a21207f91a7387785c66f340, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,952 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:20:09,952 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-14 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:09,953 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-14 00:00:00
2025-05-21 05:20:09,955 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
599 2018-08-14          315     44682.42  128.397759             228               315               2018-08-14  37562.228571         1.189557           0.989198                                1.0                       0.978396    2018-08-14
2025-05-21 05:20:09,955 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:20:09,956 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:09,956 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:20:09,956 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 42860, order_id: 90674f59a21207f91a7387785c66f340, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9784, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,956 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:20:09,957 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-14 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:09,958 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-14 00:00:00
2025-05-21 05:20:09,960 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
599 2018-08-14          315     44682.42  128.397759             228               315               2018-08-14  37562.228571         1.189557           0.989198                                1.0                       0.978396    2018-08-14
2025-05-21 05:20:09,960 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-14 00:00:00", "current_value": 44682.42, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 40986.41428571429, "deviation_in_std": 10.093320240405061, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (44682.42) отклоняется от базовой линии (3696.01) на 40986.41, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:20:09,960 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:09,961 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9783962277530719, "explanation": {"detector_specific_info": {"date": "2018-08-14 00:00:00", "current_value": 44682.42, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 40986.41428571429, "deviation_in_std": 10.093320240405061, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (44682.42) отклоняется от базовой линии (3696.01) на 40986.41, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:20:09,961 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: transaction): Detector Column: 'trans_transaction_vae_price_score', Score: 0.9929, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,962 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'transaction_vae_price': TransactionVAEDetector
2025-05-21 05:20:09,968 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'transaction_vae_price':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
57579              1  3dd5626c63f493f8b8f8788c2be24baa  3a1855685a49813f60e6193864f7215e  c510bc1718f0f2961eaa42a23330681a  2699.0         306.06      2018-04-27 19:50:43  a8f345f82667eb421151dc7626147636                 bebes                 54.0                      2583.0                10.0           11450.0               57.0               78.0              44.0                          baby             SC           SP  credit_card                  10.0        3005.06           5.0                           19.887203                0.113398                 0.616717                    True                           0.992878                                  0.240557              0.379093                False                          0.147594                                   0.610592                 0.823398                           0.928073                       0.718724                    True          0.607434        True                       None
2025-05-21 05:20:09,968 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Метод get_explanation_details не реализован специфично, будет использована реализация get_shap_explanations (если есть).
2025-05-21 05:20:09,971 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:20:09,971 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:20:09,971 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:20:09,972 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:20:09,972 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:20:09,972 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Вычисление SHAP values для 1 экземпляров...
2025-05-21 05:20:09,973 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Используется nsamples=50 для SHAP
2025-05-21 05:20:09,973 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Запрос SHAP объяснений: explainer=True, background_data_exists=True, model=True
2025-05-21 05:20:09,973 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Создание GradientExplainer с размерами данных: torch.Size([50, 4])
2025-05-21 05:20:09,990 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw type: <class 'numpy.ndarray'>
2025-05-21 05:20:09,991 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw (ndarray) shape: (1, 4, 1)
2025-05-21 05:20:09,991 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно создан и вычислены SHAP-значения
2025-05-21 05:20:09,991 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values_raw уже является ndarray, shape: (1, 4, 1)
2025-05-21 05:20:09,991 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP values успешно вычислены для 1 экземпляров.
2025-05-21 05:20:09,992 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'transaction_vae_price': [{"shap_values": {"price": 54.06542421729323, "freight_value": -5.453120382067632, "product_weight_g": -5.421446375319042, "freight_to_price_ratio": 2.3367069389373594}}]
2025-05-21 05:20:09,992 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'transaction_vae_price' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:09,992 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.9928777430405665, "explanation": {"shap_values": {"price": 54.06542421729323, "freight_value": -5.453120382067632, "product_weight_g": -5.421446375319042, "freight_to_price_ratio": 2.3367069389373594}}}]
2025-05-21 05:20:09,993 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: transaction): Detector Column: 'trans_category_price_outlier_model_score', Score: 0.2406, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:09,993 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'category_price_outlier_model': CategoryPriceOutlierDetector
2025-05-21 05:20:09,998 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'category_price_outlier_model':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
57579              1  3dd5626c63f493f8b8f8788c2be24baa  3a1855685a49813f60e6193864f7215e  c510bc1718f0f2961eaa42a23330681a  2699.0         306.06      2018-04-27 19:50:43  a8f345f82667eb421151dc7626147636                 bebes                 54.0                      2583.0                10.0           11450.0               57.0               78.0              44.0                          baby             SC           SP  credit_card                  10.0        3005.06           5.0                           19.887203                0.113398                 0.616717                    True                           0.992878                                  0.240557              0.379093                False                          0.147594                                   0.610592                 0.823398                           0.928073                       0.718724                    True          0.607434        True                       None
2025-05-21 05:20:09,999 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'category_price_outlier_model': [{"detector_specific_info": {"category": "bebes", "price": 2699.0, "category_mean_price": 135.71541510611735, "category_std_price": 224.82969338108902, "category_min_price": 3.54, "category_max_price": 3899.0, "category_count": 3204, "z_score": 11.401005562681993, "threshold": 2.8, "explanation": "Цена 2699.00 отличается от средней цены в категории 'bebes' (135.72) на 11.40 стандартных отклонений (порог: 2.8)."}}]
2025-05-21 05:20:10,000 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'category_price_outlier_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,000 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.9928777430405665, "explanation": {"shap_values": {"price": 54.06542421729323, "freight_value": -5.453120382067632, "product_weight_g": -5.421446375319042, "freight_to_price_ratio": 2.3367069389373594}}}, {"detector_name": "category_price_outlier_model", "detector_type": "CategoryPriceOutlierDetector", "score": 0.24055704531923383, "explanation": {"detector_specific_info": {"category": "bebes", "price": 2699.0, "category_mean_price": 135.71541510611735, "category_std_price": 224.82969338108902, "category_min_price": 3.54, "category_max_price": 3899.0, "category_count": 3204, "z_score": 11.401005562681993, "threshold": 2.8, "explanation": "Цена 2699.00 отличается от средней цены в категории 'bebes' (135.72) на 11.40 стандартных отклонений (порог: 2.8)."}}}]
2025-05-21 05:20:10,000 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.9281, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,000 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:20:10,001 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-04-27 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,001 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-04-27 00:00:00
2025-05-21 05:20:10,003 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
490 2018-04-27          242     41231.39  140.242823             165               242               2018-04-27  35298.295714         1.168084           0.823398                           0.928073                       0.718724    2018-04-27
2025-05-21 05:20:10,004 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:20:10,004 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,004 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9280726698190791, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:20:10,005 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.7187, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,005 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:20:10,005 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-04-27 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,006 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-04-27 00:00:00
2025-05-21 05:20:10,008 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
490 2018-04-27          242     41231.39  140.242823             165               242               2018-04-27  35298.295714         1.168084           0.823398                           0.928073                       0.718724    2018-04-27
2025-05-21 05:20:10,008 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-04-27 00:00:00", "current_value": 41231.39, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37535.38428571429, "deviation_in_std": 9.243469099331083, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (41231.39) отклоняется от базовой линии (3696.01) на 37535.38, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:20:10,008 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,009 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9280726698190791, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.718723936134046, "explanation": {"detector_specific_info": {"date": "2018-04-27 00:00:00", "current_value": 41231.39, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37535.38428571429, "deviation_in_std": 9.243469099331083, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (41231.39) отклоняется от базовой линии (3696.01) на 37535.38, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:20:10,009 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 74778, order_id: 94fca82966c05ba707f4e7dc0c50aa3c, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,009 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:20:10,010 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,011 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:20:10,013 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:20:10,013 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:20:10,014 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,014 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:20:10,014 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 74778, order_id: 94fca82966c05ba707f4e7dc0c50aa3c, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9819, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,015 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:20:10,015 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,016 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:20:10,018 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:20:10,019 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:20:10,019 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,019 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9819435388597458, "explanation": {"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:20:10,020 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 75482, order_id: 4160b6447ad70e6d73f7221dd970bbe9, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,020 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:20:10,020 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,021 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:20:10,023 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:20:10,024 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:20:10,024 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,024 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:20:10,025 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 75482, order_id: 4160b6447ad70e6d73f7221dd970bbe9, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9819, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,025 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:20:10,025 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,026 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:20:10,029 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:20:10,030 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:20:10,030 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,030 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9819435388597458, "explanation": {"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:20:10,031 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.9481, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,031 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:20:10,031 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-01-26 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,032 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-01-26 00:00:00
2025-05-21 05:20:10,035 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
399 2018-01-26          228     34533.35  125.575818             151               228               2018-01-26       31895.5         1.082703           0.722093                           0.948138                       0.496047    2018-01-26
2025-05-21 05:20:10,035 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:20:10,035 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,036 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9481383115297547, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:20:10,036 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.4960, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,036 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:20:10,036 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-01-26 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,037 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-01-26 00:00:00
2025-05-21 05:20:10,040 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
399 2018-01-26          228     34533.35  125.575818             151               228               2018-01-26       31895.5         1.082703           0.722093                           0.948138                       0.496047    2018-01-26
2025-05-21 05:20:10,040 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-01-26 00:00:00", "current_value": 34533.35, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 30837.344285714284, "deviation_in_std": 7.594008811544785, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34533.35) отклоняется от базовой линии (3696.01) на 30837.34, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:20:10,040 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,041 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9481383115297547, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.496047165599019, "explanation": {"detector_specific_info": {"date": "2018-01-26 00:00:00", "current_value": 34533.35, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 30837.344285714284, "deviation_in_std": 7.594008811544785, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34533.35) отклоняется от базовой линии (3696.01) на 30837.34, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:20:10,041 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87594, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8164, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,041 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:20:10,042 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,042 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:20:10,044 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:20:10,045 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:20:10,045 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,046 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:20:10,046 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87594, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8123, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,046 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:20:10,047 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,048 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:20:10,050 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:20:10,050 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:20:10,051 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,051 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8122690239748033, "explanation": {"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:20:10,051 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87595, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8164, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,052 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:20:10,052 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,053 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:20:10,055 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:20:10,055 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:20:10,056 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,056 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:20:10,056 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87595, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8123, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,056 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:20:10,057 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,058 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:20:10,060 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:20:10,060 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:20:10,061 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,061 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8122690239748033, "explanation": {"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:20:10,062 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,062 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:20:10,062 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-03-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,063 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-03-15 00:00:00
2025-05-21 05:20:10,065 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
447 2018-03-15          286      46096.4  135.180059             174               286               2018-03-15  32494.021429         1.418612           0.804803                                1.0                       0.609605    2018-03-15
2025-05-21 05:20:10,066 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}]
2025-05-21 05:20:10,066 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,066 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}}]
2025-05-21 05:20:10,066 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.6096, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:20:10,067 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:20:10,067 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-03-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:20:10,068 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-03-15 00:00:00
2025-05-21 05:20:10,070 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
447 2018-03-15          286      46096.4  135.180059             174               286               2018-03-15  32494.021429         1.418612           0.804803                                1.0                       0.609605    2018-03-15
2025-05-21 05:20:10,070 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-03-15 00:00:00", "current_value": 46096.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42400.39428571429, "deviation_in_std": 10.441527157312704, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46096.40) отклоняется от базовой линии (3696.01) на 42400.39, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:20:10,070 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:20:10,070 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.609605020859105, "explanation": {"detector_specific_info": {"date": "2018-03-15 00:00:00", "current_value": 46096.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42400.39428571429, "deviation_in_std": 10.441527157312704, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46096.40) отклоняется от базовой линии (3696.01) на 42400.39, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:20:10,072 - backend.ml_service.multilevel_detector - INFO - Сгенерированы объяснения для 13 из 13 аномалий
2025-05-21 05:20:10,073 - backend.ml_service.multilevel_detector - INFO - Многоуровневая детекция завершена. Обнаружено 13 аномалий.
2025-05-21 05:20:10,087 - backend.ml_service.multilevel_service - INFO - Обнаружено 13 multilevel аномалий до сохранения.
2025-05-21 05:20:10,087 - backend.ml_service.multilevel_service - INFO - Начало сохранения multilevel аномалий в БД...
2025-05-21 05:20:10,149 - backend.ml_service.multilevel_service - INFO - Статистика сохранения multilevel аномалий: {'total_detected_anomalies_before_save': 13, 'newly_saved_anomalies_count': 12, 'newly_saved_anomaly_ids': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], 'skipped_duplicates_count': 1, 'errors_on_save': 0}
2025-05-21 05:20:10,149 - backend.ml_service.multilevel_service - DEBUG - Сессия БД (db_for_crud) для multilevel detect закрыта.
2025-05-21 05:20:10,149 - backend.ml_service.multilevel_service - DEBUG - Сессия БД (db_for_load_detect) для multilevel detect закрыта.
2025-05-21 05:20:10,172 - backend.ml_service.multilevel_service - INFO - [TaskID: 0647c553-56e9-4bea-a447-7ff120d02259] Детекция и сохранение аномалий успешно завершены.
2025-05-21 05:26:14,316 - backend.ml_service - INFO - Логирование настроено с уровнем DEBUG
2025-05-21 05:26:14,317 - backend.ml_service - INFO - Логи записываются в файл: C:\Users\alex\Desktop\AnomaLens3.0\logs\ml_service_2025-05-21.log
2025-05-21 05:26:16,906 - backend.ml_service.multilevel_service - INFO - Базовый путь для моделей (MultilevelService): C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models
2025-05-21 05:26:16,906 - backend.ml_service.multilevel_service - INFO - Создание/инициализация многоуровневой системы на основе настроек из config.yaml.
2025-05-21 05:26:16,907 - backend.ml_service.multilevel_service - DEBUG - Используется следующая конфигурация для MultilevelAnomalyDetector: {
  "transaction_level": [
    {
      "type": "transaction_vae",
      "model_filename": "ml_trans_vae_model.joblib",
      "weight": 1.0,
      "features": [
        "price",
        "freight_value",
        "product_weight_g",
        "freight_to_price_ratio"
      ],
      "encoding_dim": 10,
      "hidden_dim1": 32,
      "hidden_dim2": 16,
      "epochs": 25,
      "kld_weight": 0.5,
      "dropout_rate": 0.1,
      "shap_background_samples": 50
    },
    {
      "type": "category_price_outlier",
      "model_filename": "ml_category_price_model.joblib",
      "weight": 1.0,
      "category_col": "product_category_name",
      "price_col": "price",
      "threshold": 2.8,
      "min_samples_per_category": 10
    }
  ],
  "behavior_level": [
    {
      "type": "graph",
      "model_filename": "ml_graph_model_v3.joblib",
      "weight": 1.0,
      "use_seller_state_spread": true,
      "use_category_diversity": true,
      "use_seller_degree": true,
      "seller_state_weight": 0.3,
      "category_diversity_weight": 0.4,
      "seller_degree_weight": 0.3
    },
    {
      "type": "seller_pricing_behavior",
      "model_filename": "ml_seller_pricing_model.joblib",
      "weight": 1.0,
      "volatility_threshold": 0.5,
      "range_threshold": 5.0,
      "freight_ratio_threshold": 1.0,
      "min_transactions": 5
    }
  ],
  "time_series_level": [
    {
      "type": "seasonal_deviation",
      "model_filename": "seasonal_deviation_model.joblib",
      "weight": 1.0,
      "window_size": 7,
      "threshold": 2.5
    },
    {
      "type": "cumulative_sum",
      "model_filename": "cumulative_sum_model.joblib",
      "weight": 1.0,
      "window_size": 14,
      "threshold": 2.5,
      "drift_threshold": 4.5
    }
  ],
  "combination_weights": {
    "transaction": 0.4,
    "behavior": 0.3,
    "time_series": 0.3
  },
  "transaction_level_combination_method": "weighted_average",
  "behavior_level_combination_method": "weighted_average",
  "time_series_level_combination_method": "average"
}
2025-05-21 05:26:16,907 - backend.ml_service.multilevel_detector - INFO - Инициализация многоуровневой системы обнаружения аномалий...
2025-05-21 05:26:16,907 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'transaction'...
2025-05-21 05:26:16,908 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) VAEDetector инициализирован. Устройство: cpu, Входная размерность: 4, Признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio']
2025-05-21 05:26:16,908 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Сброс базового состояния детектора (из AnomalyDetector._reset_state).
2025-05-21 05:26:16,908 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Специфичное состояние VAEDetector (порог, SHAP) сброшено.
2025-05-21 05:26:16,908 - backend.ml_service.transaction_detectors - INFO - (transaction_vae_price) TransactionVAEDetector инициализирован. Конфигурационные признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], Реально используемые признаки (с генерируемыми): ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], encoding_dim(latent_dim): 10, hidden_dim1(hidden_dim): 32, hidden_dim2: 16, epochs: 25, batch_size: 64, lr: 0.001, kld_w: 0.5, dropout: 0.1
2025-05-21 05:26:16,908 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора transaction_vae_price типа transaction_vae
2025-05-21 05:26:16,909 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_trans_vae_model.joblib' установлен для transaction_vae_price
2025-05-21 05:26:16,909 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib'
2025-05-21 05:26:16,909 - backend.ml_service.detector - INFO - Попытка загрузки модели transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib...
2025-05-21 05:26:16,920 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Загружен порог аномальности: 3.656726
2025-05-21 05:26:16,920 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler успешно инициализирован с параметрами: n_features_in_=4, mean_=(4,), scale_=(4,)
2025-05-21 05:26:16,920 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Фоновые данные SHAP загружены (torch.Size([50, 4]))
2025-05-21 05:26:16,923 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Модель VAE успешно загружена и перемещена на cpu.
2025-05-21 05:26:16,923 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Попытка пересоздания SHAP GradientExplainer после загрузки...
2025-05-21 05:26:16,926 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно ПЕРЕСОЗДАН при загрузке модели. Device=cpu, background_data.shape=torch.Size([50, 4])
2025-05-21 05:26:16,927 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Статус SHAP после загрузки: background_data shape=torch.Size([50, 4]), device=cpu, explainer=создан
2025-05-21 05:26:16,927 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детектор VAE (is_trained=True) успешно загружен.
2025-05-21 05:26:16,927 - backend.ml_service.detector - INFO - Модель transaction_vae_price успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib. is_trained=True
2025-05-21 05:26:16,928 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib
2025-05-21 05:26:16,928 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib.
2025-05-21 05:26:16,928 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) инициализирован с весом 1.0.
2025-05-21 05:26:16,928 - backend.ml_service.transaction_detectors - INFO - CategoryPriceOutlierDetector 'category_price_outlier_model' инициализирован с параметрами: category_col='product_category_name', price_col='price', threshold=2.8, min_samples_per_category=10
2025-05-21 05:26:16,928 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора category_price_outlier_model типа category_price_outlier
2025-05-21 05:26:16,928 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_category_price_model.joblib' установлен для category_price_outlier_model
2025-05-21 05:26:16,929 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib'
2025-05-21 05:26:16,929 - backend.ml_service.detector - INFO - Попытка загрузки модели category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib...
2025-05-21 05:26:16,930 - backend.ml_service.detector - INFO - Модель category_price_outlier_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib. is_trained=True
2025-05-21 05:26:16,931 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib
2025-05-21 05:26:16,931 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib.
2025-05-21 05:26:16,931 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) инициализирован с весом 1.0.
2025-05-21 05:26:16,931 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'behavior'...
2025-05-21 05:26:16,932 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора graph_graph_analysis типа graph
2025-05-21 05:26:16,932 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_graph_model_v3.joblib' установлен для graph_graph_analysis
2025-05-21 05:26:16,932 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib'
2025-05-21 05:26:16,932 - backend.ml_service.detector - INFO - Попытка загрузки модели graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib...
2025-05-21 05:26:16,933 - backend.ml_service.detector - INFO - Модель graph_graph_analysis успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib. is_trained=True
2025-05-21 05:26:16,933 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib
2025-05-21 05:26:16,933 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib.
2025-05-21 05:26:16,933 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) инициализирован с весом 1.0.
2025-05-21 05:26:16,933 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seller_pricing_behavior_model типа seller_pricing_behavior
2025-05-21 05:26:16,934 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_seller_pricing_model.joblib' установлен для seller_pricing_behavior_model
2025-05-21 05:26:16,934 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib'
2025-05-21 05:26:16,934 - backend.ml_service.detector - INFO - Попытка загрузки модели seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib...
2025-05-21 05:26:16,935 - backend.ml_service.detector - INFO - Модель seller_pricing_behavior_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib. is_trained=True
2025-05-21 05:26:16,935 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib
2025-05-21 05:26:16,935 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib.
2025-05-21 05:26:16,935 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) инициализирован с весом 1.0.
2025-05-21 05:26:16,935 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'time_series'...
2025-05-21 05:26:16,935 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seasonal_deviation_model типа seasonal_deviation
2025-05-21 05:26:16,936 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='seasonal_deviation_model.joblib' установлен для seasonal_deviation_model
2025-05-21 05:26:16,936 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib'
2025-05-21 05:26:16,936 - backend.ml_service.detector - INFO - Попытка загрузки модели seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib...
2025-05-21 05:26:16,937 - backend.ml_service.detector - INFO - Модель seasonal_deviation_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib. is_trained=True
2025-05-21 05:26:16,937 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib
2025-05-21 05:26:16,937 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib.
2025-05-21 05:26:16,937 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) инициализирован с весом 1.0.
2025-05-21 05:26:16,938 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора cumulative_sum_model типа cumulative_sum
2025-05-21 05:26:16,938 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='cumulative_sum_model.joblib' установлен для cumulative_sum_model
2025-05-21 05:26:16,938 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib'
2025-05-21 05:26:16,938 - backend.ml_service.detector - INFO - Попытка загрузки модели cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib...
2025-05-21 05:26:16,939 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Загружены baseline_mean=3696.0057142857145, baseline_std=4060.74644512314 из model_state.
2025-05-21 05:26:16,939 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Детектор CUSUM успешно загружен и помечен как обученный.
2025-05-21 05:26:16,939 - backend.ml_service.detector - INFO - Модель cumulative_sum_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib. is_trained=True
2025-05-21 05:26:16,940 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib
2025-05-21 05:26:16,940 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib.
2025-05-21 05:26:16,940 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) инициализирован с весом 1.0.
2025-05-21 05:26:16,940 - backend.ml_service.multilevel_detector - INFO - Многоуровневая система инициализирована: 2 транзакционных детекторов (метод: weighted_average), 2 поведенческих детекторов (метод: weighted_average), 2 детекторов временных рядов (метод: average)
2025-05-21 05:26:16,940 - backend.ml_service.multilevel_service - INFO - Многоуровневая система успешно создана на основе конфигурации из settings.yaml.
2025-05-21 05:26:16,949 - backend.ml_service - INFO - ML Service Logger активен. Уровень: DEBUG. Директория логов ml_service: C:\Users\alex\Desktop\AnomaLens3.0\logs
2025-05-21 05:26:29,762 - backend.ml_service - INFO - Логирование настроено с уровнем DEBUG
2025-05-21 05:26:29,763 - backend.ml_service - INFO - Логи записываются в файл: C:\Users\alex\Desktop\AnomaLens3.0\logs\ml_service_2025-05-21.log
2025-05-21 05:26:32,741 - backend.ml_service.multilevel_service - INFO - Базовый путь для моделей (MultilevelService): C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models
2025-05-21 05:26:32,741 - backend.ml_service.multilevel_service - INFO - Создание/инициализация многоуровневой системы на основе настроек из config.yaml.
2025-05-21 05:26:32,741 - backend.ml_service.multilevel_service - DEBUG - Используется следующая конфигурация для MultilevelAnomalyDetector: {
  "transaction_level": [
    {
      "type": "transaction_vae",
      "model_filename": "ml_trans_vae_model.joblib",
      "weight": 1.0,
      "features": [
        "price",
        "freight_value",
        "product_weight_g",
        "freight_to_price_ratio"
      ],
      "encoding_dim": 10,
      "hidden_dim1": 32,
      "hidden_dim2": 16,
      "epochs": 25,
      "kld_weight": 0.5,
      "dropout_rate": 0.1,
      "shap_background_samples": 50
    },
    {
      "type": "category_price_outlier",
      "model_filename": "ml_category_price_model.joblib",
      "weight": 1.0,
      "category_col": "product_category_name",
      "price_col": "price",
      "threshold": 2.8,
      "min_samples_per_category": 10
    }
  ],
  "behavior_level": [
    {
      "type": "graph",
      "model_filename": "ml_graph_model_v3.joblib",
      "weight": 1.0,
      "use_seller_state_spread": true,
      "use_category_diversity": true,
      "use_seller_degree": true,
      "seller_state_weight": 0.3,
      "category_diversity_weight": 0.4,
      "seller_degree_weight": 0.3
    },
    {
      "type": "seller_pricing_behavior",
      "model_filename": "ml_seller_pricing_model.joblib",
      "weight": 1.0,
      "volatility_threshold": 0.5,
      "range_threshold": 5.0,
      "freight_ratio_threshold": 1.0,
      "min_transactions": 5
    }
  ],
  "time_series_level": [
    {
      "type": "seasonal_deviation",
      "model_filename": "seasonal_deviation_model.joblib",
      "weight": 1.0,
      "window_size": 7,
      "threshold": 2.5
    },
    {
      "type": "cumulative_sum",
      "model_filename": "cumulative_sum_model.joblib",
      "weight": 1.0,
      "window_size": 14,
      "threshold": 2.5,
      "drift_threshold": 4.5
    }
  ],
  "combination_weights": {
    "transaction": 0.4,
    "behavior": 0.3,
    "time_series": 0.3
  },
  "transaction_level_combination_method": "weighted_average",
  "behavior_level_combination_method": "weighted_average",
  "time_series_level_combination_method": "average"
}
2025-05-21 05:26:32,742 - backend.ml_service.multilevel_detector - INFO - Инициализация многоуровневой системы обнаружения аномалий...
2025-05-21 05:26:32,742 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'transaction'...
2025-05-21 05:26:32,742 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) VAEDetector инициализирован. Устройство: cpu, Входная размерность: 4, Признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio']
2025-05-21 05:26:32,742 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Сброс базового состояния детектора (из AnomalyDetector._reset_state).
2025-05-21 05:26:32,742 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Специфичное состояние VAEDetector (порог, SHAP) сброшено.
2025-05-21 05:26:32,743 - backend.ml_service.transaction_detectors - INFO - (transaction_vae_price) TransactionVAEDetector инициализирован. Конфигурационные признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], Реально используемые признаки (с генерируемыми): ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], encoding_dim(latent_dim): 10, hidden_dim1(hidden_dim): 32, hidden_dim2: 16, epochs: 25, batch_size: 64, lr: 0.001, kld_w: 0.5, dropout: 0.1
2025-05-21 05:26:32,743 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора transaction_vae_price типа transaction_vae
2025-05-21 05:26:32,743 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_trans_vae_model.joblib' установлен для transaction_vae_price
2025-05-21 05:26:32,743 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib'
2025-05-21 05:26:32,743 - backend.ml_service.detector - INFO - Попытка загрузки модели transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib...
2025-05-21 05:26:32,754 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Загружен порог аномальности: 3.656726
2025-05-21 05:26:32,755 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler успешно инициализирован с параметрами: n_features_in_=4, mean_=(4,), scale_=(4,)
2025-05-21 05:26:32,755 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Фоновые данные SHAP загружены (torch.Size([50, 4]))
2025-05-21 05:26:32,757 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Модель VAE успешно загружена и перемещена на cpu.
2025-05-21 05:26:32,757 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Попытка пересоздания SHAP GradientExplainer после загрузки...
2025-05-21 05:26:32,761 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно ПЕРЕСОЗДАН при загрузке модели. Device=cpu, background_data.shape=torch.Size([50, 4])
2025-05-21 05:26:32,762 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Статус SHAP после загрузки: background_data shape=torch.Size([50, 4]), device=cpu, explainer=создан
2025-05-21 05:26:32,762 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детектор VAE (is_trained=True) успешно загружен.
2025-05-21 05:26:32,762 - backend.ml_service.detector - INFO - Модель transaction_vae_price успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib. is_trained=True
2025-05-21 05:26:32,763 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib
2025-05-21 05:26:32,763 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib.
2025-05-21 05:26:32,763 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) инициализирован с весом 1.0.
2025-05-21 05:26:32,763 - backend.ml_service.transaction_detectors - INFO - CategoryPriceOutlierDetector 'category_price_outlier_model' инициализирован с параметрами: category_col='product_category_name', price_col='price', threshold=2.8, min_samples_per_category=10
2025-05-21 05:26:32,763 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора category_price_outlier_model типа category_price_outlier
2025-05-21 05:26:32,764 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_category_price_model.joblib' установлен для category_price_outlier_model
2025-05-21 05:26:32,764 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib'
2025-05-21 05:26:32,764 - backend.ml_service.detector - INFO - Попытка загрузки модели category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib...
2025-05-21 05:26:32,766 - backend.ml_service.detector - INFO - Модель category_price_outlier_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib. is_trained=True
2025-05-21 05:26:32,766 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib
2025-05-21 05:26:32,766 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib.
2025-05-21 05:26:32,766 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) инициализирован с весом 1.0.
2025-05-21 05:26:32,766 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'behavior'...
2025-05-21 05:26:32,766 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора graph_graph_analysis типа graph
2025-05-21 05:26:32,766 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_graph_model_v3.joblib' установлен для graph_graph_analysis
2025-05-21 05:26:32,767 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib'
2025-05-21 05:26:32,767 - backend.ml_service.detector - INFO - Попытка загрузки модели graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib...
2025-05-21 05:26:32,767 - backend.ml_service.detector - INFO - Модель graph_graph_analysis успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib. is_trained=True
2025-05-21 05:26:32,767 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib
2025-05-21 05:26:32,767 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib.
2025-05-21 05:26:32,768 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) инициализирован с весом 1.0.
2025-05-21 05:26:32,768 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seller_pricing_behavior_model типа seller_pricing_behavior
2025-05-21 05:26:32,768 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_seller_pricing_model.joblib' установлен для seller_pricing_behavior_model
2025-05-21 05:26:32,768 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib'
2025-05-21 05:26:32,768 - backend.ml_service.detector - INFO - Попытка загрузки модели seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib...
2025-05-21 05:26:32,769 - backend.ml_service.detector - INFO - Модель seller_pricing_behavior_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib. is_trained=True
2025-05-21 05:26:32,769 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib
2025-05-21 05:26:32,769 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib.
2025-05-21 05:26:32,769 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) инициализирован с весом 1.0.
2025-05-21 05:26:32,770 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'time_series'...
2025-05-21 05:26:32,770 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seasonal_deviation_model типа seasonal_deviation
2025-05-21 05:26:32,770 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='seasonal_deviation_model.joblib' установлен для seasonal_deviation_model
2025-05-21 05:26:32,770 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib'
2025-05-21 05:26:32,770 - backend.ml_service.detector - INFO - Попытка загрузки модели seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib...
2025-05-21 05:26:32,771 - backend.ml_service.detector - INFO - Модель seasonal_deviation_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib. is_trained=True
2025-05-21 05:26:32,771 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib
2025-05-21 05:26:32,771 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib.
2025-05-21 05:26:32,771 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) инициализирован с весом 1.0.
2025-05-21 05:26:32,771 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора cumulative_sum_model типа cumulative_sum
2025-05-21 05:26:32,772 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='cumulative_sum_model.joblib' установлен для cumulative_sum_model
2025-05-21 05:26:32,772 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib'
2025-05-21 05:26:32,772 - backend.ml_service.detector - INFO - Попытка загрузки модели cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib...
2025-05-21 05:26:32,772 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Загружены baseline_mean=3696.0057142857145, baseline_std=4060.74644512314 из model_state.
2025-05-21 05:26:32,773 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Детектор CUSUM успешно загружен и помечен как обученный.
2025-05-21 05:26:32,773 - backend.ml_service.detector - INFO - Модель cumulative_sum_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib. is_trained=True
2025-05-21 05:26:32,773 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib
2025-05-21 05:26:32,773 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib.
2025-05-21 05:26:32,774 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) инициализирован с весом 1.0.
2025-05-21 05:26:32,774 - backend.ml_service.multilevel_detector - INFO - Многоуровневая система инициализирована: 2 транзакционных детекторов (метод: weighted_average), 2 поведенческих детекторов (метод: weighted_average), 2 детекторов временных рядов (метод: average)
2025-05-21 05:26:32,774 - backend.ml_service.multilevel_service - INFO - Многоуровневая система успешно создана на основе конфигурации из settings.yaml.
2025-05-21 05:26:32,783 - backend.ml_service - INFO - ML Service Logger активен. Уровень: DEBUG. Директория логов ml_service: C:\Users\alex\Desktop\AnomaLens3.0\logs
2025-05-21 05:29:40,775 - backend.ml_service - INFO - Логирование настроено с уровнем DEBUG
2025-05-21 05:29:40,775 - backend.ml_service - INFO - Логи записываются в файл: C:\Users\alex\Desktop\AnomaLens3.0\logs\ml_service_2025-05-21.log
2025-05-21 05:29:43,417 - backend.ml_service.multilevel_service - INFO - Базовый путь для моделей (MultilevelService): C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models
2025-05-21 05:29:43,417 - backend.ml_service.multilevel_service - INFO - Создание/инициализация многоуровневой системы на основе настроек из config.yaml.
2025-05-21 05:29:43,417 - backend.ml_service.multilevel_service - DEBUG - Используется следующая конфигурация для MultilevelAnomalyDetector: {
  "transaction_level": [
    {
      "type": "transaction_vae",
      "model_filename": "ml_trans_vae_model.joblib",
      "weight": 1.0,
      "features": [
        "price",
        "freight_value",
        "product_weight_g",
        "freight_to_price_ratio"
      ],
      "encoding_dim": 10,
      "hidden_dim1": 32,
      "hidden_dim2": 16,
      "epochs": 25,
      "kld_weight": 0.5,
      "dropout_rate": 0.1,
      "shap_background_samples": 50
    },
    {
      "type": "category_price_outlier",
      "model_filename": "ml_category_price_model.joblib",
      "weight": 1.0,
      "category_col": "product_category_name",
      "price_col": "price",
      "threshold": 2.8,
      "min_samples_per_category": 10
    }
  ],
  "behavior_level": [
    {
      "type": "graph",
      "model_filename": "ml_graph_model_v3.joblib",
      "weight": 1.0,
      "use_seller_state_spread": true,
      "use_category_diversity": true,
      "use_seller_degree": true,
      "seller_state_weight": 0.3,
      "category_diversity_weight": 0.4,
      "seller_degree_weight": 0.3
    },
    {
      "type": "seller_pricing_behavior",
      "model_filename": "ml_seller_pricing_model.joblib",
      "weight": 1.0,
      "volatility_threshold": 0.5,
      "range_threshold": 5.0,
      "freight_ratio_threshold": 1.0,
      "min_transactions": 5
    }
  ],
  "time_series_level": [
    {
      "type": "seasonal_deviation",
      "model_filename": "seasonal_deviation_model.joblib",
      "weight": 1.0,
      "window_size": 7,
      "threshold": 2.5
    },
    {
      "type": "cumulative_sum",
      "model_filename": "cumulative_sum_model.joblib",
      "weight": 1.0,
      "window_size": 14,
      "threshold": 2.5,
      "drift_threshold": 4.5
    }
  ],
  "combination_weights": {
    "transaction": 0.4,
    "behavior": 0.3,
    "time_series": 0.3
  },
  "transaction_level_combination_method": "weighted_average",
  "behavior_level_combination_method": "weighted_average",
  "time_series_level_combination_method": "average"
}
2025-05-21 05:29:43,418 - backend.ml_service.multilevel_detector - INFO - Инициализация многоуровневой системы обнаружения аномалий...
2025-05-21 05:29:43,418 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'transaction'...
2025-05-21 05:29:43,418 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) VAEDetector инициализирован. Устройство: cpu, Входная размерность: 4, Признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio']
2025-05-21 05:29:43,418 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Сброс базового состояния детектора (из AnomalyDetector._reset_state).
2025-05-21 05:29:43,419 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Специфичное состояние VAEDetector (порог, SHAP) сброшено.
2025-05-21 05:29:43,419 - backend.ml_service.transaction_detectors - INFO - (transaction_vae_price) TransactionVAEDetector инициализирован. Конфигурационные признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], Реально используемые признаки (с генерируемыми): ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], encoding_dim(latent_dim): 10, hidden_dim1(hidden_dim): 32, hidden_dim2: 16, epochs: 25, batch_size: 64, lr: 0.001, kld_w: 0.5, dropout: 0.1
2025-05-21 05:29:43,419 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора transaction_vae_price типа transaction_vae
2025-05-21 05:29:43,419 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_trans_vae_model.joblib' установлен для transaction_vae_price
2025-05-21 05:29:43,419 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib'
2025-05-21 05:29:43,419 - backend.ml_service.detector - INFO - Попытка загрузки модели transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib...
2025-05-21 05:29:43,429 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Загружен порог аномальности: 3.656726
2025-05-21 05:29:43,429 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler успешно инициализирован с параметрами: n_features_in_=4, mean_=(4,), scale_=(4,)
2025-05-21 05:29:43,429 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Фоновые данные SHAP загружены (torch.Size([50, 4]))
2025-05-21 05:29:43,433 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Модель VAE успешно загружена и перемещена на cpu.
2025-05-21 05:29:43,433 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Попытка пересоздания SHAP GradientExplainer после загрузки...
2025-05-21 05:29:43,437 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно ПЕРЕСОЗДАН при загрузке модели. Device=cpu, background_data.shape=torch.Size([50, 4])
2025-05-21 05:29:43,438 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Статус SHAP после загрузки: background_data shape=torch.Size([50, 4]), device=cpu, explainer=создан
2025-05-21 05:29:43,438 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детектор VAE (is_trained=True) успешно загружен.
2025-05-21 05:29:43,438 - backend.ml_service.detector - INFO - Модель transaction_vae_price успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib. is_trained=True
2025-05-21 05:29:43,439 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib
2025-05-21 05:29:43,439 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib.
2025-05-21 05:29:43,439 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) инициализирован с весом 1.0.
2025-05-21 05:29:43,439 - backend.ml_service.transaction_detectors - INFO - CategoryPriceOutlierDetector 'category_price_outlier_model' инициализирован с параметрами: category_col='product_category_name', price_col='price', threshold=2.8, min_samples_per_category=10
2025-05-21 05:29:43,440 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора category_price_outlier_model типа category_price_outlier
2025-05-21 05:29:43,440 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_category_price_model.joblib' установлен для category_price_outlier_model
2025-05-21 05:29:43,440 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib'
2025-05-21 05:29:43,440 - backend.ml_service.detector - INFO - Попытка загрузки модели category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib...
2025-05-21 05:29:43,442 - backend.ml_service.detector - INFO - Модель category_price_outlier_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib. is_trained=True
2025-05-21 05:29:43,442 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib
2025-05-21 05:29:43,442 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib.
2025-05-21 05:29:43,442 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) инициализирован с весом 1.0.
2025-05-21 05:29:43,443 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'behavior'...
2025-05-21 05:29:43,443 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора graph_graph_analysis типа graph
2025-05-21 05:29:43,443 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_graph_model_v3.joblib' установлен для graph_graph_analysis
2025-05-21 05:29:43,443 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib'
2025-05-21 05:29:43,444 - backend.ml_service.detector - INFO - Попытка загрузки модели graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib...
2025-05-21 05:29:43,444 - backend.ml_service.detector - INFO - Модель graph_graph_analysis успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib. is_trained=True
2025-05-21 05:29:43,444 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib
2025-05-21 05:29:43,444 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib.
2025-05-21 05:29:43,445 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) инициализирован с весом 1.0.
2025-05-21 05:29:43,445 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seller_pricing_behavior_model типа seller_pricing_behavior
2025-05-21 05:29:43,445 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_seller_pricing_model.joblib' установлен для seller_pricing_behavior_model
2025-05-21 05:29:43,445 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib'
2025-05-21 05:29:43,445 - backend.ml_service.detector - INFO - Попытка загрузки модели seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib...
2025-05-21 05:29:43,446 - backend.ml_service.detector - INFO - Модель seller_pricing_behavior_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib. is_trained=True
2025-05-21 05:29:43,446 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib
2025-05-21 05:29:43,446 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib.
2025-05-21 05:29:43,446 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) инициализирован с весом 1.0.
2025-05-21 05:29:43,446 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'time_series'...
2025-05-21 05:29:43,447 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seasonal_deviation_model типа seasonal_deviation
2025-05-21 05:29:43,447 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='seasonal_deviation_model.joblib' установлен для seasonal_deviation_model
2025-05-21 05:29:43,447 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib'
2025-05-21 05:29:43,447 - backend.ml_service.detector - INFO - Попытка загрузки модели seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib...
2025-05-21 05:29:43,448 - backend.ml_service.detector - INFO - Модель seasonal_deviation_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib. is_trained=True
2025-05-21 05:29:43,448 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib
2025-05-21 05:29:43,448 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib.
2025-05-21 05:29:43,448 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) инициализирован с весом 1.0.
2025-05-21 05:29:43,449 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора cumulative_sum_model типа cumulative_sum
2025-05-21 05:29:43,449 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='cumulative_sum_model.joblib' установлен для cumulative_sum_model
2025-05-21 05:29:43,449 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib'
2025-05-21 05:29:43,449 - backend.ml_service.detector - INFO - Попытка загрузки модели cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib...
2025-05-21 05:29:43,449 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Загружены baseline_mean=3696.0057142857145, baseline_std=4060.74644512314 из model_state.
2025-05-21 05:29:43,450 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Детектор CUSUM успешно загружен и помечен как обученный.
2025-05-21 05:29:43,450 - backend.ml_service.detector - INFO - Модель cumulative_sum_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib. is_trained=True
2025-05-21 05:29:43,450 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib
2025-05-21 05:29:43,450 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib.
2025-05-21 05:29:43,450 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) инициализирован с весом 1.0.
2025-05-21 05:29:43,451 - backend.ml_service.multilevel_detector - INFO - Многоуровневая система инициализирована: 2 транзакционных детекторов (метод: weighted_average), 2 поведенческих детекторов (метод: weighted_average), 2 детекторов временных рядов (метод: average)
2025-05-21 05:29:43,451 - backend.ml_service.multilevel_service - INFO - Многоуровневая система успешно создана на основе конфигурации из settings.yaml.
2025-05-21 05:29:43,459 - backend.ml_service - INFO - ML Service Logger активен. Уровень: DEBUG. Директория логов ml_service: C:\Users\alex\Desktop\AnomaLens3.0\logs
2025-05-21 05:30:23,017 - backend.ml_service.multilevel_service - INFO - [TaskID: 21913a37-a520-4e8f-a8c4-abd4b8c14c57] Обертка detect_async_task_wrapper запущена.
2025-05-21 05:30:23,018 - backend.ml_service.multilevel_service - INFO - Начало обнаружения аномалий (multilevel) с сохранением в БД...
2025-05-21 05:30:23,019 - backend.ml_service.multilevel_service - INFO - Загрузка данных из БД для multilevel detect...
2025-05-21 05:30:23,020 - backend.ml_service.common - INFO - Загрузка данных из БД за период: 1998-01-03 05:30:23.016884 - None (с ассоциациями)
2025-05-21 05:30:26,802 - backend.ml_service.common - INFO - Загружено 118310 записей OrderItem.
2025-05-21 05:30:26,802 - backend.ml_service.multilevel_service - INFO - Данные для multilevel detect (118310 строк) подготовлены. Применение инженерии признаков...
2025-05-21 05:30:26,927 - backend.ml_service.common - INFO - Добавлен признак: 'price_deviation_from_category_mean'
2025-05-21 05:30:26,929 - backend.ml_service.common - INFO - Добавлен признак: 'freight_to_price_ratio'
2025-05-21 05:30:26,929 - backend.ml_service.multilevel_service - INFO - Инженерия признаков для детекции завершена.
2025-05-21 05:30:26,930 - backend.ml_service.multilevel_service - INFO - Запуск multilevel_detector.detect()...
2025-05-21 05:30:26,952 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: transaction...
2025-05-21 05:30:26,953 - backend.ml_service.multilevel_detector - INFO - Уровень 'transaction': Запуск детектора 'transaction_vae_price'...
2025-05-21 05:30:26,978 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Запуск детекции...
2025-05-21 05:30:27,240 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:30:27,240 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:30:27,240 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:30:27,241 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:30:27,241 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:30:28,320 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детекция завершена. Время: 1.34 сек.
2025-05-21 05:30:28,335 - backend.ml_service.multilevel_detector - INFO - Детектор 'transaction_vae_price' обработан. Распределение нормализованных скоров: Min=0.0000, Max=0.9779, Mean=0.0068
2025-05-21 05:30:28,336 - backend.ml_service.multilevel_detector - INFO - Уровень 'transaction': Запуск детектора 'category_price_outlier_model'...
2025-05-21 05:30:28,755 - backend.ml_service.transaction_detectors - INFO - Для 10 товаров с неизвестными категориями присвоен высокий скор аномальности.
2025-05-21 05:30:28,757 - backend.ml_service.transaction_detectors - INFO - Детектор category_price_outlier_model: обнаружено 2104 аномалий из 118310 транзакций
2025-05-21 05:30:28,780 - backend.ml_service.multilevel_detector - INFO - Детектор 'category_price_outlier_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0115
2025-05-21 05:30:28,793 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction): Матрица скоров (shape (2, 118310)), метод: weighted_average
2025-05-21 05:30:28,798 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction, метод: weighted_average): Используемые веса: {'transaction_vae_price': 1.0, 'category_price_outlier_model': 1.0}, массив весов: [1. 1.]
2025-05-21 05:30:28,799 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction, метод: weighted_average): Распределение combined_scores: Min=0.0000, Max=0.9579, Mean=0.0092
2025-05-21 05:30:28,824 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'transaction' завершен. Добавлен столбец 'transaction_score' и индивидуальные скоры детекторов.
2025-05-21 05:30:28,826 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: behavior...
2025-05-21 05:30:28,941 - backend.ml_service.multilevel_detector - INFO - Детектор 'graph_graph_analysis' типа GraphAnomalyDetector получит оригинальные данные, а не агрегированные
2025-05-21 05:30:28,942 - backend.ml_service.multilevel_detector - INFO - Уровень 'behavior': Запуск детектора 'graph_graph_analysis'...
2025-05-21 05:30:28,966 - backend.ml_service.graph_detector - INFO - Построение графа...
2025-05-21 05:30:33,124 - backend.ml_service.graph_detector - INFO - Граф построен за 4.07 сек. Узлов: 346028, Ребер: 436616
2025-05-21 05:30:33,225 - backend.ml_service.graph_detector - INFO - Расчет графовых аномальных скоров для 112650 узлов OrderItem...
2025-05-21 05:30:35,108 - backend.ml_service.graph_detector - INFO - Детектор graph_graph_analysis: обнаружено 0 аномалий из 118310 (112650 обработано графом)
2025-05-21 05:30:35,170 - backend.ml_service.multilevel_detector - INFO - Детектор 'graph_graph_analysis' обработан. Распределение нормализованных скоров: Min=0.0000, Max=0.6667, Mean=0.1571
2025-05-21 05:30:35,171 - backend.ml_service.multilevel_detector - INFO - Уровень 'behavior': Запуск детектора 'seller_pricing_behavior_model'...
2025-05-21 05:30:35,173 - backend.ml_service.behavior_detectors - INFO - Детектор seller_pricing_behavior_model: обнаружено 389 аномалий из 3095 продавцов
2025-05-21 05:30:35,187 - backend.ml_service.multilevel_detector - INFO - Детектор 'seller_pricing_behavior_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0644
2025-05-21 05:30:35,188 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior): Матрица скоров (shape (2, 3095)), метод: weighted_average
2025-05-21 05:30:35,189 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior, метод: weighted_average): Используемые веса: {'graph_graph_analysis': 1.0, 'seller_pricing_behavior_model': 1.0}, массив весов: [1. 1.]
2025-05-21 05:30:35,189 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior, метод: weighted_average): Распределение combined_scores: Min=0.0000, Max=0.5785, Mean=0.1108
2025-05-21 05:30:35,190 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'behavior' завершен. Добавлен столбец 'behavior_score' и индивидуальные скоры детекторов.
2025-05-21 05:30:35,361 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: time_series...
2025-05-21 05:30:35,451 - backend.ml_service.multilevel_detector - INFO - Уровень 'time_series': Запуск детектора 'seasonal_deviation_model'...
2025-05-21 05:30:35,454 - backend.ml_service.time_series_detectors - INFO - Детектор seasonal_deviation_model: обнаружено 160 аномалий из 616 временных точек
2025-05-21 05:30:35,455 - backend.ml_service.multilevel_detector - INFO - Детектор 'seasonal_deviation_model' обработан. Распределение нормализованных скоров: Min=0.0012, Max=1.0000, Mean=0.6384
2025-05-21 05:30:35,455 - backend.ml_service.multilevel_detector - INFO - Уровень 'time_series': Запуск детектора 'cumulative_sum_model'...
2025-05-21 05:30:35,490 - backend.ml_service.time_series_detectors - INFO - Детектор cumulative_sum_model: обнаружено 614 аномалий из 616 временных точек
2025-05-21 05:30:35,490 - backend.ml_service.multilevel_detector - INFO - Детектор 'cumulative_sum_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.3781
2025-05-21 05:30:35,491 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: time_series): Матрица скоров (shape (2, 616)), метод: average
2025-05-21 05:30:35,491 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: time_series, метод: average): Распределение combined_scores: Min=0.0298, Max=1.0000, Mean=0.5082
2025-05-21 05:30:35,492 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'time_series' завершен. Добавлен столбец 'time_series_score' и индивидуальные скоры детекторов.
2025-05-21 05:30:35,521 - backend.ml_service.multilevel_detector - INFO - Слияние временных данных: result_df имеет 118310 строк, 616 уникальных дат
2025-05-21 05:30:35,522 - backend.ml_service.multilevel_detector - INFO - Слияние временных данных: ts_scores_to_merge имеет 616 строк, 616 уникальных дат
2025-05-21 05:30:35,597 - backend.ml_service.multilevel_detector - DEBUG - Распределение transaction_level_score: Min=0.0000, Max=0.9579, Mean=0.0092
2025-05-21 05:30:35,598 - backend.ml_service.multilevel_detector - DEBUG - Распределение behavior_level_score: Min=0.0000, Max=0.5785, Mean=0.1589
2025-05-21 05:30:35,599 - backend.ml_service.multilevel_detector - DEBUG - Распределение time_series_level_score: Min=0.0298, Max=1.0000, Mean=0.5518
2025-05-21 05:30:35,599 - backend.ml_service.multilevel_detector - INFO - Расчет итогового многоуровневого скора...
2025-05-21 05:30:35,601 - backend.ml_service.multilevel_detector - DEBUG - Распределение multilevel_score (перед порогом): Min=0.0115, Max=0.6031, Mean=0.2169
2025-05-21 05:30:35,603 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8307, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,603 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:30:35,603 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-29 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,604 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-29 00:00:00
2025-05-21 05:30:35,607 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
583 2018-07-29          188      32085.4  145.842727             150               188               2018-07-29  35787.032857         0.896565           0.879612                           0.830683                       0.928541    2018-07-29
2025-05-21 05:30:35,608 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}]
2025-05-21 05:30:35,608 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,608 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.8306826658975347, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}]
2025-05-21 05:30:35,608 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9285, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,609 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:30:35,609 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-29 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,610 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-29 00:00:00
2025-05-21 05:30:35,613 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
583 2018-07-29          188      32085.4  145.842727             150               188               2018-07-29  35787.032857         0.896565           0.879612                           0.830683                       0.928541    2018-07-29
2025-05-21 05:30:35,614 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-07-29 00:00:00", "current_value": 32085.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 28389.394285714287, "deviation_in_std": 6.991176294646339, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (32085.40) отклоняется от базовой линии (3696.01) на 28389.39, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:30:35,614 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,614 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.8306826658975347, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.928540895759355, "explanation": {"detector_specific_info": {"date": "2018-07-29 00:00:00", "current_value": 32085.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 28389.394285714287, "deviation_in_std": 6.991176294646339, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (32085.40) отклоняется от базовой линии (3696.01) на 28389.39, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:30:35,615 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,615 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:30:35,615 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,616 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-03 00:00:00
2025-05-21 05:30:35,617 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales  avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
588 2018-08-03          314     45036.63  125.10175             216               314               2018-08-03  39138.992857         1.150684           0.972436                                1.0                       0.944872    2018-08-03
2025-05-21 05:30:35,618 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:30:35,619 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,619 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:30:35,619 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9449, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,620 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:30:35,620 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,621 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-03 00:00:00
2025-05-21 05:30:35,623 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales  avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
588 2018-08-03          314     45036.63  125.10175             216               314               2018-08-03  39138.992857         1.150684           0.972436                                1.0                       0.944872    2018-08-03
2025-05-21 05:30:35,624 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-03 00:00:00", "current_value": 45036.63, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 41340.624285714286, "deviation_in_std": 10.18054804563417, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (45036.63) отклоняется от базовой линии (3696.01) на 41340.62, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:30:35,625 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,625 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9448723295452219, "explanation": {"detector_specific_info": {"date": "2018-08-03 00:00:00", "current_value": 45036.63, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 41340.624285714286, "deviation_in_std": 10.18054804563417, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (45036.63) отклоняется от базовой линии (3696.01) на 41340.62, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:30:35,626 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,627 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:30:35,627 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,628 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-03 00:00:00
2025-05-21 05:30:35,630 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
527 2018-06-03          191      31535.8  137.112174             149               191               2018-06-03  27063.432857         1.165255           0.903771                                1.0                       0.807541    2018-06-03
2025-05-21 05:30:35,630 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}]
2025-05-21 05:30:35,630 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,630 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}]
2025-05-21 05:30:35,631 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8075, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,631 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:30:35,631 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,632 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-03 00:00:00
2025-05-21 05:30:35,634 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
527 2018-06-03          191      31535.8  137.112174             149               191               2018-06-03  27063.432857         1.165255           0.903771                                1.0                       0.807541    2018-06-03
2025-05-21 05:30:35,634 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-03 00:00:00", "current_value": 31535.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 27839.794285714284, "deviation_in_std": 6.855831720089102, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (31535.80) отклоняется от базовой линии (3696.01) на 27839.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:30:35,635 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,635 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8075414451585549, "explanation": {"detector_specific_info": {"date": "2018-06-03 00:00:00", "current_value": 31535.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 27839.794285714284, "deviation_in_std": 6.855831720089102, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (31535.80) отклоняется от базовой линии (3696.01) на 27839.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:30:35,635 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 26323, order_id: 0812eb902a67711a1cb742b3cdaa65ae, level: transaction): Detector Column: 'trans_transaction_vae_price_score', Score: 0.9157, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,636 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'transaction_vae_price': TransactionVAEDetector
2025-05-21 05:30:35,643 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'transaction_vae_price':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id  product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
26323              1  0812eb902a67711a1cb742b3cdaa65ae  489ae2aa008f021502940f251d4cce7f  e3b4998c7a498169dc7bce44e6bb6277  6735.0         194.31      2017-02-12 20:37:36  c6e2731c5b391845f6800c97401a43a9  utilidades_domesticas                 31.0                       875.0                 2.0           30000.0               60.0               61.0              33.0                    housewares             MS           SP  credit_card                   8.0        6929.31           5.0                           74.309637                0.028851                 0.957853                    True                           0.915707                                       1.0              0.398596                False                           0.15721                                   0.639983                 0.189451                           0.367431                        0.01147                   False          0.559555        True                       None
2025-05-21 05:30:35,643 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Метод get_explanation_details не реализован специфично, будет использована реализация get_shap_explanations (если есть).
2025-05-21 05:30:35,645 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:30:35,645 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:30:35,645 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:30:35,645 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:30:35,645 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:30:35,646 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Вычисление SHAP values для 1 экземпляров...
2025-05-21 05:30:35,646 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Используется nsamples=50 для SHAP
2025-05-21 05:30:35,647 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Запрос SHAP объяснений: explainer=True, background_data_exists=True, model=True
2025-05-21 05:30:35,647 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Создание GradientExplainer с размерами данных: torch.Size([50, 4])
2025-05-21 05:30:35,669 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw type: <class 'numpy.ndarray'>
2025-05-21 05:30:35,670 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw (ndarray) shape: (1, 4, 1)
2025-05-21 05:30:35,670 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно создан и вычислены SHAP-значения
2025-05-21 05:30:35,670 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values_raw уже является ndarray, shape: (1, 4, 1)
2025-05-21 05:30:35,670 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Начальная форма shap_values_arr: (1, 4, 1), ndim: 3
2025-05-21 05:30:35,671 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values после squeeze(-1): (1, 4)
2025-05-21 05:30:35,671 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP values успешно вычислены для 1 экземпляров.
2025-05-21 05:30:35,671 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'transaction_vae_price': [{"shap_values": {"price": 40.85994819106234, "freight_value": -2.107644569098639, "product_weight_g": 2.9557363810801247, "freight_to_price_ratio": -0.4125569039227379}}]
2025-05-21 05:30:35,672 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'transaction_vae_price' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,672 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.9157066893670197, "explanation": {"shap_values": {"price": 40.85994819106234, "freight_value": -2.107644569098639, "product_weight_g": 2.9557363810801247, "freight_to_price_ratio": -0.4125569039227379}}}]
2025-05-21 05:30:35,672 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 26323, order_id: 0812eb902a67711a1cb742b3cdaa65ae, level: transaction): Detector Column: 'trans_category_price_outlier_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,672 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'category_price_outlier_model': CategoryPriceOutlierDetector
2025-05-21 05:30:35,678 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'category_price_outlier_model':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id  product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
26323              1  0812eb902a67711a1cb742b3cdaa65ae  489ae2aa008f021502940f251d4cce7f  e3b4998c7a498169dc7bce44e6bb6277  6735.0         194.31      2017-02-12 20:37:36  c6e2731c5b391845f6800c97401a43a9  utilidades_domesticas                 31.0                       875.0                 2.0           30000.0               60.0               61.0              33.0                    housewares             MS           SP  credit_card                   8.0        6929.31           5.0                           74.309637                0.028851                 0.957853                    True                           0.915707                                       1.0              0.398596                False                           0.15721                                   0.639983                 0.189451                           0.367431                        0.01147                   False          0.559555        True                       None
2025-05-21 05:30:35,680 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'category_price_outlier_model': [{"detector_specific_info": {"category": "utilidades_domesticas", "price": 6735.0, "category_mean_price": 90.63427371273713, "category_std_price": 140.19371115720259, "category_min_price": 3.06, "category_max_price": 6735.0, "category_count": 7380, "z_score": 47.394178179909765, "threshold": 2.8, "explanation": "Цена 6735.00 отличается от средней цены в категории 'utilidades_domesticas' (90.63) на 47.39 стандартных отклонений (порог: 2.8)."}}]
2025-05-21 05:30:35,680 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'category_price_outlier_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,680 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.9157066893670197, "explanation": {"shap_values": {"price": 40.85994819106234, "freight_value": -2.107644569098639, "product_weight_g": 2.9557363810801247, "freight_to_price_ratio": -0.4125569039227379}}}, {"detector_name": "category_price_outlier_model", "detector_type": "CategoryPriceOutlierDetector", "score": 1.0, "explanation": {"detector_specific_info": {"category": "utilidades_domesticas", "price": 6735.0, "category_mean_price": 90.63427371273713, "category_std_price": 140.19371115720259, "category_min_price": 3.06, "category_max_price": 6735.0, "category_count": 7380, "z_score": 47.394178179909765, "threshold": 2.8, "explanation": "Цена 6735.00 отличается от средней цены в категории 'utilidades_domesticas' (90.63) на 47.39 стандартных отклонений (порог: 2.8)."}}}]
2025-05-21 05:30:35,681 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,681 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:30:35,682 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-25 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,683 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-25 00:00:00
2025-05-21 05:30:35,686 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
579 2018-07-25          268     40753.19  122.750572             201               268               2018-07-25  35288.758571         1.154849           0.959618                                1.0                       0.919235    2018-07-25
2025-05-21 05:30:35,687 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:30:35,688 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,688 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:30:35,688 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9192, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,688 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:30:35,689 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-25 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,690 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-25 00:00:00
2025-05-21 05:30:35,693 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
579 2018-07-25          268     40753.19  122.750572             201               268               2018-07-25  35288.758571         1.154849           0.959618                                1.0                       0.919235    2018-07-25
2025-05-21 05:30:35,694 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-07-25 00:00:00", "current_value": 40753.19, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37057.18428571429, "deviation_in_std": 9.125707498979427, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (40753.19) отклоняется от базовой линии (3696.01) на 37057.18, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:30:35,694 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,695 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9192352183494302, "explanation": {"detector_specific_info": {"date": "2018-07-25 00:00:00", "current_value": 40753.19, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37057.18428571429, "deviation_in_std": 9.125707498979427, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (40753.19) отклоняется от базовой линии (3696.01) на 37057.18, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:30:35,695 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 42860, order_id: 90674f59a21207f91a7387785c66f340, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,695 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:30:35,696 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-14 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,698 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-14 00:00:00
2025-05-21 05:30:35,700 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
599 2018-08-14          315     44682.42  128.397759             228               315               2018-08-14  37562.228571         1.189557           0.989198                                1.0                       0.978396    2018-08-14
2025-05-21 05:30:35,701 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:30:35,701 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,702 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:30:35,702 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 42860, order_id: 90674f59a21207f91a7387785c66f340, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9784, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,702 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:30:35,703 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-14 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,704 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-14 00:00:00
2025-05-21 05:30:35,707 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
599 2018-08-14          315     44682.42  128.397759             228               315               2018-08-14  37562.228571         1.189557           0.989198                                1.0                       0.978396    2018-08-14
2025-05-21 05:30:35,708 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-14 00:00:00", "current_value": 44682.42, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 40986.41428571429, "deviation_in_std": 10.093320240405061, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (44682.42) отклоняется от базовой линии (3696.01) на 40986.41, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:30:35,708 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,709 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9783962277530719, "explanation": {"detector_specific_info": {"date": "2018-08-14 00:00:00", "current_value": 44682.42, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 40986.41428571429, "deviation_in_std": 10.093320240405061, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (44682.42) отклоняется от базовой линии (3696.01) на 40986.41, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:30:35,709 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.9281, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,710 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:30:35,710 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-04-27 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,712 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-04-27 00:00:00
2025-05-21 05:30:35,715 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
490 2018-04-27          242     41231.39  140.242823             165               242               2018-04-27  35298.295714         1.168084           0.823398                           0.928073                       0.718724    2018-04-27
2025-05-21 05:30:35,715 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:30:35,716 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,716 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9280726698190791, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:30:35,717 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.7187, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,717 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:30:35,718 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-04-27 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,719 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-04-27 00:00:00
2025-05-21 05:30:35,722 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
490 2018-04-27          242     41231.39  140.242823             165               242               2018-04-27  35298.295714         1.168084           0.823398                           0.928073                       0.718724    2018-04-27
2025-05-21 05:30:35,722 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-04-27 00:00:00", "current_value": 41231.39, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37535.38428571429, "deviation_in_std": 9.243469099331083, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (41231.39) отклоняется от базовой линии (3696.01) на 37535.38, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:30:35,723 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,723 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9280726698190791, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.718723936134046, "explanation": {"detector_specific_info": {"date": "2018-04-27 00:00:00", "current_value": 41231.39, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37535.38428571429, "deviation_in_std": 9.243469099331083, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (41231.39) отклоняется от базовой линии (3696.01) на 37535.38, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:30:35,724 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 74778, order_id: 94fca82966c05ba707f4e7dc0c50aa3c, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,724 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:30:35,725 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,726 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:30:35,728 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:30:35,729 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:30:35,730 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,730 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:30:35,730 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 74778, order_id: 94fca82966c05ba707f4e7dc0c50aa3c, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9819, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,731 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:30:35,731 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,733 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:30:35,735 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:30:35,736 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:30:35,736 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,737 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9819435388597458, "explanation": {"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:30:35,738 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 75482, order_id: 4160b6447ad70e6d73f7221dd970bbe9, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,738 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:30:35,739 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,740 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:30:35,742 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:30:35,743 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:30:35,743 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,744 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:30:35,744 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 75482, order_id: 4160b6447ad70e6d73f7221dd970bbe9, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9819, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,744 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:30:35,745 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,746 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:30:35,748 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:30:35,749 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:30:35,750 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,750 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9819435388597458, "explanation": {"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:30:35,751 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.9481, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,751 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:30:35,751 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-01-26 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,753 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-01-26 00:00:00
2025-05-21 05:30:35,756 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
399 2018-01-26          228     34533.35  125.575818             151               228               2018-01-26       31895.5         1.082703           0.722093                           0.948138                       0.496047    2018-01-26
2025-05-21 05:30:35,756 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:30:35,757 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,757 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9481383115297547, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:30:35,757 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.4960, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,758 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:30:35,758 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-01-26 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,759 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-01-26 00:00:00
2025-05-21 05:30:35,762 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
399 2018-01-26          228     34533.35  125.575818             151               228               2018-01-26       31895.5         1.082703           0.722093                           0.948138                       0.496047    2018-01-26
2025-05-21 05:30:35,762 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-01-26 00:00:00", "current_value": 34533.35, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 30837.344285714284, "deviation_in_std": 7.594008811544785, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34533.35) отклоняется от базовой линии (3696.01) на 30837.34, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:30:35,763 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,763 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9481383115297547, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.496047165599019, "explanation": {"detector_specific_info": {"date": "2018-01-26 00:00:00", "current_value": 34533.35, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 30837.344285714284, "deviation_in_std": 7.594008811544785, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34533.35) отклоняется от базовой линии (3696.01) на 30837.34, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:30:35,764 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87594, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8164, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,764 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:30:35,764 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,766 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:30:35,769 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:30:35,770 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:30:35,770 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,770 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:30:35,771 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87594, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8123, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,771 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:30:35,772 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,773 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:30:35,776 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:30:35,777 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:30:35,777 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,778 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8122690239748033, "explanation": {"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:30:35,778 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87595, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8164, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,778 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:30:35,779 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,781 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:30:35,784 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:30:35,786 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:30:35,786 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,787 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:30:35,787 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87595, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8123, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,788 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:30:35,788 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,789 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:30:35,793 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:30:35,794 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:30:35,795 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,795 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8122690239748033, "explanation": {"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:30:35,795 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,796 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:30:35,797 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-03-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,798 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-03-15 00:00:00
2025-05-21 05:30:35,801 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
447 2018-03-15          286      46096.4  135.180059             174               286               2018-03-15  32494.021429         1.418612           0.804803                                1.0                       0.609605    2018-03-15
2025-05-21 05:30:35,802 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}]
2025-05-21 05:30:35,803 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,804 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}}]
2025-05-21 05:30:35,804 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.6096, Threshold: 0.2, Passes Threshold: True
2025-05-21 05:30:35,805 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:30:35,805 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-03-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:30:35,806 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-03-15 00:00:00
2025-05-21 05:30:35,809 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
447 2018-03-15          286      46096.4  135.180059             174               286               2018-03-15  32494.021429         1.418612           0.804803                                1.0                       0.609605    2018-03-15
2025-05-21 05:30:35,810 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-03-15 00:00:00", "current_value": 46096.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42400.39428571429, "deviation_in_std": 10.441527157312704, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46096.40) отклоняется от базовой линии (3696.01) на 42400.39, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:30:35,811 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:30:35,811 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.609605020859105, "explanation": {"detector_specific_info": {"date": "2018-03-15 00:00:00", "current_value": 46096.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42400.39428571429, "deviation_in_std": 10.441527157312704, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46096.40) отклоняется от базовой линии (3696.01) на 42400.39, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:30:35,813 - backend.ml_service.multilevel_detector - INFO - Сгенерированы объяснения для 13 из 13 аномалий
2025-05-21 05:30:35,814 - backend.ml_service.multilevel_detector - INFO - Многоуровневая детекция завершена. Обнаружено 13 аномалий.
2025-05-21 05:30:35,833 - backend.ml_service.multilevel_service - INFO - Обнаружено 13 multilevel аномалий до сохранения.
2025-05-21 05:30:35,833 - backend.ml_service.multilevel_service - INFO - Начало сохранения multilevel аномалий в БД...
2025-05-21 05:30:35,903 - backend.ml_service.multilevel_service - INFO - Статистика сохранения multilevel аномалий: {'total_detected_anomalies_before_save': 13, 'newly_saved_anomalies_count': 12, 'newly_saved_anomaly_ids': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], 'skipped_duplicates_count': 1, 'errors_on_save': 0}
2025-05-21 05:30:35,904 - backend.ml_service.multilevel_service - DEBUG - Сессия БД (db_for_crud) для multilevel detect закрыта.
2025-05-21 05:30:35,904 - backend.ml_service.multilevel_service - DEBUG - Сессия БД (db_for_load_detect) для multilevel detect закрыта.
2025-05-21 05:30:35,928 - backend.ml_service.multilevel_service - INFO - [TaskID: 21913a37-a520-4e8f-a8c4-abd4b8c14c57] Детекция и сохранение аномалий успешно завершены.
2025-05-21 05:36:52,220 - backend.ml_service - INFO - Логирование настроено с уровнем DEBUG
2025-05-21 05:36:52,220 - backend.ml_service - INFO - Логи записываются в файл: C:\Users\alex\Desktop\AnomaLens3.0\logs\ml_service_2025-05-21.log
2025-05-21 05:36:54,811 - backend.ml_service.multilevel_service - INFO - Базовый путь для моделей (MultilevelService): C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models
2025-05-21 05:36:54,812 - backend.ml_service.multilevel_service - INFO - Создание/инициализация многоуровневой системы на основе настроек из config.yaml.
2025-05-21 05:36:54,812 - backend.ml_service.multilevel_service - DEBUG - Используется следующая конфигурация для MultilevelAnomalyDetector: {
  "transaction_level": [
    {
      "type": "transaction_vae",
      "model_filename": "ml_trans_vae_model.joblib",
      "weight": 1.0,
      "features": [
        "price",
        "freight_value",
        "product_weight_g",
        "freight_to_price_ratio"
      ],
      "encoding_dim": 10,
      "hidden_dim1": 32,
      "hidden_dim2": 16,
      "epochs": 25,
      "kld_weight": 0.5,
      "dropout_rate": 0.1,
      "shap_background_samples": 50
    },
    {
      "type": "category_price_outlier",
      "model_filename": "ml_category_price_model.joblib",
      "weight": 1.0,
      "category_col": "product_category_name",
      "price_col": "price",
      "threshold": 2.8,
      "min_samples_per_category": 10
    }
  ],
  "behavior_level": [
    {
      "type": "graph",
      "model_filename": "ml_graph_model_v3.joblib",
      "weight": 1.0,
      "use_seller_state_spread": true,
      "use_category_diversity": true,
      "use_seller_degree": true,
      "seller_state_weight": 0.3,
      "category_diversity_weight": 0.4,
      "seller_degree_weight": 0.3
    },
    {
      "type": "seller_pricing_behavior",
      "model_filename": "ml_seller_pricing_model.joblib",
      "weight": 1.0,
      "volatility_threshold": 0.5,
      "range_threshold": 5.0,
      "freight_ratio_threshold": 1.0,
      "min_transactions": 5
    }
  ],
  "time_series_level": [
    {
      "type": "seasonal_deviation",
      "model_filename": "seasonal_deviation_model.joblib",
      "weight": 1.0,
      "window_size": 7,
      "threshold": 2.5
    },
    {
      "type": "cumulative_sum",
      "model_filename": "cumulative_sum_model.joblib",
      "weight": 1.0,
      "window_size": 14,
      "threshold": 2.5,
      "drift_threshold": 4.5
    }
  ],
  "combination_weights": {
    "transaction": 0.4,
    "behavior": 0.3,
    "time_series": 0.3
  },
  "transaction_level_combination_method": "weighted_average",
  "behavior_level_combination_method": "weighted_average",
  "time_series_level_combination_method": "average"
}
2025-05-21 05:36:54,812 - backend.ml_service.multilevel_detector - INFO - Инициализация многоуровневой системы обнаружения аномалий...
2025-05-21 05:36:54,812 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'transaction'...
2025-05-21 05:36:54,813 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) VAEDetector инициализирован. Устройство: cpu, Входная размерность: 4, Признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio']
2025-05-21 05:36:54,813 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Сброс базового состояния детектора (из AnomalyDetector._reset_state).
2025-05-21 05:36:54,813 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Специфичное состояние VAEDetector (порог, SHAP) сброшено.
2025-05-21 05:36:54,813 - backend.ml_service.transaction_detectors - INFO - (transaction_vae_price) TransactionVAEDetector инициализирован. Конфигурационные признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], Реально используемые признаки (с генерируемыми): ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], encoding_dim(latent_dim): 10, hidden_dim1(hidden_dim): 32, hidden_dim2: 16, epochs: 25, batch_size: 64, lr: 0.001, kld_w: 0.5, dropout: 0.1
2025-05-21 05:36:54,813 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора transaction_vae_price типа transaction_vae
2025-05-21 05:36:54,813 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_trans_vae_model.joblib' установлен для transaction_vae_price
2025-05-21 05:36:54,813 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib'
2025-05-21 05:36:54,814 - backend.ml_service.detector - INFO - Попытка загрузки модели transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib...
2025-05-21 05:36:54,822 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Загружен порог аномальности: 3.656726
2025-05-21 05:36:54,823 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler успешно инициализирован с параметрами: n_features_in_=4, mean_=(4,), scale_=(4,)
2025-05-21 05:36:54,823 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Фоновые данные SHAP загружены (torch.Size([50, 4]))
2025-05-21 05:36:54,825 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Модель VAE успешно загружена и перемещена на cpu.
2025-05-21 05:36:54,825 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Попытка пересоздания SHAP GradientExplainer после загрузки...
2025-05-21 05:36:54,829 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно ПЕРЕСОЗДАН при загрузке модели. Device=cpu, background_data.shape=torch.Size([50, 4])
2025-05-21 05:36:54,830 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Статус SHAP после загрузки: background_data shape=torch.Size([50, 4]), device=cpu, explainer=создан
2025-05-21 05:36:54,830 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детектор VAE (is_trained=True) успешно загружен.
2025-05-21 05:36:54,830 - backend.ml_service.detector - INFO - Модель transaction_vae_price успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib. is_trained=True
2025-05-21 05:36:54,830 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib
2025-05-21 05:36:54,831 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib.
2025-05-21 05:36:54,831 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) инициализирован с весом 1.0.
2025-05-21 05:36:54,831 - backend.ml_service.transaction_detectors - INFO - CategoryPriceOutlierDetector 'category_price_outlier_model' инициализирован с параметрами: category_col='product_category_name', price_col='price', threshold=2.8, min_samples_per_category=10
2025-05-21 05:36:54,831 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора category_price_outlier_model типа category_price_outlier
2025-05-21 05:36:54,831 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_category_price_model.joblib' установлен для category_price_outlier_model
2025-05-21 05:36:54,832 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib'
2025-05-21 05:36:54,832 - backend.ml_service.detector - INFO - Попытка загрузки модели category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib...
2025-05-21 05:36:54,833 - backend.ml_service.detector - INFO - Модель category_price_outlier_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib. is_trained=True
2025-05-21 05:36:54,833 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib
2025-05-21 05:36:54,834 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib.
2025-05-21 05:36:54,834 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) инициализирован с весом 1.0.
2025-05-21 05:36:54,834 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'behavior'...
2025-05-21 05:36:54,834 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора graph_graph_analysis типа graph
2025-05-21 05:36:54,834 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_graph_model_v3.joblib' установлен для graph_graph_analysis
2025-05-21 05:36:54,834 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib'
2025-05-21 05:36:54,835 - backend.ml_service.detector - INFO - Попытка загрузки модели graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib...
2025-05-21 05:36:54,835 - backend.ml_service.detector - INFO - Модель graph_graph_analysis успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib. is_trained=True
2025-05-21 05:36:54,835 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib
2025-05-21 05:36:54,835 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib.
2025-05-21 05:36:54,836 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) инициализирован с весом 1.0.
2025-05-21 05:36:54,836 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seller_pricing_behavior_model типа seller_pricing_behavior
2025-05-21 05:36:54,836 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_seller_pricing_model.joblib' установлен для seller_pricing_behavior_model
2025-05-21 05:36:54,836 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib'
2025-05-21 05:36:54,836 - backend.ml_service.detector - INFO - Попытка загрузки модели seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib...
2025-05-21 05:36:54,837 - backend.ml_service.detector - INFO - Модель seller_pricing_behavior_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib. is_trained=True
2025-05-21 05:36:54,837 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib
2025-05-21 05:36:54,837 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib.
2025-05-21 05:36:54,837 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) инициализирован с весом 1.0.
2025-05-21 05:36:54,837 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'time_series'...
2025-05-21 05:36:54,838 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seasonal_deviation_model типа seasonal_deviation
2025-05-21 05:36:54,838 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='seasonal_deviation_model.joblib' установлен для seasonal_deviation_model
2025-05-21 05:36:54,838 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib'
2025-05-21 05:36:54,838 - backend.ml_service.detector - INFO - Попытка загрузки модели seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib...
2025-05-21 05:36:54,838 - backend.ml_service.detector - INFO - Модель seasonal_deviation_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib. is_trained=True
2025-05-21 05:36:54,839 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib
2025-05-21 05:36:54,839 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib.
2025-05-21 05:36:54,839 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) инициализирован с весом 1.0.
2025-05-21 05:36:54,839 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора cumulative_sum_model типа cumulative_sum
2025-05-21 05:36:54,839 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='cumulative_sum_model.joblib' установлен для cumulative_sum_model
2025-05-21 05:36:54,840 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib'
2025-05-21 05:36:54,840 - backend.ml_service.detector - INFO - Попытка загрузки модели cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib...
2025-05-21 05:36:54,840 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Загружены baseline_mean=3696.0057142857145, baseline_std=4060.74644512314 из model_state.
2025-05-21 05:36:54,840 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Детектор CUSUM успешно загружен и помечен как обученный.
2025-05-21 05:36:54,840 - backend.ml_service.detector - INFO - Модель cumulative_sum_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib. is_trained=True
2025-05-21 05:36:54,841 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib
2025-05-21 05:36:54,841 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib.
2025-05-21 05:36:54,841 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) инициализирован с весом 1.0.
2025-05-21 05:36:54,841 - backend.ml_service.multilevel_detector - INFO - Многоуровневая система инициализирована: 2 транзакционных детекторов (метод: weighted_average), 2 поведенческих детекторов (метод: weighted_average), 2 детекторов временных рядов (метод: average)
2025-05-21 05:36:54,841 - backend.ml_service.multilevel_service - INFO - Многоуровневая система успешно создана на основе конфигурации из settings.yaml.
2025-05-21 05:36:54,852 - backend.ml_service - INFO - ML Service Logger активен. Уровень: DEBUG. Директория логов ml_service: C:\Users\alex\Desktop\AnomaLens3.0\logs
2025-05-21 05:37:21,101 - backend.ml_service.multilevel_service - INFO - [TaskID: fc3d92c8-ce0b-47a3-a492-b17847cf367f] Обертка detect_async_task_wrapper запущена.
2025-05-21 05:37:21,102 - backend.ml_service.multilevel_service - INFO - Начало обнаружения аномалий (multilevel) с сохранением в БД...
2025-05-21 05:37:21,102 - backend.ml_service.multilevel_service - INFO - Загрузка данных из БД для multilevel detect...
2025-05-21 05:37:21,102 - backend.ml_service.common - INFO - Загрузка данных из БД за период: 1998-01-03 05:37:21.100094 - None (с ассоциациями)
2025-05-21 05:37:24,723 - backend.ml_service.common - INFO - Загружено 118310 записей OrderItem.
2025-05-21 05:37:24,724 - backend.ml_service.multilevel_service - INFO - Данные для multilevel detect (118310 строк) подготовлены. Применение инженерии признаков...
2025-05-21 05:37:24,842 - backend.ml_service.common - INFO - Добавлен признак: 'price_deviation_from_category_mean'
2025-05-21 05:37:24,843 - backend.ml_service.common - INFO - Добавлен признак: 'freight_to_price_ratio'
2025-05-21 05:37:24,844 - backend.ml_service.multilevel_service - INFO - Инженерия признаков для детекции завершена.
2025-05-21 05:37:24,844 - backend.ml_service.multilevel_service - INFO - Запуск multilevel_detector.detect()...
2025-05-21 05:37:24,864 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: transaction...
2025-05-21 05:37:24,865 - backend.ml_service.multilevel_detector - INFO - Уровень 'transaction': Запуск детектора 'transaction_vae_price'...
2025-05-21 05:37:24,889 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Запуск детекции...
2025-05-21 05:37:25,127 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:37:25,127 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:37:25,127 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:37:25,128 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:37:25,128 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:37:26,066 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детекция завершена. Время: 1.18 сек.
2025-05-21 05:37:26,079 - backend.ml_service.multilevel_detector - INFO - Детектор 'transaction_vae_price' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0068
2025-05-21 05:37:26,080 - backend.ml_service.multilevel_detector - INFO - Уровень 'transaction': Запуск детектора 'category_price_outlier_model'...
2025-05-21 05:37:26,467 - backend.ml_service.transaction_detectors - INFO - Для 10 товаров с неизвестными категориями присвоен высокий скор аномальности.
2025-05-21 05:37:26,469 - backend.ml_service.transaction_detectors - INFO - Детектор category_price_outlier_model: обнаружено 2104 аномалий из 118310 транзакций
2025-05-21 05:37:26,493 - backend.ml_service.multilevel_detector - INFO - Детектор 'category_price_outlier_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0115
2025-05-21 05:37:26,507 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction): Матрица скоров (shape (2, 118310)), метод: weighted_average
2025-05-21 05:37:26,513 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction, метод: weighted_average): Используемые веса: {'transaction_vae_price': 1.0, 'category_price_outlier_model': 1.0}, массив весов: [1. 1.]
2025-05-21 05:37:26,513 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction, метод: weighted_average): Распределение combined_scores: Min=0.0001, Max=0.9415, Mean=0.0092
2025-05-21 05:37:26,534 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'transaction' завершен. Добавлен столбец 'transaction_score' и индивидуальные скоры детекторов.
2025-05-21 05:37:26,536 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: behavior...
2025-05-21 05:37:26,647 - backend.ml_service.multilevel_detector - INFO - Детектор 'graph_graph_analysis' типа GraphAnomalyDetector получит оригинальные данные, а не агрегированные
2025-05-21 05:37:26,648 - backend.ml_service.multilevel_detector - INFO - Уровень 'behavior': Запуск детектора 'graph_graph_analysis'...
2025-05-21 05:37:26,667 - backend.ml_service.graph_detector - INFO - Построение графа...
2025-05-21 05:37:30,784 - backend.ml_service.graph_detector - INFO - Граф построен за 4.05 сек. Узлов: 346028, Ребер: 436616
2025-05-21 05:37:30,837 - backend.ml_service.graph_detector - INFO - Расчет графовых аномальных скоров для 112650 узлов OrderItem...
2025-05-21 05:37:32,498 - backend.ml_service.graph_detector - INFO - Детектор graph_graph_analysis: обнаружено 0 аномалий из 118310 (112650 обработано графом)
2025-05-21 05:37:32,548 - backend.ml_service.multilevel_detector - INFO - Детектор 'graph_graph_analysis' обработан. Распределение нормализованных скоров: Min=0.0000, Max=0.6667, Mean=0.1571
2025-05-21 05:37:32,548 - backend.ml_service.multilevel_detector - INFO - Уровень 'behavior': Запуск детектора 'seller_pricing_behavior_model'...
2025-05-21 05:37:32,550 - backend.ml_service.behavior_detectors - INFO - Детектор seller_pricing_behavior_model: обнаружено 389 аномалий из 3095 продавцов
2025-05-21 05:37:32,563 - backend.ml_service.multilevel_detector - INFO - Детектор 'seller_pricing_behavior_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0644
2025-05-21 05:37:32,563 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior): Матрица скоров (shape (2, 3095)), метод: weighted_average
2025-05-21 05:37:32,564 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior, метод: weighted_average): Используемые веса: {'graph_graph_analysis': 1.0, 'seller_pricing_behavior_model': 1.0}, массив весов: [1. 1.]
2025-05-21 05:37:32,565 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior, метод: weighted_average): Распределение combined_scores: Min=0.0000, Max=0.5785, Mean=0.1108
2025-05-21 05:37:32,565 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'behavior' завершен. Добавлен столбец 'behavior_score' и индивидуальные скоры детекторов.
2025-05-21 05:37:32,701 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: time_series...
2025-05-21 05:37:32,778 - backend.ml_service.multilevel_detector - INFO - Уровень 'time_series': Запуск детектора 'seasonal_deviation_model'...
2025-05-21 05:37:32,781 - backend.ml_service.time_series_detectors - INFO - Детектор seasonal_deviation_model: обнаружено 160 аномалий из 616 временных точек
2025-05-21 05:37:32,782 - backend.ml_service.multilevel_detector - INFO - Детектор 'seasonal_deviation_model' обработан. Распределение нормализованных скоров: Min=0.0012, Max=1.0000, Mean=0.6384
2025-05-21 05:37:32,782 - backend.ml_service.multilevel_detector - INFO - Уровень 'time_series': Запуск детектора 'cumulative_sum_model'...
2025-05-21 05:37:32,811 - backend.ml_service.time_series_detectors - INFO - Детектор cumulative_sum_model: обнаружено 614 аномалий из 616 временных точек
2025-05-21 05:37:32,812 - backend.ml_service.multilevel_detector - INFO - Детектор 'cumulative_sum_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.3781
2025-05-21 05:37:32,812 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: time_series): Матрица скоров (shape (2, 616)), метод: average
2025-05-21 05:37:32,813 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: time_series, метод: average): Распределение combined_scores: Min=0.0298, Max=1.0000, Mean=0.5082
2025-05-21 05:37:32,814 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'time_series' завершен. Добавлен столбец 'time_series_score' и индивидуальные скоры детекторов.
2025-05-21 05:37:32,843 - backend.ml_service.multilevel_detector - INFO - Слияние временных данных: result_df имеет 118310 строк, 616 уникальных дат
2025-05-21 05:37:32,844 - backend.ml_service.multilevel_detector - INFO - Слияние временных данных: ts_scores_to_merge имеет 616 строк, 616 уникальных дат
2025-05-21 05:37:32,910 - backend.ml_service.multilevel_detector - DEBUG - Распределение transaction_level_score: Min=0.0001, Max=0.9415, Mean=0.0092
2025-05-21 05:37:32,911 - backend.ml_service.multilevel_detector - DEBUG - Распределение behavior_level_score: Min=0.0000, Max=0.5785, Mean=0.1589
2025-05-21 05:37:32,911 - backend.ml_service.multilevel_detector - DEBUG - Распределение time_series_level_score: Min=0.0298, Max=1.0000, Mean=0.5518
2025-05-21 05:37:32,912 - backend.ml_service.multilevel_detector - INFO - Расчет итогового многоуровневого скора...
2025-05-21 05:37:32,913 - backend.ml_service.multilevel_detector - DEBUG - Распределение multilevel_score (перед порогом): Min=0.0118, Max=0.6089, Mean=0.2169
2025-05-21 05:37:32,915 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8307, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:32,915 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:37:32,915 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-29 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:32,916 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-29 00:00:00
2025-05-21 05:37:32,919 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
583 2018-07-29          188      32085.4  145.842727             150               188               2018-07-29  35787.032857         0.896565           0.879612                           0.830683                       0.928541    2018-07-29
2025-05-21 05:37:32,920 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}]
2025-05-21 05:37:32,920 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:32,920 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.8306826658975347, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}]
2025-05-21 05:37:32,920 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9285, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:32,920 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:37:32,921 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-29 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:32,921 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-29 00:00:00
2025-05-21 05:37:32,923 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
583 2018-07-29          188      32085.4  145.842727             150               188               2018-07-29  35787.032857         0.896565           0.879612                           0.830683                       0.928541    2018-07-29
2025-05-21 05:37:32,924 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-07-29 00:00:00", "current_value": 32085.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 28389.394285714287, "deviation_in_std": 6.991176294646339, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (32085.40) отклоняется от базовой линии (3696.01) на 28389.39, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:37:32,924 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:32,924 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.8306826658975347, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.928540895759355, "explanation": {"detector_specific_info": {"date": "2018-07-29 00:00:00", "current_value": 32085.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 28389.394285714287, "deviation_in_std": 6.991176294646339, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (32085.40) отклоняется от базовой линии (3696.01) на 28389.39, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:37:32,925 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:32,925 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:37:32,925 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:32,926 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-03 00:00:00
2025-05-21 05:37:32,928 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales  avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
588 2018-08-03          314     45036.63  125.10175             216               314               2018-08-03  39138.992857         1.150684           0.972436                                1.0                       0.944872    2018-08-03
2025-05-21 05:37:32,928 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:37:32,928 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:32,928 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:37:32,928 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9449, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:32,928 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:37:32,929 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:32,930 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-03 00:00:00
2025-05-21 05:37:32,932 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales  avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
588 2018-08-03          314     45036.63  125.10175             216               314               2018-08-03  39138.992857         1.150684           0.972436                                1.0                       0.944872    2018-08-03
2025-05-21 05:37:32,932 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-03 00:00:00", "current_value": 45036.63, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 41340.624285714286, "deviation_in_std": 10.18054804563417, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (45036.63) отклоняется от базовой линии (3696.01) на 41340.62, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:37:32,933 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:32,933 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9448723295452219, "explanation": {"detector_specific_info": {"date": "2018-08-03 00:00:00", "current_value": 45036.63, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 41340.624285714286, "deviation_in_std": 10.18054804563417, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (45036.63) отклоняется от базовой линии (3696.01) на 41340.62, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:37:32,933 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:32,933 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:37:32,934 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:32,934 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-03 00:00:00
2025-05-21 05:37:32,936 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
527 2018-06-03          191      31535.8  137.112174             149               191               2018-06-03  27063.432857         1.165255           0.903771                                1.0                       0.807541    2018-06-03
2025-05-21 05:37:32,937 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}]
2025-05-21 05:37:32,937 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:32,937 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}]
2025-05-21 05:37:32,937 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8075, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:32,938 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:37:32,938 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:32,939 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-03 00:00:00
2025-05-21 05:37:32,940 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
527 2018-06-03          191      31535.8  137.112174             149               191               2018-06-03  27063.432857         1.165255           0.903771                                1.0                       0.807541    2018-06-03
2025-05-21 05:37:32,941 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-03 00:00:00", "current_value": 31535.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 27839.794285714284, "deviation_in_std": 6.855831720089102, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (31535.80) отклоняется от базовой линии (3696.01) на 27839.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:37:32,941 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:32,941 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8075414451585549, "explanation": {"detector_specific_info": {"date": "2018-06-03 00:00:00", "current_value": 31535.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 27839.794285714284, "deviation_in_std": 6.855831720089102, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (31535.80) отклоняется от базовой линии (3696.01) на 27839.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:37:32,941 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 26323, order_id: 0812eb902a67711a1cb742b3cdaa65ae, level: transaction): Detector Column: 'trans_transaction_vae_price_score', Score: 0.8830, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:32,942 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'transaction_vae_price': TransactionVAEDetector
2025-05-21 05:37:32,948 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'transaction_vae_price':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id  product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
26323              1  0812eb902a67711a1cb742b3cdaa65ae  489ae2aa008f021502940f251d4cce7f  e3b4998c7a498169dc7bce44e6bb6277  6735.0         194.31      2017-02-12 20:37:36  c6e2731c5b391845f6800c97401a43a9  utilidades_domesticas                 31.0                       875.0                 2.0           30000.0               60.0               61.0              33.0                    housewares             MS           SP  credit_card                   8.0        6929.31           5.0                           74.309637                0.028851                 0.941508                    True                           0.883016                                       1.0              0.398596                False                           0.15721                                   0.639983                 0.189451                           0.367431                        0.01147                   False          0.553017        True                       None
2025-05-21 05:37:32,948 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Метод get_explanation_details не реализован специфично, будет использована реализация get_shap_explanations (если есть).
2025-05-21 05:37:32,950 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:37:32,950 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:37:32,950 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:37:32,950 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:37:32,950 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:37:32,951 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Вычисление SHAP values для 1 экземпляров...
2025-05-21 05:37:32,951 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Используется nsamples=50 для SHAP
2025-05-21 05:37:32,952 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Запрос SHAP объяснений: explainer=True, background_data_exists=True, model=True
2025-05-21 05:37:32,952 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Создание GradientExplainer с размерами данных: torch.Size([50, 4])
2025-05-21 05:37:32,970 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw type: <class 'numpy.ndarray'>
2025-05-21 05:37:32,971 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw (ndarray) shape: (1, 4, 1)
2025-05-21 05:37:32,971 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно создан и вычислены SHAP-значения
2025-05-21 05:37:32,971 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values_raw уже является ndarray, shape: (1, 4, 1)
2025-05-21 05:37:32,971 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Начальная форма shap_values_arr: (1, 4, 1), ndim: 3
2025-05-21 05:37:32,972 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values после squeeze(-1): (1, 4)
2025-05-21 05:37:32,972 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP values успешно вычислены для 1 экземпляров.
2025-05-21 05:37:32,972 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'transaction_vae_price': [{"shap_values": {"price": 37.866585751205086, "freight_value": -1.6265850905627215, "product_weight_g": 2.8471868470439636, "freight_to_price_ratio": -0.37894474445935555}}]
2025-05-21 05:37:32,973 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'transaction_vae_price' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:32,973 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.8830156159295035, "explanation": {"shap_values": {"price": 37.866585751205086, "freight_value": -1.6265850905627215, "product_weight_g": 2.8471868470439636, "freight_to_price_ratio": -0.37894474445935555}}}]
2025-05-21 05:37:32,973 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 26323, order_id: 0812eb902a67711a1cb742b3cdaa65ae, level: transaction): Detector Column: 'trans_category_price_outlier_model_score', Score: 1.0000, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:32,974 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'category_price_outlier_model': CategoryPriceOutlierDetector
2025-05-21 05:37:32,980 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'category_price_outlier_model':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id  product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
26323              1  0812eb902a67711a1cb742b3cdaa65ae  489ae2aa008f021502940f251d4cce7f  e3b4998c7a498169dc7bce44e6bb6277  6735.0         194.31      2017-02-12 20:37:36  c6e2731c5b391845f6800c97401a43a9  utilidades_domesticas                 31.0                       875.0                 2.0           30000.0               60.0               61.0              33.0                    housewares             MS           SP  credit_card                   8.0        6929.31           5.0                           74.309637                0.028851                 0.941508                    True                           0.883016                                       1.0              0.398596                False                           0.15721                                   0.639983                 0.189451                           0.367431                        0.01147                   False          0.553017        True                       None
2025-05-21 05:37:32,981 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'category_price_outlier_model': [{"detector_specific_info": {"category": "utilidades_domesticas", "price": 6735.0, "category_mean_price": 90.63427371273713, "category_std_price": 140.19371115720259, "category_min_price": 3.06, "category_max_price": 6735.0, "category_count": 7380, "z_score": 47.394178179909765, "threshold": 2.8, "explanation": "Цена 6735.00 отличается от средней цены в категории 'utilidades_domesticas' (90.63) на 47.39 стандартных отклонений (порог: 2.8)."}}]
2025-05-21 05:37:32,981 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'category_price_outlier_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:32,981 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.8830156159295035, "explanation": {"shap_values": {"price": 37.866585751205086, "freight_value": -1.6265850905627215, "product_weight_g": 2.8471868470439636, "freight_to_price_ratio": -0.37894474445935555}}}, {"detector_name": "category_price_outlier_model", "detector_type": "CategoryPriceOutlierDetector", "score": 1.0, "explanation": {"detector_specific_info": {"category": "utilidades_domesticas", "price": 6735.0, "category_mean_price": 90.63427371273713, "category_std_price": 140.19371115720259, "category_min_price": 3.06, "category_max_price": 6735.0, "category_count": 7380, "z_score": 47.394178179909765, "threshold": 2.8, "explanation": "Цена 6735.00 отличается от средней цены в категории 'utilidades_domesticas' (90.63) на 47.39 стандартных отклонений (порог: 2.8)."}}}]
2025-05-21 05:37:32,981 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:32,982 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:37:32,982 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-25 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:32,983 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-25 00:00:00
2025-05-21 05:37:32,984 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
579 2018-07-25          268     40753.19  122.750572             201               268               2018-07-25  35288.758571         1.154849           0.959618                                1.0                       0.919235    2018-07-25
2025-05-21 05:37:32,985 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:37:32,985 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:32,985 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:37:32,986 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9192, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:32,986 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:37:32,986 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-25 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:32,987 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-25 00:00:00
2025-05-21 05:37:32,989 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
579 2018-07-25          268     40753.19  122.750572             201               268               2018-07-25  35288.758571         1.154849           0.959618                                1.0                       0.919235    2018-07-25
2025-05-21 05:37:32,990 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-07-25 00:00:00", "current_value": 40753.19, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37057.18428571429, "deviation_in_std": 9.125707498979427, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (40753.19) отклоняется от базовой линии (3696.01) на 37057.18, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:37:32,990 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:32,990 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9192352183494302, "explanation": {"detector_specific_info": {"date": "2018-07-25 00:00:00", "current_value": 40753.19, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37057.18428571429, "deviation_in_std": 9.125707498979427, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (40753.19) отклоняется от базовой линии (3696.01) на 37057.18, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:37:32,990 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 42860, order_id: 90674f59a21207f91a7387785c66f340, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:32,991 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:37:32,991 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-14 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:32,992 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-14 00:00:00
2025-05-21 05:37:32,995 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
599 2018-08-14          315     44682.42  128.397759             228               315               2018-08-14  37562.228571         1.189557           0.989198                                1.0                       0.978396    2018-08-14
2025-05-21 05:37:32,995 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:37:32,996 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:32,996 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:37:32,996 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 42860, order_id: 90674f59a21207f91a7387785c66f340, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9784, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:32,996 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:37:32,997 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-14 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:32,998 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-14 00:00:00
2025-05-21 05:37:33,000 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
599 2018-08-14          315     44682.42  128.397759             228               315               2018-08-14  37562.228571         1.189557           0.989198                                1.0                       0.978396    2018-08-14
2025-05-21 05:37:33,000 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-14 00:00:00", "current_value": 44682.42, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 40986.41428571429, "deviation_in_std": 10.093320240405061, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (44682.42) отклоняется от базовой линии (3696.01) на 40986.41, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:37:33,001 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,001 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9783962277530719, "explanation": {"detector_specific_info": {"date": "2018-08-14 00:00:00", "current_value": 44682.42, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 40986.41428571429, "deviation_in_std": 10.093320240405061, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (44682.42) отклоняется от базовой линии (3696.01) на 40986.41, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:37:33,001 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: transaction): Detector Column: 'trans_transaction_vae_price_score', Score: 1.0000, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,002 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'transaction_vae_price': TransactionVAEDetector
2025-05-21 05:37:33,008 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'transaction_vae_price':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
57579              1  3dd5626c63f493f8b8f8788c2be24baa  3a1855685a49813f60e6193864f7215e  c510bc1718f0f2961eaa42a23330681a  2699.0         306.06      2018-04-27 19:50:43  a8f345f82667eb421151dc7626147636                 bebes                 54.0                      2583.0                10.0           11450.0               57.0               78.0              44.0                          baby             SC           SP  credit_card                  10.0        3005.06           5.0                           19.887203                0.113398                 0.620279                    True                                1.0                                  0.240557              0.379093                False                          0.147594                                   0.610592                 0.823398                           0.928073                       0.718724                    True          0.608859        True                       None
2025-05-21 05:37:33,008 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Метод get_explanation_details не реализован специфично, будет использована реализация get_shap_explanations (если есть).
2025-05-21 05:37:33,010 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:37:33,010 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:37:33,010 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:37:33,011 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:37:33,011 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:37:33,011 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Вычисление SHAP values для 1 экземпляров...
2025-05-21 05:37:33,011 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Используется nsamples=50 для SHAP
2025-05-21 05:37:33,012 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Запрос SHAP объяснений: explainer=True, background_data_exists=True, model=True
2025-05-21 05:37:33,012 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Создание GradientExplainer с размерами данных: torch.Size([50, 4])
2025-05-21 05:37:33,059 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw type: <class 'numpy.ndarray'>
2025-05-21 05:37:33,061 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw (ndarray) shape: (1, 4, 1)
2025-05-21 05:37:33,064 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно создан и вычислены SHAP-значения
2025-05-21 05:37:33,065 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values_raw уже является ndarray, shape: (1, 4, 1)
2025-05-21 05:37:33,065 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Начальная форма shap_values_arr: (1, 4, 1), ndim: 3
2025-05-21 05:37:33,065 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values после squeeze(-1): (1, 4)
2025-05-21 05:37:33,066 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP values успешно вычислены для 1 экземпляров.
2025-05-21 05:37:33,067 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'transaction_vae_price': [{"shap_values": {"price": 80.05543677247731, "freight_value": -31.51850190238049, "product_weight_g": -6.489322002222256, "freight_to_price_ratio": 2.679355199036803}}]
2025-05-21 05:37:33,067 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'transaction_vae_price' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,067 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 1.0, "explanation": {"shap_values": {"price": 80.05543677247731, "freight_value": -31.51850190238049, "product_weight_g": -6.489322002222256, "freight_to_price_ratio": 2.679355199036803}}}]
2025-05-21 05:37:33,068 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: transaction): Detector Column: 'trans_category_price_outlier_model_score', Score: 0.2406, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,068 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'category_price_outlier_model': CategoryPriceOutlierDetector
2025-05-21 05:37:33,074 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'category_price_outlier_model':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
57579              1  3dd5626c63f493f8b8f8788c2be24baa  3a1855685a49813f60e6193864f7215e  c510bc1718f0f2961eaa42a23330681a  2699.0         306.06      2018-04-27 19:50:43  a8f345f82667eb421151dc7626147636                 bebes                 54.0                      2583.0                10.0           11450.0               57.0               78.0              44.0                          baby             SC           SP  credit_card                  10.0        3005.06           5.0                           19.887203                0.113398                 0.620279                    True                                1.0                                  0.240557              0.379093                False                          0.147594                                   0.610592                 0.823398                           0.928073                       0.718724                    True          0.608859        True                       None
2025-05-21 05:37:33,075 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'category_price_outlier_model': [{"detector_specific_info": {"category": "bebes", "price": 2699.0, "category_mean_price": 135.71541510611735, "category_std_price": 224.82969338108902, "category_min_price": 3.54, "category_max_price": 3899.0, "category_count": 3204, "z_score": 11.401005562681993, "threshold": 2.8, "explanation": "Цена 2699.00 отличается от средней цены в категории 'bebes' (135.72) на 11.40 стандартных отклонений (порог: 2.8)."}}]
2025-05-21 05:37:33,075 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'category_price_outlier_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,075 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 1.0, "explanation": {"shap_values": {"price": 80.05543677247731, "freight_value": -31.51850190238049, "product_weight_g": -6.489322002222256, "freight_to_price_ratio": 2.679355199036803}}}, {"detector_name": "category_price_outlier_model", "detector_type": "CategoryPriceOutlierDetector", "score": 0.24055704531923383, "explanation": {"detector_specific_info": {"category": "bebes", "price": 2699.0, "category_mean_price": 135.71541510611735, "category_std_price": 224.82969338108902, "category_min_price": 3.54, "category_max_price": 3899.0, "category_count": 3204, "z_score": 11.401005562681993, "threshold": 2.8, "explanation": "Цена 2699.00 отличается от средней цены в категории 'bebes' (135.72) на 11.40 стандартных отклонений (порог: 2.8)."}}}]
2025-05-21 05:37:33,076 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.9281, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,076 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:37:33,076 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-04-27 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,077 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-04-27 00:00:00
2025-05-21 05:37:33,079 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
490 2018-04-27          242     41231.39  140.242823             165               242               2018-04-27  35298.295714         1.168084           0.823398                           0.928073                       0.718724    2018-04-27
2025-05-21 05:37:33,080 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:37:33,080 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,080 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9280726698190791, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:37:33,080 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.7187, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,080 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:37:33,080 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-04-27 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,081 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-04-27 00:00:00
2025-05-21 05:37:33,083 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
490 2018-04-27          242     41231.39  140.242823             165               242               2018-04-27  35298.295714         1.168084           0.823398                           0.928073                       0.718724    2018-04-27
2025-05-21 05:37:33,084 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-04-27 00:00:00", "current_value": 41231.39, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37535.38428571429, "deviation_in_std": 9.243469099331083, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (41231.39) отклоняется от базовой линии (3696.01) на 37535.38, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:37:33,084 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,084 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9280726698190791, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.718723936134046, "explanation": {"detector_specific_info": {"date": "2018-04-27 00:00:00", "current_value": 41231.39, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37535.38428571429, "deviation_in_std": 9.243469099331083, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (41231.39) отклоняется от базовой линии (3696.01) на 37535.38, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:37:33,085 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 74778, order_id: 94fca82966c05ba707f4e7dc0c50aa3c, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,085 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:37:33,085 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,086 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:37:33,089 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:37:33,089 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:37:33,089 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,090 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:37:33,090 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 74778, order_id: 94fca82966c05ba707f4e7dc0c50aa3c, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9819, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,090 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:37:33,091 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,092 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:37:33,093 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:37:33,094 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:37:33,094 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,094 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9819435388597458, "explanation": {"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:37:33,095 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 75482, order_id: 4160b6447ad70e6d73f7221dd970bbe9, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,095 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:37:33,095 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,096 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:37:33,098 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:37:33,099 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:37:33,099 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,099 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:37:33,099 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 75482, order_id: 4160b6447ad70e6d73f7221dd970bbe9, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9819, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,100 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:37:33,100 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,101 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:37:33,102 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:37:33,103 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:37:33,104 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,104 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9819435388597458, "explanation": {"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:37:33,104 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.9481, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,105 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:37:33,105 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-01-26 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,106 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-01-26 00:00:00
2025-05-21 05:37:33,108 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
399 2018-01-26          228     34533.35  125.575818             151               228               2018-01-26       31895.5         1.082703           0.722093                           0.948138                       0.496047    2018-01-26
2025-05-21 05:37:33,108 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:37:33,109 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,109 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9481383115297547, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:37:33,109 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.4960, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,109 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:37:33,109 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-01-26 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,110 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-01-26 00:00:00
2025-05-21 05:37:33,112 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
399 2018-01-26          228     34533.35  125.575818             151               228               2018-01-26       31895.5         1.082703           0.722093                           0.948138                       0.496047    2018-01-26
2025-05-21 05:37:33,113 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-01-26 00:00:00", "current_value": 34533.35, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 30837.344285714284, "deviation_in_std": 7.594008811544785, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34533.35) отклоняется от базовой линии (3696.01) на 30837.34, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:37:33,113 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,113 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9481383115297547, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.496047165599019, "explanation": {"detector_specific_info": {"date": "2018-01-26 00:00:00", "current_value": 34533.35, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 30837.344285714284, "deviation_in_std": 7.594008811544785, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34533.35) отклоняется от базовой линии (3696.01) на 30837.34, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:37:33,114 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87594, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8164, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,114 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:37:33,114 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,115 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:37:33,117 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:37:33,117 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:37:33,118 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,118 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:37:33,119 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87594, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8123, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,119 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:37:33,119 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,120 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:37:33,122 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:37:33,122 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:37:33,123 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,123 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8122690239748033, "explanation": {"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:37:33,123 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87595, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8164, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,124 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:37:33,124 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,125 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:37:33,127 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:37:33,128 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:37:33,128 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,128 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:37:33,128 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87595, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8123, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,128 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:37:33,128 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,129 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:37:33,131 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:37:33,132 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:37:33,132 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,132 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8122690239748033, "explanation": {"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:37:33,132 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,133 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:37:33,133 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-03-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,134 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-03-15 00:00:00
2025-05-21 05:37:33,136 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
447 2018-03-15          286      46096.4  135.180059             174               286               2018-03-15  32494.021429         1.418612           0.804803                                1.0                       0.609605    2018-03-15
2025-05-21 05:37:33,136 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}]
2025-05-21 05:37:33,137 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,137 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}}]
2025-05-21 05:37:33,137 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.6096, Threshold: 0.1, Passes Threshold: True
2025-05-21 05:37:33,137 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:37:33,138 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-03-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:37:33,138 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-03-15 00:00:00
2025-05-21 05:37:33,140 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
447 2018-03-15          286      46096.4  135.180059             174               286               2018-03-15  32494.021429         1.418612           0.804803                                1.0                       0.609605    2018-03-15
2025-05-21 05:37:33,141 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-03-15 00:00:00", "current_value": 46096.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42400.39428571429, "deviation_in_std": 10.441527157312704, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46096.40) отклоняется от базовой линии (3696.01) на 42400.39, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:37:33,141 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:37:33,141 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.609605020859105, "explanation": {"detector_specific_info": {"date": "2018-03-15 00:00:00", "current_value": 46096.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42400.39428571429, "deviation_in_std": 10.441527157312704, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46096.40) отклоняется от базовой линии (3696.01) на 42400.39, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:37:33,143 - backend.ml_service.multilevel_detector - INFO - Сгенерированы объяснения для 13 из 13 аномалий
2025-05-21 05:37:33,143 - backend.ml_service.multilevel_detector - INFO - Многоуровневая детекция завершена. Обнаружено 13 аномалий.
2025-05-21 05:37:33,157 - backend.ml_service.multilevel_service - INFO - Обнаружено 13 multilevel аномалий до сохранения.
2025-05-21 05:37:33,157 - backend.ml_service.multilevel_service - INFO - Начало сохранения multilevel аномалий в БД...
2025-05-21 05:37:33,228 - backend.ml_service.multilevel_service - INFO - Статистика сохранения multilevel аномалий: {'total_detected_anomalies_before_save': 13, 'newly_saved_anomalies_count': 12, 'newly_saved_anomaly_ids': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], 'skipped_duplicates_count': 1, 'errors_on_save': 0}
2025-05-21 05:37:33,229 - backend.ml_service.multilevel_service - DEBUG - Сессия БД (db_for_crud) для multilevel detect закрыта.
2025-05-21 05:37:33,229 - backend.ml_service.multilevel_service - DEBUG - Сессия БД (db_for_load_detect) для multilevel detect закрыта.
2025-05-21 05:37:33,255 - backend.ml_service.multilevel_service - INFO - [TaskID: fc3d92c8-ce0b-47a3-a492-b17847cf367f] Детекция и сохранение аномалий успешно завершены.
2025-05-21 05:38:39,075 - backend.ml_service - INFO - Логирование настроено с уровнем DEBUG
2025-05-21 05:38:39,076 - backend.ml_service - INFO - Логи записываются в файл: C:\Users\alex\Desktop\AnomaLens3.0\logs\ml_service_2025-05-21.log
2025-05-21 05:38:42,136 - backend.ml_service.multilevel_service - INFO - Базовый путь для моделей (MultilevelService): C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models
2025-05-21 05:38:42,136 - backend.ml_service.multilevel_service - INFO - Создание/инициализация многоуровневой системы на основе настроек из config.yaml.
2025-05-21 05:38:42,136 - backend.ml_service.multilevel_service - DEBUG - Используется следующая конфигурация для MultilevelAnomalyDetector: {
  "transaction_level": [
    {
      "type": "transaction_vae",
      "model_filename": "ml_trans_vae_model.joblib",
      "weight": 1.0,
      "features": [
        "price",
        "freight_value",
        "product_weight_g",
        "freight_to_price_ratio"
      ],
      "encoding_dim": 10,
      "hidden_dim1": 32,
      "hidden_dim2": 16,
      "epochs": 25,
      "kld_weight": 0.5,
      "dropout_rate": 0.1,
      "shap_background_samples": 50
    },
    {
      "type": "category_price_outlier",
      "model_filename": "ml_category_price_model.joblib",
      "weight": 1.0,
      "category_col": "product_category_name",
      "price_col": "price",
      "threshold": 2.8,
      "min_samples_per_category": 10
    }
  ],
  "behavior_level": [
    {
      "type": "graph",
      "model_filename": "ml_graph_model_v3.joblib",
      "weight": 1.0,
      "use_seller_state_spread": true,
      "use_category_diversity": true,
      "use_seller_degree": true,
      "seller_state_weight": 0.3,
      "category_diversity_weight": 0.4,
      "seller_degree_weight": 0.3
    },
    {
      "type": "seller_pricing_behavior",
      "model_filename": "ml_seller_pricing_model.joblib",
      "weight": 1.0,
      "volatility_threshold": 0.5,
      "range_threshold": 5.0,
      "freight_ratio_threshold": 1.0,
      "min_transactions": 5
    }
  ],
  "time_series_level": [
    {
      "type": "seasonal_deviation",
      "model_filename": "seasonal_deviation_model.joblib",
      "weight": 1.0,
      "window_size": 7,
      "threshold": 2.5
    },
    {
      "type": "cumulative_sum",
      "model_filename": "cumulative_sum_model.joblib",
      "weight": 1.0,
      "window_size": 14,
      "threshold": 2.5,
      "drift_threshold": 4.5
    }
  ],
  "combination_weights": {
    "transaction": 0.4,
    "behavior": 0.3,
    "time_series": 0.3
  },
  "transaction_level_combination_method": "weighted_average",
  "behavior_level_combination_method": "weighted_average",
  "time_series_level_combination_method": "average"
}
2025-05-21 05:38:42,137 - backend.ml_service.multilevel_detector - INFO - Инициализация многоуровневой системы обнаружения аномалий...
2025-05-21 05:38:42,137 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'transaction'...
2025-05-21 05:38:42,137 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) VAEDetector инициализирован. Устройство: cpu, Входная размерность: 4, Признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio']
2025-05-21 05:38:42,137 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Сброс базового состояния детектора (из AnomalyDetector._reset_state).
2025-05-21 05:38:42,137 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Специфичное состояние VAEDetector (порог, SHAP) сброшено.
2025-05-21 05:38:42,137 - backend.ml_service.transaction_detectors - INFO - (transaction_vae_price) TransactionVAEDetector инициализирован. Конфигурационные признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], Реально используемые признаки (с генерируемыми): ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], encoding_dim(latent_dim): 10, hidden_dim1(hidden_dim): 32, hidden_dim2: 16, epochs: 25, batch_size: 64, lr: 0.001, kld_w: 0.5, dropout: 0.1
2025-05-21 05:38:42,138 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора transaction_vae_price типа transaction_vae
2025-05-21 05:38:42,138 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_trans_vae_model.joblib' установлен для transaction_vae_price
2025-05-21 05:38:42,138 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib'
2025-05-21 05:38:42,138 - backend.ml_service.detector - INFO - Попытка загрузки модели transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib...
2025-05-21 05:38:42,147 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Загружен порог аномальности: 3.656726
2025-05-21 05:38:42,147 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler успешно инициализирован с параметрами: n_features_in_=4, mean_=(4,), scale_=(4,)
2025-05-21 05:38:42,147 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Фоновые данные SHAP загружены (torch.Size([50, 4]))
2025-05-21 05:38:42,151 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Модель VAE успешно загружена и перемещена на cpu.
2025-05-21 05:38:42,151 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Попытка пересоздания SHAP GradientExplainer после загрузки...
2025-05-21 05:38:42,156 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно ПЕРЕСОЗДАН при загрузке модели. Device=cpu, background_data.shape=torch.Size([50, 4])
2025-05-21 05:38:42,156 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Статус SHAP после загрузки: background_data shape=torch.Size([50, 4]), device=cpu, explainer=создан
2025-05-21 05:38:42,157 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детектор VAE (is_trained=True) успешно загружен.
2025-05-21 05:38:42,157 - backend.ml_service.detector - INFO - Модель transaction_vae_price успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib. is_trained=True
2025-05-21 05:38:42,157 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib
2025-05-21 05:38:42,158 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib.
2025-05-21 05:38:42,158 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) инициализирован с весом 1.0.
2025-05-21 05:38:42,158 - backend.ml_service.transaction_detectors - INFO - CategoryPriceOutlierDetector 'category_price_outlier_model' инициализирован с параметрами: category_col='product_category_name', price_col='price', threshold=2.8, min_samples_per_category=10
2025-05-21 05:38:42,158 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора category_price_outlier_model типа category_price_outlier
2025-05-21 05:38:42,158 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_category_price_model.joblib' установлен для category_price_outlier_model
2025-05-21 05:38:42,159 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib'
2025-05-21 05:38:42,159 - backend.ml_service.detector - INFO - Попытка загрузки модели category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib...
2025-05-21 05:38:42,161 - backend.ml_service.detector - INFO - Модель category_price_outlier_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib. is_trained=True
2025-05-21 05:38:42,161 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib
2025-05-21 05:38:42,162 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib.
2025-05-21 05:38:42,162 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) инициализирован с весом 1.0.
2025-05-21 05:38:42,163 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'behavior'...
2025-05-21 05:38:42,163 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора graph_graph_analysis типа graph
2025-05-21 05:38:42,163 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_graph_model_v3.joblib' установлен для graph_graph_analysis
2025-05-21 05:38:42,163 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib'
2025-05-21 05:38:42,163 - backend.ml_service.detector - INFO - Попытка загрузки модели graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib...
2025-05-21 05:38:42,164 - backend.ml_service.detector - INFO - Модель graph_graph_analysis успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib. is_trained=True
2025-05-21 05:38:42,164 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib
2025-05-21 05:38:42,164 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib.
2025-05-21 05:38:42,164 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) инициализирован с весом 1.0.
2025-05-21 05:38:42,165 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seller_pricing_behavior_model типа seller_pricing_behavior
2025-05-21 05:38:42,165 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_seller_pricing_model.joblib' установлен для seller_pricing_behavior_model
2025-05-21 05:38:42,165 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib'
2025-05-21 05:38:42,165 - backend.ml_service.detector - INFO - Попытка загрузки модели seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib...
2025-05-21 05:38:42,166 - backend.ml_service.detector - INFO - Модель seller_pricing_behavior_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib. is_trained=True
2025-05-21 05:38:42,166 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib
2025-05-21 05:38:42,166 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib.
2025-05-21 05:38:42,167 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) инициализирован с весом 1.0.
2025-05-21 05:38:42,167 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'time_series'...
2025-05-21 05:38:42,167 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seasonal_deviation_model типа seasonal_deviation
2025-05-21 05:38:42,167 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='seasonal_deviation_model.joblib' установлен для seasonal_deviation_model
2025-05-21 05:38:42,168 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib'
2025-05-21 05:38:42,168 - backend.ml_service.detector - INFO - Попытка загрузки модели seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib...
2025-05-21 05:38:42,169 - backend.ml_service.detector - INFO - Модель seasonal_deviation_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib. is_trained=True
2025-05-21 05:38:42,169 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib
2025-05-21 05:38:42,169 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib.
2025-05-21 05:38:42,169 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) инициализирован с весом 1.0.
2025-05-21 05:38:42,169 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора cumulative_sum_model типа cumulative_sum
2025-05-21 05:38:42,170 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='cumulative_sum_model.joblib' установлен для cumulative_sum_model
2025-05-21 05:38:42,170 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib'
2025-05-21 05:38:42,170 - backend.ml_service.detector - INFO - Попытка загрузки модели cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib...
2025-05-21 05:38:42,171 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Загружены baseline_mean=3696.0057142857145, baseline_std=4060.74644512314 из model_state.
2025-05-21 05:38:42,171 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Детектор CUSUM успешно загружен и помечен как обученный.
2025-05-21 05:38:42,171 - backend.ml_service.detector - INFO - Модель cumulative_sum_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib. is_trained=True
2025-05-21 05:38:42,171 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib
2025-05-21 05:38:42,171 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib.
2025-05-21 05:38:42,171 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) инициализирован с весом 1.0.
2025-05-21 05:38:42,172 - backend.ml_service.multilevel_detector - INFO - Многоуровневая система инициализирована: 2 транзакционных детекторов (метод: weighted_average), 2 поведенческих детекторов (метод: weighted_average), 2 детекторов временных рядов (метод: average)
2025-05-21 05:38:42,172 - backend.ml_service.multilevel_service - INFO - Многоуровневая система успешно создана на основе конфигурации из settings.yaml.
2025-05-21 05:38:42,184 - backend.ml_service - INFO - ML Service Logger активен. Уровень: DEBUG. Директория логов ml_service: C:\Users\alex\Desktop\AnomaLens3.0\logs
2025-05-21 05:38:47,650 - backend.ml_service.multilevel_service - INFO - [TaskID: 899442d1-abc2-41c7-85a9-f011fbfaa0ac] Обертка detect_async_task_wrapper запущена.
2025-05-21 05:38:47,651 - backend.ml_service.multilevel_service - INFO - Начало обнаружения аномалий (multilevel) с сохранением в БД...
2025-05-21 05:38:47,652 - backend.ml_service.multilevel_service - INFO - Загрузка данных из БД для multilevel detect...
2025-05-21 05:38:47,652 - backend.ml_service.common - INFO - Загрузка данных из БД за период: 1998-01-03 05:38:47.649822 - None (с ассоциациями)
2025-05-21 05:38:51,539 - backend.ml_service.common - INFO - Загружено 118310 записей OrderItem.
2025-05-21 05:38:51,539 - backend.ml_service.multilevel_service - INFO - Данные для multilevel detect (118310 строк) подготовлены. Применение инженерии признаков...
2025-05-21 05:38:51,663 - backend.ml_service.common - INFO - Добавлен признак: 'price_deviation_from_category_mean'
2025-05-21 05:38:51,665 - backend.ml_service.common - INFO - Добавлен признак: 'freight_to_price_ratio'
2025-05-21 05:38:51,665 - backend.ml_service.multilevel_service - INFO - Инженерия признаков для детекции завершена.
2025-05-21 05:38:51,665 - backend.ml_service.multilevel_service - INFO - Запуск multilevel_detector.detect()...
2025-05-21 05:38:51,689 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: transaction...
2025-05-21 05:38:51,691 - backend.ml_service.multilevel_detector - INFO - Уровень 'transaction': Запуск детектора 'transaction_vae_price'...
2025-05-21 05:38:51,716 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Запуск детекции...
2025-05-21 05:38:51,952 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:38:51,952 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:38:51,953 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:38:51,953 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:38:51,953 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:38:52,895 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детекция завершена. Время: 1.18 сек.
2025-05-21 05:38:52,908 - backend.ml_service.multilevel_detector - INFO - Детектор 'transaction_vae_price' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0067
2025-05-21 05:38:52,908 - backend.ml_service.multilevel_detector - INFO - Уровень 'transaction': Запуск детектора 'category_price_outlier_model'...
2025-05-21 05:38:53,294 - backend.ml_service.transaction_detectors - INFO - Для 10 товаров с неизвестными категориями присвоен высокий скор аномальности.
2025-05-21 05:38:53,296 - backend.ml_service.transaction_detectors - INFO - Детектор category_price_outlier_model: обнаружено 2104 аномалий из 118310 транзакций
2025-05-21 05:38:53,323 - backend.ml_service.multilevel_detector - INFO - Детектор 'category_price_outlier_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0115
2025-05-21 05:38:53,336 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction): Матрица скоров (shape (2, 118310)), метод: weighted_average
2025-05-21 05:38:53,341 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction, метод: weighted_average): Используемые веса: {'transaction_vae_price': 1.0, 'category_price_outlier_model': 1.0}, массив весов: [1. 1.]
2025-05-21 05:38:53,342 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction, метод: weighted_average): Распределение combined_scores: Min=0.0001, Max=0.9528, Mean=0.0091
2025-05-21 05:38:53,366 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'transaction' завершен. Добавлен столбец 'transaction_score' и индивидуальные скоры детекторов.
2025-05-21 05:38:53,367 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: behavior...
2025-05-21 05:38:53,476 - backend.ml_service.multilevel_detector - INFO - Детектор 'graph_graph_analysis' типа GraphAnomalyDetector получит оригинальные данные, а не агрегированные
2025-05-21 05:38:53,477 - backend.ml_service.multilevel_detector - INFO - Уровень 'behavior': Запуск детектора 'graph_graph_analysis'...
2025-05-21 05:38:53,497 - backend.ml_service.graph_detector - INFO - Построение графа...
2025-05-21 05:38:57,735 - backend.ml_service.graph_detector - INFO - Граф построен за 4.17 сек. Узлов: 346028, Ребер: 436616
2025-05-21 05:38:57,789 - backend.ml_service.graph_detector - INFO - Расчет графовых аномальных скоров для 112650 узлов OrderItem...
2025-05-21 05:38:59,377 - backend.ml_service.graph_detector - INFO - Детектор graph_graph_analysis: обнаружено 0 аномалий из 118310 (112650 обработано графом)
2025-05-21 05:38:59,428 - backend.ml_service.multilevel_detector - INFO - Детектор 'graph_graph_analysis' обработан. Распределение нормализованных скоров: Min=0.0000, Max=0.6667, Mean=0.1571
2025-05-21 05:38:59,428 - backend.ml_service.multilevel_detector - INFO - Уровень 'behavior': Запуск детектора 'seller_pricing_behavior_model'...
2025-05-21 05:38:59,432 - backend.ml_service.behavior_detectors - INFO - Детектор seller_pricing_behavior_model: обнаружено 389 аномалий из 3095 продавцов
2025-05-21 05:38:59,442 - backend.ml_service.multilevel_detector - INFO - Детектор 'seller_pricing_behavior_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0644
2025-05-21 05:38:59,443 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior): Матрица скоров (shape (2, 3095)), метод: weighted_average
2025-05-21 05:38:59,444 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior, метод: weighted_average): Используемые веса: {'graph_graph_analysis': 1.0, 'seller_pricing_behavior_model': 1.0}, массив весов: [1. 1.]
2025-05-21 05:38:59,444 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior, метод: weighted_average): Распределение combined_scores: Min=0.0000, Max=0.5785, Mean=0.1108
2025-05-21 05:38:59,446 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'behavior' завершен. Добавлен столбец 'behavior_score' и индивидуальные скоры детекторов.
2025-05-21 05:38:59,586 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: time_series...
2025-05-21 05:38:59,666 - backend.ml_service.multilevel_detector - INFO - Уровень 'time_series': Запуск детектора 'seasonal_deviation_model'...
2025-05-21 05:38:59,670 - backend.ml_service.time_series_detectors - INFO - Детектор seasonal_deviation_model: обнаружено 160 аномалий из 616 временных точек
2025-05-21 05:38:59,670 - backend.ml_service.multilevel_detector - INFO - Детектор 'seasonal_deviation_model' обработан. Распределение нормализованных скоров: Min=0.0012, Max=1.0000, Mean=0.6384
2025-05-21 05:38:59,670 - backend.ml_service.multilevel_detector - INFO - Уровень 'time_series': Запуск детектора 'cumulative_sum_model'...
2025-05-21 05:38:59,699 - backend.ml_service.time_series_detectors - INFO - Детектор cumulative_sum_model: обнаружено 614 аномалий из 616 временных точек
2025-05-21 05:38:59,700 - backend.ml_service.multilevel_detector - INFO - Детектор 'cumulative_sum_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.3781
2025-05-21 05:38:59,701 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: time_series): Матрица скоров (shape (2, 616)), метод: average
2025-05-21 05:38:59,701 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: time_series, метод: average): Распределение combined_scores: Min=0.0298, Max=1.0000, Mean=0.5082
2025-05-21 05:38:59,702 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'time_series' завершен. Добавлен столбец 'time_series_score' и индивидуальные скоры детекторов.
2025-05-21 05:38:59,734 - backend.ml_service.multilevel_detector - INFO - Слияние временных данных: result_df имеет 118310 строк, 616 уникальных дат
2025-05-21 05:38:59,735 - backend.ml_service.multilevel_detector - INFO - Слияние временных данных: ts_scores_to_merge имеет 616 строк, 616 уникальных дат
2025-05-21 05:38:59,802 - backend.ml_service.multilevel_detector - DEBUG - Распределение transaction_level_score: Min=0.0001, Max=0.9528, Mean=0.0091
2025-05-21 05:38:59,803 - backend.ml_service.multilevel_detector - DEBUG - Распределение behavior_level_score: Min=0.0000, Max=0.5785, Mean=0.1589
2025-05-21 05:38:59,804 - backend.ml_service.multilevel_detector - DEBUG - Распределение time_series_level_score: Min=0.0298, Max=1.0000, Mean=0.5518
2025-05-21 05:38:59,804 - backend.ml_service.multilevel_detector - INFO - Расчет итогового многоуровневого скора...
2025-05-21 05:38:59,806 - backend.ml_service.multilevel_detector - DEBUG - Распределение multilevel_score (перед порогом): Min=0.0119, Max=0.6089, Mean=0.2169
2025-05-21 05:38:59,807 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8307, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,807 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:38:59,808 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-29 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,809 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-29 00:00:00
2025-05-21 05:38:59,811 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
583 2018-07-29          188      32085.4  145.842727             150               188               2018-07-29  35787.032857         0.896565           0.879612                           0.830683                       0.928541    2018-07-29
2025-05-21 05:38:59,812 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}]
2025-05-21 05:38:59,812 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,812 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.8306826658975347, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}]
2025-05-21 05:38:59,812 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9285, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,813 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:38:59,813 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-29 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,814 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-29 00:00:00
2025-05-21 05:38:59,816 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
583 2018-07-29          188      32085.4  145.842727             150               188               2018-07-29  35787.032857         0.896565           0.879612                           0.830683                       0.928541    2018-07-29
2025-05-21 05:38:59,817 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-07-29 00:00:00", "current_value": 32085.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 28389.394285714287, "deviation_in_std": 6.991176294646339, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (32085.40) отклоняется от базовой линии (3696.01) на 28389.39, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:38:59,817 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,817 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.8306826658975347, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.928540895759355, "explanation": {"detector_specific_info": {"date": "2018-07-29 00:00:00", "current_value": 32085.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 28389.394285714287, "deviation_in_std": 6.991176294646339, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (32085.40) отклоняется от базовой линии (3696.01) на 28389.39, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:38:59,818 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,818 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:38:59,818 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,819 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-03 00:00:00
2025-05-21 05:38:59,821 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales  avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
588 2018-08-03          314     45036.63  125.10175             216               314               2018-08-03  39138.992857         1.150684           0.972436                                1.0                       0.944872    2018-08-03
2025-05-21 05:38:59,822 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:38:59,822 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,822 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:38:59,822 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9449, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,823 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:38:59,824 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,825 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-03 00:00:00
2025-05-21 05:38:59,826 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales  avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
588 2018-08-03          314     45036.63  125.10175             216               314               2018-08-03  39138.992857         1.150684           0.972436                                1.0                       0.944872    2018-08-03
2025-05-21 05:38:59,827 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-03 00:00:00", "current_value": 45036.63, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 41340.624285714286, "deviation_in_std": 10.18054804563417, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (45036.63) отклоняется от базовой линии (3696.01) на 41340.62, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:38:59,827 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,827 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9448723295452219, "explanation": {"detector_specific_info": {"date": "2018-08-03 00:00:00", "current_value": 45036.63, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 41340.624285714286, "deviation_in_std": 10.18054804563417, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (45036.63) отклоняется от базовой линии (3696.01) на 41340.62, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:38:59,828 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,828 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:38:59,828 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,830 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-03 00:00:00
2025-05-21 05:38:59,832 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
527 2018-06-03          191      31535.8  137.112174             149               191               2018-06-03  27063.432857         1.165255           0.903771                                1.0                       0.807541    2018-06-03
2025-05-21 05:38:59,832 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}]
2025-05-21 05:38:59,833 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,833 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}]
2025-05-21 05:38:59,833 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8075, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,833 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:38:59,834 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,834 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-03 00:00:00
2025-05-21 05:38:59,836 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
527 2018-06-03          191      31535.8  137.112174             149               191               2018-06-03  27063.432857         1.165255           0.903771                                1.0                       0.807541    2018-06-03
2025-05-21 05:38:59,837 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-03 00:00:00", "current_value": 31535.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 27839.794285714284, "deviation_in_std": 6.855831720089102, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (31535.80) отклоняется от базовой линии (3696.01) на 27839.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:38:59,837 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,838 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8075414451585549, "explanation": {"detector_specific_info": {"date": "2018-06-03 00:00:00", "current_value": 31535.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 27839.794285714284, "deviation_in_std": 6.855831720089102, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (31535.80) отклоняется от базовой линии (3696.01) на 27839.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:38:59,838 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 26323, order_id: 0812eb902a67711a1cb742b3cdaa65ae, level: transaction): Detector Column: 'trans_transaction_vae_price_score', Score: 0.9056, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,839 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'transaction_vae_price': TransactionVAEDetector
2025-05-21 05:38:59,845 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'transaction_vae_price':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id  product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
26323              1  0812eb902a67711a1cb742b3cdaa65ae  489ae2aa008f021502940f251d4cce7f  e3b4998c7a498169dc7bce44e6bb6277  6735.0         194.31      2017-02-12 20:37:36  c6e2731c5b391845f6800c97401a43a9  utilidades_domesticas                 31.0                       875.0                 2.0           30000.0               60.0               61.0              33.0                    housewares             MS           SP  credit_card                   8.0        6929.31           5.0                           74.309637                0.028851                 0.952814                    True                           0.905628                                       1.0              0.398596                False                           0.15721                                   0.639983                 0.189451                           0.367431                        0.01147                   False           0.55754        True                       None
2025-05-21 05:38:59,845 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Метод get_explanation_details не реализован специфично, будет использована реализация get_shap_explanations (если есть).
2025-05-21 05:38:59,847 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:38:59,847 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:38:59,847 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:38:59,847 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:38:59,847 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:38:59,848 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Вычисление SHAP values для 1 экземпляров...
2025-05-21 05:38:59,848 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Используется nsamples=50 для SHAP
2025-05-21 05:38:59,848 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Запрос SHAP объяснений: explainer=True, background_data_exists=True, model=True
2025-05-21 05:38:59,849 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Создание GradientExplainer с размерами данных: torch.Size([50, 4])
2025-05-21 05:38:59,869 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw type: <class 'numpy.ndarray'>
2025-05-21 05:38:59,870 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw (ndarray) shape: (1, 4, 1)
2025-05-21 05:38:59,870 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно создан и вычислены SHAP-значения
2025-05-21 05:38:59,870 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values_raw уже является ndarray, shape: (1, 4, 1)
2025-05-21 05:38:59,870 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Начальная форма shap_values_arr: (1, 4, 1), ndim: 3
2025-05-21 05:38:59,870 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values после squeeze(-1): (1, 4)
2025-05-21 05:38:59,870 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP values успешно вычислены для 1 экземпляров.
2025-05-21 05:38:59,871 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'transaction_vae_price': [{"shap_values": {"price": 39.15011741758414, "freight_value": -1.7362831402362227, "product_weight_g": 2.6452314525469465, "freight_to_price_ratio": -0.4616639509157062}}]
2025-05-21 05:38:59,871 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'transaction_vae_price' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,871 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.9056284560588397, "explanation": {"shap_values": {"price": 39.15011741758414, "freight_value": -1.7362831402362227, "product_weight_g": 2.6452314525469465, "freight_to_price_ratio": -0.4616639509157062}}}]
2025-05-21 05:38:59,871 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 26323, order_id: 0812eb902a67711a1cb742b3cdaa65ae, level: transaction): Detector Column: 'trans_category_price_outlier_model_score', Score: 1.0000, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,872 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'category_price_outlier_model': CategoryPriceOutlierDetector
2025-05-21 05:38:59,877 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'category_price_outlier_model':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id  product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
26323              1  0812eb902a67711a1cb742b3cdaa65ae  489ae2aa008f021502940f251d4cce7f  e3b4998c7a498169dc7bce44e6bb6277  6735.0         194.31      2017-02-12 20:37:36  c6e2731c5b391845f6800c97401a43a9  utilidades_domesticas                 31.0                       875.0                 2.0           30000.0               60.0               61.0              33.0                    housewares             MS           SP  credit_card                   8.0        6929.31           5.0                           74.309637                0.028851                 0.952814                    True                           0.905628                                       1.0              0.398596                False                           0.15721                                   0.639983                 0.189451                           0.367431                        0.01147                   False           0.55754        True                       None
2025-05-21 05:38:59,878 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'category_price_outlier_model': [{"detector_specific_info": {"category": "utilidades_domesticas", "price": 6735.0, "category_mean_price": 90.63427371273713, "category_std_price": 140.19371115720259, "category_min_price": 3.06, "category_max_price": 6735.0, "category_count": 7380, "z_score": 47.394178179909765, "threshold": 2.8, "explanation": "Цена 6735.00 отличается от средней цены в категории 'utilidades_domesticas' (90.63) на 47.39 стандартных отклонений (порог: 2.8)."}}]
2025-05-21 05:38:59,878 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'category_price_outlier_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,879 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.9056284560588397, "explanation": {"shap_values": {"price": 39.15011741758414, "freight_value": -1.7362831402362227, "product_weight_g": 2.6452314525469465, "freight_to_price_ratio": -0.4616639509157062}}}, {"detector_name": "category_price_outlier_model", "detector_type": "CategoryPriceOutlierDetector", "score": 1.0, "explanation": {"detector_specific_info": {"category": "utilidades_domesticas", "price": 6735.0, "category_mean_price": 90.63427371273713, "category_std_price": 140.19371115720259, "category_min_price": 3.06, "category_max_price": 6735.0, "category_count": 7380, "z_score": 47.394178179909765, "threshold": 2.8, "explanation": "Цена 6735.00 отличается от средней цены в категории 'utilidades_domesticas' (90.63) на 47.39 стандартных отклонений (порог: 2.8)."}}}]
2025-05-21 05:38:59,879 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,879 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:38:59,880 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-25 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,880 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-25 00:00:00
2025-05-21 05:38:59,882 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
579 2018-07-25          268     40753.19  122.750572             201               268               2018-07-25  35288.758571         1.154849           0.959618                                1.0                       0.919235    2018-07-25
2025-05-21 05:38:59,883 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:38:59,883 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,883 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:38:59,884 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9192, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,884 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:38:59,884 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-25 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,885 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-25 00:00:00
2025-05-21 05:38:59,887 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
579 2018-07-25          268     40753.19  122.750572             201               268               2018-07-25  35288.758571         1.154849           0.959618                                1.0                       0.919235    2018-07-25
2025-05-21 05:38:59,888 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-07-25 00:00:00", "current_value": 40753.19, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37057.18428571429, "deviation_in_std": 9.125707498979427, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (40753.19) отклоняется от базовой линии (3696.01) на 37057.18, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:38:59,888 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,888 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9192352183494302, "explanation": {"detector_specific_info": {"date": "2018-07-25 00:00:00", "current_value": 40753.19, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37057.18428571429, "deviation_in_std": 9.125707498979427, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (40753.19) отклоняется от базовой линии (3696.01) на 37057.18, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:38:59,889 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 42860, order_id: 90674f59a21207f91a7387785c66f340, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,889 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:38:59,889 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-14 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,890 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-14 00:00:00
2025-05-21 05:38:59,892 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
599 2018-08-14          315     44682.42  128.397759             228               315               2018-08-14  37562.228571         1.189557           0.989198                                1.0                       0.978396    2018-08-14
2025-05-21 05:38:59,893 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:38:59,893 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,893 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:38:59,894 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 42860, order_id: 90674f59a21207f91a7387785c66f340, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9784, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,894 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:38:59,894 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-14 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,895 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-14 00:00:00
2025-05-21 05:38:59,897 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
599 2018-08-14          315     44682.42  128.397759             228               315               2018-08-14  37562.228571         1.189557           0.989198                                1.0                       0.978396    2018-08-14
2025-05-21 05:38:59,897 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-14 00:00:00", "current_value": 44682.42, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 40986.41428571429, "deviation_in_std": 10.093320240405061, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (44682.42) отклоняется от базовой линии (3696.01) на 40986.41, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:38:59,897 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,898 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9783962277530719, "explanation": {"detector_specific_info": {"date": "2018-08-14 00:00:00", "current_value": 44682.42, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 40986.41428571429, "deviation_in_std": 10.093320240405061, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (44682.42) отклоняется от базовой линии (3696.01) на 40986.41, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:38:59,898 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: transaction): Detector Column: 'trans_transaction_vae_price_score', Score: 1.0000, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,898 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'transaction_vae_price': TransactionVAEDetector
2025-05-21 05:38:59,905 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'transaction_vae_price':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
57579              1  3dd5626c63f493f8b8f8788c2be24baa  3a1855685a49813f60e6193864f7215e  c510bc1718f0f2961eaa42a23330681a  2699.0         306.06      2018-04-27 19:50:43  a8f345f82667eb421151dc7626147636                 bebes                 54.0                      2583.0                10.0           11450.0               57.0               78.0              44.0                          baby             SC           SP  credit_card                  10.0        3005.06           5.0                           19.887203                0.113398                 0.620279                    True                                1.0                                  0.240557              0.379093                False                          0.147594                                   0.610592                 0.823398                           0.928073                       0.718724                    True          0.608859        True                       None
2025-05-21 05:38:59,905 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Метод get_explanation_details не реализован специфично, будет использована реализация get_shap_explanations (если есть).
2025-05-21 05:38:59,907 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:38:59,907 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:38:59,907 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:38:59,908 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:38:59,908 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:38:59,908 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Вычисление SHAP values для 1 экземпляров...
2025-05-21 05:38:59,908 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Используется nsamples=50 для SHAP
2025-05-21 05:38:59,909 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Запрос SHAP объяснений: explainer=True, background_data_exists=True, model=True
2025-05-21 05:38:59,909 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Создание GradientExplainer с размерами данных: torch.Size([50, 4])
2025-05-21 05:38:59,927 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw type: <class 'numpy.ndarray'>
2025-05-21 05:38:59,928 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw (ndarray) shape: (1, 4, 1)
2025-05-21 05:38:59,928 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно создан и вычислены SHAP-значения
2025-05-21 05:38:59,928 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values_raw уже является ndarray, shape: (1, 4, 1)
2025-05-21 05:38:59,928 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Начальная форма shap_values_arr: (1, 4, 1), ndim: 3
2025-05-21 05:38:59,929 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values после squeeze(-1): (1, 4)
2025-05-21 05:38:59,929 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP values успешно вычислены для 1 экземпляров.
2025-05-21 05:38:59,929 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'transaction_vae_price': [{"shap_values": {"price": 70.18071629447351, "freight_value": -21.660869025693486, "product_weight_g": -5.83936874895316, "freight_to_price_ratio": 2.840124461754637}}]
2025-05-21 05:38:59,929 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'transaction_vae_price' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,930 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 1.0, "explanation": {"shap_values": {"price": 70.18071629447351, "freight_value": -21.660869025693486, "product_weight_g": -5.83936874895316, "freight_to_price_ratio": 2.840124461754637}}}]
2025-05-21 05:38:59,930 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: transaction): Detector Column: 'trans_category_price_outlier_model_score', Score: 0.2406, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,930 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'category_price_outlier_model': CategoryPriceOutlierDetector
2025-05-21 05:38:59,936 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'category_price_outlier_model':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
57579              1  3dd5626c63f493f8b8f8788c2be24baa  3a1855685a49813f60e6193864f7215e  c510bc1718f0f2961eaa42a23330681a  2699.0         306.06      2018-04-27 19:50:43  a8f345f82667eb421151dc7626147636                 bebes                 54.0                      2583.0                10.0           11450.0               57.0               78.0              44.0                          baby             SC           SP  credit_card                  10.0        3005.06           5.0                           19.887203                0.113398                 0.620279                    True                                1.0                                  0.240557              0.379093                False                          0.147594                                   0.610592                 0.823398                           0.928073                       0.718724                    True          0.608859        True                       None
2025-05-21 05:38:59,937 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'category_price_outlier_model': [{"detector_specific_info": {"category": "bebes", "price": 2699.0, "category_mean_price": 135.71541510611735, "category_std_price": 224.82969338108902, "category_min_price": 3.54, "category_max_price": 3899.0, "category_count": 3204, "z_score": 11.401005562681993, "threshold": 2.8, "explanation": "Цена 2699.00 отличается от средней цены в категории 'bebes' (135.72) на 11.40 стандартных отклонений (порог: 2.8)."}}]
2025-05-21 05:38:59,937 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'category_price_outlier_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,937 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 1.0, "explanation": {"shap_values": {"price": 70.18071629447351, "freight_value": -21.660869025693486, "product_weight_g": -5.83936874895316, "freight_to_price_ratio": 2.840124461754637}}}, {"detector_name": "category_price_outlier_model", "detector_type": "CategoryPriceOutlierDetector", "score": 0.24055704531923383, "explanation": {"detector_specific_info": {"category": "bebes", "price": 2699.0, "category_mean_price": 135.71541510611735, "category_std_price": 224.82969338108902, "category_min_price": 3.54, "category_max_price": 3899.0, "category_count": 3204, "z_score": 11.401005562681993, "threshold": 2.8, "explanation": "Цена 2699.00 отличается от средней цены в категории 'bebes' (135.72) на 11.40 стандартных отклонений (порог: 2.8)."}}}]
2025-05-21 05:38:59,937 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.9281, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,938 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:38:59,938 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-04-27 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,939 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-04-27 00:00:00
2025-05-21 05:38:59,940 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
490 2018-04-27          242     41231.39  140.242823             165               242               2018-04-27  35298.295714         1.168084           0.823398                           0.928073                       0.718724    2018-04-27
2025-05-21 05:38:59,941 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:38:59,941 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,941 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9280726698190791, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:38:59,941 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.7187, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,941 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:38:59,942 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-04-27 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,943 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-04-27 00:00:00
2025-05-21 05:38:59,945 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
490 2018-04-27          242     41231.39  140.242823             165               242               2018-04-27  35298.295714         1.168084           0.823398                           0.928073                       0.718724    2018-04-27
2025-05-21 05:38:59,945 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-04-27 00:00:00", "current_value": 41231.39, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37535.38428571429, "deviation_in_std": 9.243469099331083, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (41231.39) отклоняется от базовой линии (3696.01) на 37535.38, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:38:59,945 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,946 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9280726698190791, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.718723936134046, "explanation": {"detector_specific_info": {"date": "2018-04-27 00:00:00", "current_value": 41231.39, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37535.38428571429, "deviation_in_std": 9.243469099331083, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (41231.39) отклоняется от базовой линии (3696.01) на 37535.38, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:38:59,946 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 74778, order_id: 94fca82966c05ba707f4e7dc0c50aa3c, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,946 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:38:59,946 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,947 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:38:59,949 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:38:59,950 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:38:59,950 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,950 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:38:59,950 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 74778, order_id: 94fca82966c05ba707f4e7dc0c50aa3c, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9819, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,951 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:38:59,951 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,952 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:38:59,954 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:38:59,954 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:38:59,954 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,955 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9819435388597458, "explanation": {"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:38:59,955 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 75482, order_id: 4160b6447ad70e6d73f7221dd970bbe9, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,955 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:38:59,955 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,956 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:38:59,958 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:38:59,959 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:38:59,959 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,959 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:38:59,959 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 75482, order_id: 4160b6447ad70e6d73f7221dd970bbe9, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9819, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,959 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:38:59,960 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,961 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:38:59,963 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:38:59,964 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:38:59,964 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,964 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9819435388597458, "explanation": {"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:38:59,965 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.9481, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,965 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:38:59,965 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-01-26 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,966 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-01-26 00:00:00
2025-05-21 05:38:59,968 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
399 2018-01-26          228     34533.35  125.575818             151               228               2018-01-26       31895.5         1.082703           0.722093                           0.948138                       0.496047    2018-01-26
2025-05-21 05:38:59,968 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:38:59,969 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,969 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9481383115297547, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:38:59,969 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.4960, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,969 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:38:59,970 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-01-26 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,971 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-01-26 00:00:00
2025-05-21 05:38:59,973 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
399 2018-01-26          228     34533.35  125.575818             151               228               2018-01-26       31895.5         1.082703           0.722093                           0.948138                       0.496047    2018-01-26
2025-05-21 05:38:59,973 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-01-26 00:00:00", "current_value": 34533.35, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 30837.344285714284, "deviation_in_std": 7.594008811544785, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34533.35) отклоняется от базовой линии (3696.01) на 30837.34, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:38:59,973 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,973 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9481383115297547, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.496047165599019, "explanation": {"detector_specific_info": {"date": "2018-01-26 00:00:00", "current_value": 34533.35, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 30837.344285714284, "deviation_in_std": 7.594008811544785, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34533.35) отклоняется от базовой линии (3696.01) на 30837.34, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:38:59,974 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87594, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8164, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,974 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:38:59,974 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,975 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:38:59,977 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:38:59,978 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:38:59,978 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,978 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:38:59,978 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87594, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8123, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,979 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:38:59,979 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,980 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:38:59,981 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:38:59,982 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:38:59,982 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,982 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8122690239748033, "explanation": {"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:38:59,983 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87595, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8164, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,983 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:38:59,983 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,984 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:38:59,986 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:38:59,987 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:38:59,987 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,987 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:38:59,987 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87595, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8123, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,987 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:38:59,987 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,988 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:38:59,991 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:38:59,992 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:38:59,992 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,992 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8122690239748033, "explanation": {"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:38:59,993 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,993 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:38:59,993 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-03-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,994 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-03-15 00:00:00
2025-05-21 05:38:59,996 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
447 2018-03-15          286      46096.4  135.180059             174               286               2018-03-15  32494.021429         1.418612           0.804803                                1.0                       0.609605    2018-03-15
2025-05-21 05:38:59,997 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}]
2025-05-21 05:38:59,997 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:38:59,997 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}}]
2025-05-21 05:38:59,997 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.6096, Threshold: 0, Passes Threshold: True
2025-05-21 05:38:59,998 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:38:59,998 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-03-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:38:59,999 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-03-15 00:00:00
2025-05-21 05:39:00,001 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
447 2018-03-15          286      46096.4  135.180059             174               286               2018-03-15  32494.021429         1.418612           0.804803                                1.0                       0.609605    2018-03-15
2025-05-21 05:39:00,001 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-03-15 00:00:00", "current_value": 46096.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42400.39428571429, "deviation_in_std": 10.441527157312704, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46096.40) отклоняется от базовой линии (3696.01) на 42400.39, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:39:00,001 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:39:00,001 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.609605020859105, "explanation": {"detector_specific_info": {"date": "2018-03-15 00:00:00", "current_value": 46096.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42400.39428571429, "deviation_in_std": 10.441527157312704, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46096.40) отклоняется от базовой линии (3696.01) на 42400.39, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:39:00,003 - backend.ml_service.multilevel_detector - INFO - Сгенерированы объяснения для 13 из 13 аномалий
2025-05-21 05:39:00,004 - backend.ml_service.multilevel_detector - INFO - Многоуровневая детекция завершена. Обнаружено 13 аномалий.
2025-05-21 05:39:00,020 - backend.ml_service.multilevel_service - INFO - Обнаружено 13 multilevel аномалий до сохранения.
2025-05-21 05:39:00,020 - backend.ml_service.multilevel_service - INFO - Начало сохранения multilevel аномалий в БД...
2025-05-21 05:39:00,087 - backend.ml_service.multilevel_service - INFO - Статистика сохранения multilevel аномалий: {'total_detected_anomalies_before_save': 13, 'newly_saved_anomalies_count': 12, 'newly_saved_anomaly_ids': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], 'skipped_duplicates_count': 1, 'errors_on_save': 0}
2025-05-21 05:39:00,088 - backend.ml_service.multilevel_service - DEBUG - Сессия БД (db_for_crud) для multilevel detect закрыта.
2025-05-21 05:39:00,088 - backend.ml_service.multilevel_service - DEBUG - Сессия БД (db_for_load_detect) для multilevel detect закрыта.
2025-05-21 05:39:00,116 - backend.ml_service.multilevel_service - INFO - [TaskID: 899442d1-abc2-41c7-85a9-f011fbfaa0ac] Детекция и сохранение аномалий успешно завершены.
2025-05-21 05:43:14,171 - backend.ml_service - INFO - Логирование настроено с уровнем DEBUG
2025-05-21 05:43:14,171 - backend.ml_service - INFO - Логи записываются в файл: C:\Users\alex\Desktop\AnomaLens3.0\logs\ml_service_2025-05-21.log
2025-05-21 05:43:16,796 - backend.ml_service.multilevel_service - INFO - Базовый путь для моделей (MultilevelService): C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models
2025-05-21 05:43:16,796 - backend.ml_service.multilevel_service - INFO - Создание/инициализация многоуровневой системы на основе настроек из config.yaml.
2025-05-21 05:43:16,796 - backend.ml_service.multilevel_service - DEBUG - Используется следующая конфигурация для MultilevelAnomalyDetector: {
  "transaction_level": [
    {
      "type": "transaction_vae",
      "model_filename": "ml_trans_vae_model.joblib",
      "weight": 1.0,
      "features": [
        "price",
        "freight_value",
        "product_weight_g",
        "freight_to_price_ratio"
      ],
      "encoding_dim": 10,
      "hidden_dim1": 32,
      "hidden_dim2": 16,
      "epochs": 25,
      "kld_weight": 0.5,
      "dropout_rate": 0.1,
      "shap_background_samples": 50
    },
    {
      "type": "category_price_outlier",
      "model_filename": "ml_category_price_model.joblib",
      "weight": 1.0,
      "category_col": "product_category_name",
      "price_col": "price",
      "threshold": 2.8,
      "min_samples_per_category": 10
    }
  ],
  "behavior_level": [
    {
      "type": "graph",
      "model_filename": "ml_graph_model_v3.joblib",
      "weight": 1.0,
      "use_seller_state_spread": true,
      "use_category_diversity": true,
      "use_seller_degree": true,
      "seller_state_weight": 0.3,
      "category_diversity_weight": 0.4,
      "seller_degree_weight": 0.3
    },
    {
      "type": "seller_pricing_behavior",
      "model_filename": "ml_seller_pricing_model.joblib",
      "weight": 1.0,
      "volatility_threshold": 0.5,
      "range_threshold": 5.0,
      "freight_ratio_threshold": 1.0,
      "min_transactions": 5
    }
  ],
  "time_series_level": [
    {
      "type": "seasonal_deviation",
      "model_filename": "seasonal_deviation_model.joblib",
      "weight": 1.0,
      "window_size": 7,
      "threshold": 2.5
    },
    {
      "type": "cumulative_sum",
      "model_filename": "cumulative_sum_model.joblib",
      "weight": 1.0,
      "window_size": 14,
      "threshold": 2.5,
      "drift_threshold": 4.5
    }
  ],
  "combination_weights": {
    "transaction": 0.4,
    "behavior": 0.3,
    "time_series": 0.3
  },
  "transaction_level_combination_method": "weighted_average",
  "behavior_level_combination_method": "weighted_average",
  "time_series_level_combination_method": "average"
}
2025-05-21 05:43:16,797 - backend.ml_service.multilevel_detector - INFO - Инициализация многоуровневой системы обнаружения аномалий...
2025-05-21 05:43:16,797 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'transaction'...
2025-05-21 05:43:16,797 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) VAEDetector инициализирован. Устройство: cpu, Входная размерность: 4, Признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio']
2025-05-21 05:43:16,798 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Сброс базового состояния детектора (из AnomalyDetector._reset_state).
2025-05-21 05:43:16,798 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Специфичное состояние VAEDetector (порог, SHAP) сброшено.
2025-05-21 05:43:16,798 - backend.ml_service.transaction_detectors - INFO - (transaction_vae_price) TransactionVAEDetector инициализирован. Конфигурационные признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], Реально используемые признаки (с генерируемыми): ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], encoding_dim(latent_dim): 10, hidden_dim1(hidden_dim): 32, hidden_dim2: 16, epochs: 25, batch_size: 64, lr: 0.001, kld_w: 0.5, dropout: 0.1
2025-05-21 05:43:16,798 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора transaction_vae_price типа transaction_vae
2025-05-21 05:43:16,798 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_trans_vae_model.joblib' установлен для transaction_vae_price
2025-05-21 05:43:16,798 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib'
2025-05-21 05:43:16,798 - backend.ml_service.detector - INFO - Попытка загрузки модели transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib...
2025-05-21 05:43:16,808 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Загружен порог аномальности: 3.656726
2025-05-21 05:43:16,808 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler успешно инициализирован с параметрами: n_features_in_=4, mean_=(4,), scale_=(4,)
2025-05-21 05:43:16,808 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Фоновые данные SHAP загружены (torch.Size([50, 4]))
2025-05-21 05:43:16,811 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Модель VAE успешно загружена и перемещена на cpu.
2025-05-21 05:43:16,812 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Попытка пересоздания SHAP GradientExplainer после загрузки...
2025-05-21 05:43:16,816 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно ПЕРЕСОЗДАН при загрузке модели. Device=cpu, background_data.shape=torch.Size([50, 4])
2025-05-21 05:43:16,816 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Статус SHAP после загрузки: background_data shape=torch.Size([50, 4]), device=cpu, explainer=создан
2025-05-21 05:43:16,817 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детектор VAE (is_trained=True) успешно загружен.
2025-05-21 05:43:16,817 - backend.ml_service.detector - INFO - Модель transaction_vae_price успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib. is_trained=True
2025-05-21 05:43:16,817 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib
2025-05-21 05:43:16,817 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib.
2025-05-21 05:43:16,818 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) инициализирован с весом 1.0.
2025-05-21 05:43:16,818 - backend.ml_service.transaction_detectors - INFO - CategoryPriceOutlierDetector 'category_price_outlier_model' инициализирован с параметрами: category_col='product_category_name', price_col='price', threshold=2.8, min_samples_per_category=10
2025-05-21 05:43:16,818 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора category_price_outlier_model типа category_price_outlier
2025-05-21 05:43:16,818 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_category_price_model.joblib' установлен для category_price_outlier_model
2025-05-21 05:43:16,819 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib'
2025-05-21 05:43:16,819 - backend.ml_service.detector - INFO - Попытка загрузки модели category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib...
2025-05-21 05:43:16,821 - backend.ml_service.detector - INFO - Модель category_price_outlier_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib. is_trained=True
2025-05-21 05:43:16,821 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib
2025-05-21 05:43:16,821 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib.
2025-05-21 05:43:16,821 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) инициализирован с весом 1.0.
2025-05-21 05:43:16,821 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'behavior'...
2025-05-21 05:43:16,822 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора graph_graph_analysis типа graph
2025-05-21 05:43:16,822 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_graph_model_v3.joblib' установлен для graph_graph_analysis
2025-05-21 05:43:16,822 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib'
2025-05-21 05:43:16,822 - backend.ml_service.detector - INFO - Попытка загрузки модели graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib...
2025-05-21 05:43:16,823 - backend.ml_service.detector - INFO - Модель graph_graph_analysis успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib. is_trained=True
2025-05-21 05:43:16,823 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib
2025-05-21 05:43:16,823 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib.
2025-05-21 05:43:16,823 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) инициализирован с весом 1.0.
2025-05-21 05:43:16,824 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seller_pricing_behavior_model типа seller_pricing_behavior
2025-05-21 05:43:16,824 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_seller_pricing_model.joblib' установлен для seller_pricing_behavior_model
2025-05-21 05:43:16,824 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib'
2025-05-21 05:43:16,824 - backend.ml_service.detector - INFO - Попытка загрузки модели seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib...
2025-05-21 05:43:16,825 - backend.ml_service.detector - INFO - Модель seller_pricing_behavior_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib. is_trained=True
2025-05-21 05:43:16,825 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib
2025-05-21 05:43:16,825 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib.
2025-05-21 05:43:16,826 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) инициализирован с весом 1.0.
2025-05-21 05:43:16,826 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'time_series'...
2025-05-21 05:43:16,826 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seasonal_deviation_model типа seasonal_deviation
2025-05-21 05:43:16,826 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='seasonal_deviation_model.joblib' установлен для seasonal_deviation_model
2025-05-21 05:43:16,826 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib'
2025-05-21 05:43:16,826 - backend.ml_service.detector - INFO - Попытка загрузки модели seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib...
2025-05-21 05:43:16,827 - backend.ml_service.detector - INFO - Модель seasonal_deviation_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib. is_trained=True
2025-05-21 05:43:16,827 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib
2025-05-21 05:43:16,827 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib.
2025-05-21 05:43:16,828 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) инициализирован с весом 1.0.
2025-05-21 05:43:16,828 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора cumulative_sum_model типа cumulative_sum
2025-05-21 05:43:16,828 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='cumulative_sum_model.joblib' установлен для cumulative_sum_model
2025-05-21 05:43:16,828 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib'
2025-05-21 05:43:16,828 - backend.ml_service.detector - INFO - Попытка загрузки модели cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib...
2025-05-21 05:43:16,829 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Загружены baseline_mean=3696.0057142857145, baseline_std=4060.74644512314 из model_state.
2025-05-21 05:43:16,829 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Детектор CUSUM успешно загружен и помечен как обученный.
2025-05-21 05:43:16,829 - backend.ml_service.detector - INFO - Модель cumulative_sum_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib. is_trained=True
2025-05-21 05:43:16,829 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib
2025-05-21 05:43:16,829 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib.
2025-05-21 05:43:16,829 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) инициализирован с весом 1.0.
2025-05-21 05:43:16,829 - backend.ml_service.multilevel_detector - INFO - Многоуровневая система инициализирована: 2 транзакционных детекторов (метод: weighted_average), 2 поведенческих детекторов (метод: weighted_average), 2 детекторов временных рядов (метод: average)
2025-05-21 05:43:16,829 - backend.ml_service.multilevel_service - INFO - Многоуровневая система успешно создана на основе конфигурации из settings.yaml.
2025-05-21 05:43:16,839 - backend.ml_service - INFO - ML Service Logger активен. Уровень: DEBUG. Директория логов ml_service: C:\Users\alex\Desktop\AnomaLens3.0\logs
2025-05-21 05:43:31,031 - backend.ml_service - INFO - Логирование настроено с уровнем DEBUG
2025-05-21 05:43:31,032 - backend.ml_service - INFO - Логи записываются в файл: C:\Users\alex\Desktop\AnomaLens3.0\logs\ml_service_2025-05-21.log
2025-05-21 05:43:33,996 - backend.ml_service.multilevel_service - INFO - Базовый путь для моделей (MultilevelService): C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models
2025-05-21 05:43:33,996 - backend.ml_service.multilevel_service - INFO - Создание/инициализация многоуровневой системы на основе настроек из config.yaml.
2025-05-21 05:43:33,996 - backend.ml_service.multilevel_service - DEBUG - Используется следующая конфигурация для MultilevelAnomalyDetector: {
  "transaction_level": [
    {
      "type": "transaction_vae",
      "model_filename": "ml_trans_vae_model.joblib",
      "weight": 1.0,
      "features": [
        "price",
        "freight_value",
        "product_weight_g",
        "freight_to_price_ratio"
      ],
      "encoding_dim": 10,
      "hidden_dim1": 32,
      "hidden_dim2": 16,
      "epochs": 25,
      "kld_weight": 0.5,
      "dropout_rate": 0.1,
      "shap_background_samples": 50
    },
    {
      "type": "category_price_outlier",
      "model_filename": "ml_category_price_model.joblib",
      "weight": 1.0,
      "category_col": "product_category_name",
      "price_col": "price",
      "threshold": 2.8,
      "min_samples_per_category": 10
    }
  ],
  "behavior_level": [
    {
      "type": "graph",
      "model_filename": "ml_graph_model_v3.joblib",
      "weight": 1.0,
      "use_seller_state_spread": true,
      "use_category_diversity": true,
      "use_seller_degree": true,
      "seller_state_weight": 0.3,
      "category_diversity_weight": 0.4,
      "seller_degree_weight": 0.3
    },
    {
      "type": "seller_pricing_behavior",
      "model_filename": "ml_seller_pricing_model.joblib",
      "weight": 1.0,
      "volatility_threshold": 0.5,
      "range_threshold": 5.0,
      "freight_ratio_threshold": 1.0,
      "min_transactions": 5
    }
  ],
  "time_series_level": [
    {
      "type": "seasonal_deviation",
      "model_filename": "seasonal_deviation_model.joblib",
      "weight": 1.0,
      "window_size": 7,
      "threshold": 2.5
    },
    {
      "type": "cumulative_sum",
      "model_filename": "cumulative_sum_model.joblib",
      "weight": 1.0,
      "window_size": 14,
      "threshold": 2.5,
      "drift_threshold": 4.5
    }
  ],
  "combination_weights": {
    "transaction": 0.4,
    "behavior": 0.3,
    "time_series": 0.3
  },
  "transaction_level_combination_method": "weighted_average",
  "behavior_level_combination_method": "weighted_average",
  "time_series_level_combination_method": "average"
}
2025-05-21 05:43:33,997 - backend.ml_service.multilevel_detector - INFO - Инициализация многоуровневой системы обнаружения аномалий...
2025-05-21 05:43:33,997 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'transaction'...
2025-05-21 05:43:33,997 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) VAEDetector инициализирован. Устройство: cpu, Входная размерность: 4, Признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio']
2025-05-21 05:43:33,998 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Сброс базового состояния детектора (из AnomalyDetector._reset_state).
2025-05-21 05:43:33,998 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Специфичное состояние VAEDetector (порог, SHAP) сброшено.
2025-05-21 05:43:33,998 - backend.ml_service.transaction_detectors - INFO - (transaction_vae_price) TransactionVAEDetector инициализирован. Конфигурационные признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], Реально используемые признаки (с генерируемыми): ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], encoding_dim(latent_dim): 10, hidden_dim1(hidden_dim): 32, hidden_dim2: 16, epochs: 25, batch_size: 64, lr: 0.001, kld_w: 0.5, dropout: 0.1
2025-05-21 05:43:33,998 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора transaction_vae_price типа transaction_vae
2025-05-21 05:43:33,998 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_trans_vae_model.joblib' установлен для transaction_vae_price
2025-05-21 05:43:33,999 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib'
2025-05-21 05:43:33,999 - backend.ml_service.detector - INFO - Попытка загрузки модели transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib...
2025-05-21 05:43:34,009 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Загружен порог аномальности: 3.656726
2025-05-21 05:43:34,010 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler успешно инициализирован с параметрами: n_features_in_=4, mean_=(4,), scale_=(4,)
2025-05-21 05:43:34,010 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Фоновые данные SHAP загружены (torch.Size([50, 4]))
2025-05-21 05:43:34,015 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Модель VAE успешно загружена и перемещена на cpu.
2025-05-21 05:43:34,015 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Попытка пересоздания SHAP GradientExplainer после загрузки...
2025-05-21 05:43:34,021 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно ПЕРЕСОЗДАН при загрузке модели. Device=cpu, background_data.shape=torch.Size([50, 4])
2025-05-21 05:43:34,021 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Статус SHAP после загрузки: background_data shape=torch.Size([50, 4]), device=cpu, explainer=создан
2025-05-21 05:43:34,022 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детектор VAE (is_trained=True) успешно загружен.
2025-05-21 05:43:34,022 - backend.ml_service.detector - INFO - Модель transaction_vae_price успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib. is_trained=True
2025-05-21 05:43:34,022 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib
2025-05-21 05:43:34,022 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib.
2025-05-21 05:43:34,023 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) инициализирован с весом 1.0.
2025-05-21 05:43:34,023 - backend.ml_service.transaction_detectors - INFO - CategoryPriceOutlierDetector 'category_price_outlier_model' инициализирован с параметрами: category_col='product_category_name', price_col='price', threshold=2.8, min_samples_per_category=10
2025-05-21 05:43:34,023 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора category_price_outlier_model типа category_price_outlier
2025-05-21 05:43:34,023 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_category_price_model.joblib' установлен для category_price_outlier_model
2025-05-21 05:43:34,023 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib'
2025-05-21 05:43:34,023 - backend.ml_service.detector - INFO - Попытка загрузки модели category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib...
2025-05-21 05:43:34,025 - backend.ml_service.detector - INFO - Модель category_price_outlier_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib. is_trained=True
2025-05-21 05:43:34,026 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib
2025-05-21 05:43:34,026 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib.
2025-05-21 05:43:34,027 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) инициализирован с весом 1.0.
2025-05-21 05:43:34,027 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'behavior'...
2025-05-21 05:43:34,027 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора graph_graph_analysis типа graph
2025-05-21 05:43:34,027 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_graph_model_v3.joblib' установлен для graph_graph_analysis
2025-05-21 05:43:34,027 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib'
2025-05-21 05:43:34,028 - backend.ml_service.detector - INFO - Попытка загрузки модели graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib...
2025-05-21 05:43:34,028 - backend.ml_service.detector - INFO - Модель graph_graph_analysis успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib. is_trained=True
2025-05-21 05:43:34,028 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib
2025-05-21 05:43:34,028 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib.
2025-05-21 05:43:34,028 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) инициализирован с весом 1.0.
2025-05-21 05:43:34,029 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seller_pricing_behavior_model типа seller_pricing_behavior
2025-05-21 05:43:34,029 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_seller_pricing_model.joblib' установлен для seller_pricing_behavior_model
2025-05-21 05:43:34,029 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib'
2025-05-21 05:43:34,029 - backend.ml_service.detector - INFO - Попытка загрузки модели seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib...
2025-05-21 05:43:34,029 - backend.ml_service.detector - INFO - Модель seller_pricing_behavior_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib. is_trained=True
2025-05-21 05:43:34,030 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib
2025-05-21 05:43:34,030 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib.
2025-05-21 05:43:34,030 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) инициализирован с весом 1.0.
2025-05-21 05:43:34,030 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'time_series'...
2025-05-21 05:43:34,030 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seasonal_deviation_model типа seasonal_deviation
2025-05-21 05:43:34,031 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='seasonal_deviation_model.joblib' установлен для seasonal_deviation_model
2025-05-21 05:43:34,031 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib'
2025-05-21 05:43:34,031 - backend.ml_service.detector - INFO - Попытка загрузки модели seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib...
2025-05-21 05:43:34,032 - backend.ml_service.detector - INFO - Модель seasonal_deviation_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib. is_trained=True
2025-05-21 05:43:34,032 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib
2025-05-21 05:43:34,033 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib.
2025-05-21 05:43:34,033 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) инициализирован с весом 1.0.
2025-05-21 05:43:34,033 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора cumulative_sum_model типа cumulative_sum
2025-05-21 05:43:34,034 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='cumulative_sum_model.joblib' установлен для cumulative_sum_model
2025-05-21 05:43:34,034 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib'
2025-05-21 05:43:34,034 - backend.ml_service.detector - INFO - Попытка загрузки модели cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib...
2025-05-21 05:43:34,035 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Загружены baseline_mean=3696.0057142857145, baseline_std=4060.74644512314 из model_state.
2025-05-21 05:43:34,035 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Детектор CUSUM успешно загружен и помечен как обученный.
2025-05-21 05:43:34,035 - backend.ml_service.detector - INFO - Модель cumulative_sum_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib. is_trained=True
2025-05-21 05:43:34,035 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib
2025-05-21 05:43:34,035 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib.
2025-05-21 05:43:34,035 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) инициализирован с весом 1.0.
2025-05-21 05:43:34,036 - backend.ml_service.multilevel_detector - INFO - Многоуровневая система инициализирована: 2 транзакционных детекторов (метод: weighted_average), 2 поведенческих детекторов (метод: weighted_average), 2 детекторов временных рядов (метод: average)
2025-05-21 05:43:34,036 - backend.ml_service.multilevel_service - INFO - Многоуровневая система успешно создана на основе конфигурации из settings.yaml.
2025-05-21 05:43:34,046 - backend.ml_service - INFO - ML Service Logger активен. Уровень: DEBUG. Директория логов ml_service: C:\Users\alex\Desktop\AnomaLens3.0\logs
2025-05-21 05:43:42,485 - backend.ml_service.multilevel_service - INFO - [TaskID: 29042a7c-136c-4d97-afbd-aae9c2c23661] Обертка detect_async_task_wrapper запущена.
2025-05-21 05:43:42,486 - backend.ml_service.multilevel_service - INFO - Начало обнаружения аномалий (multilevel) с сохранением в БД...
2025-05-21 05:43:42,487 - backend.ml_service.multilevel_service - INFO - Загрузка данных из БД для multilevel detect...
2025-05-21 05:43:42,487 - backend.ml_service.common - INFO - Загрузка данных из БД за период: 1998-01-03 05:43:42.484172 - None (с ассоциациями)
2025-05-21 05:43:46,095 - backend.ml_service.common - INFO - Загружено 118310 записей OrderItem.
2025-05-21 05:43:46,095 - backend.ml_service.multilevel_service - INFO - Данные для multilevel detect (118310 строк) подготовлены. Применение инженерии признаков...
2025-05-21 05:43:46,210 - backend.ml_service.common - INFO - Добавлен признак: 'price_deviation_from_category_mean'
2025-05-21 05:43:46,212 - backend.ml_service.common - INFO - Добавлен признак: 'freight_to_price_ratio'
2025-05-21 05:43:46,212 - backend.ml_service.multilevel_service - INFO - Инженерия признаков для детекции завершена.
2025-05-21 05:43:46,213 - backend.ml_service.multilevel_service - INFO - Запуск multilevel_detector.detect()...
2025-05-21 05:43:46,232 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: transaction...
2025-05-21 05:43:46,233 - backend.ml_service.multilevel_detector - INFO - Уровень 'transaction': Запуск детектора 'transaction_vae_price'...
2025-05-21 05:43:46,254 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Запуск детекции...
2025-05-21 05:43:46,512 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:43:46,513 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:43:46,513 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:43:46,514 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:43:46,514 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:43:47,647 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детекция завершена. Время: 1.39 сек.
2025-05-21 05:43:47,661 - backend.ml_service.multilevel_detector - INFO - Детектор 'transaction_vae_price' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0068
2025-05-21 05:43:47,661 - backend.ml_service.multilevel_detector - INFO - Уровень 'transaction': Запуск детектора 'category_price_outlier_model'...
2025-05-21 05:43:48,068 - backend.ml_service.transaction_detectors - INFO - Для 10 товаров с неизвестными категориями присвоен высокий скор аномальности.
2025-05-21 05:43:48,070 - backend.ml_service.transaction_detectors - INFO - Детектор category_price_outlier_model: обнаружено 2104 аномалий из 118310 транзакций
2025-05-21 05:43:48,097 - backend.ml_service.multilevel_detector - INFO - Детектор 'category_price_outlier_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0115
2025-05-21 05:43:48,110 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction): Матрица скоров (shape (2, 118310)), метод: weighted_average
2025-05-21 05:43:48,115 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction, метод: weighted_average): Используемые веса: {'transaction_vae_price': 1.0, 'category_price_outlier_model': 1.0}, массив весов: [1. 1.]
2025-05-21 05:43:48,116 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction, метод: weighted_average): Распределение combined_scores: Min=0.0000, Max=0.9325, Mean=0.0092
2025-05-21 05:43:48,139 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'transaction' завершен. Добавлен столбец 'transaction_score' и индивидуальные скоры детекторов.
2025-05-21 05:43:48,141 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: behavior...
2025-05-21 05:43:48,257 - backend.ml_service.multilevel_detector - INFO - Детектор 'graph_graph_analysis' типа GraphAnomalyDetector получит оригинальные данные, а не агрегированные
2025-05-21 05:43:48,257 - backend.ml_service.multilevel_detector - INFO - Уровень 'behavior': Запуск детектора 'graph_graph_analysis'...
2025-05-21 05:43:48,280 - backend.ml_service.graph_detector - INFO - Построение графа...
2025-05-21 05:43:52,983 - backend.ml_service.graph_detector - INFO - Граф построен за 4.64 сек. Узлов: 346028, Ребер: 436616
2025-05-21 05:43:53,039 - backend.ml_service.graph_detector - INFO - Расчет графовых аномальных скоров для 112650 узлов OrderItem...
2025-05-21 05:43:54,798 - backend.ml_service.graph_detector - INFO - Детектор graph_graph_analysis: обнаружено 0 аномалий из 118310 (112650 обработано графом)
2025-05-21 05:43:54,848 - backend.ml_service.multilevel_detector - INFO - Детектор 'graph_graph_analysis' обработан. Распределение нормализованных скоров: Min=0.0000, Max=0.6667, Mean=0.1571
2025-05-21 05:43:54,849 - backend.ml_service.multilevel_detector - INFO - Уровень 'behavior': Запуск детектора 'seller_pricing_behavior_model'...
2025-05-21 05:43:54,852 - backend.ml_service.behavior_detectors - INFO - Детектор seller_pricing_behavior_model: обнаружено 389 аномалий из 3095 продавцов
2025-05-21 05:43:54,862 - backend.ml_service.multilevel_detector - INFO - Детектор 'seller_pricing_behavior_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0644
2025-05-21 05:43:54,863 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior): Матрица скоров (shape (2, 3095)), метод: weighted_average
2025-05-21 05:43:54,865 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior, метод: weighted_average): Используемые веса: {'graph_graph_analysis': 1.0, 'seller_pricing_behavior_model': 1.0}, массив весов: [1. 1.]
2025-05-21 05:43:54,865 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior, метод: weighted_average): Распределение combined_scores: Min=0.0000, Max=0.5785, Mean=0.1108
2025-05-21 05:43:54,867 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'behavior' завершен. Добавлен столбец 'behavior_score' и индивидуальные скоры детекторов.
2025-05-21 05:43:55,006 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: time_series...
2025-05-21 05:43:55,083 - backend.ml_service.multilevel_detector - INFO - Уровень 'time_series': Запуск детектора 'seasonal_deviation_model'...
2025-05-21 05:43:55,088 - backend.ml_service.time_series_detectors - INFO - Детектор seasonal_deviation_model: обнаружено 160 аномалий из 616 временных точек
2025-05-21 05:43:55,089 - backend.ml_service.multilevel_detector - INFO - Детектор 'seasonal_deviation_model' обработан. Распределение нормализованных скоров: Min=0.0012, Max=1.0000, Mean=0.6384
2025-05-21 05:43:55,089 - backend.ml_service.multilevel_detector - INFO - Уровень 'time_series': Запуск детектора 'cumulative_sum_model'...
2025-05-21 05:43:55,119 - backend.ml_service.time_series_detectors - INFO - Детектор cumulative_sum_model: обнаружено 614 аномалий из 616 временных точек
2025-05-21 05:43:55,120 - backend.ml_service.multilevel_detector - INFO - Детектор 'cumulative_sum_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.3781
2025-05-21 05:43:55,120 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: time_series): Матрица скоров (shape (2, 616)), метод: average
2025-05-21 05:43:55,121 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: time_series, метод: average): Распределение combined_scores: Min=0.0298, Max=1.0000, Mean=0.5082
2025-05-21 05:43:55,122 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'time_series' завершен. Добавлен столбец 'time_series_score' и индивидуальные скоры детекторов.
2025-05-21 05:43:55,151 - backend.ml_service.multilevel_detector - INFO - Слияние временных данных: result_df имеет 118310 строк, 616 уникальных дат
2025-05-21 05:43:55,152 - backend.ml_service.multilevel_detector - INFO - Слияние временных данных: ts_scores_to_merge имеет 616 строк, 616 уникальных дат
2025-05-21 05:43:55,219 - backend.ml_service.multilevel_detector - DEBUG - Распределение transaction_level_score: Min=0.0000, Max=0.9325, Mean=0.0092
2025-05-21 05:43:55,220 - backend.ml_service.multilevel_detector - DEBUG - Распределение behavior_level_score: Min=0.0000, Max=0.5785, Mean=0.1589
2025-05-21 05:43:55,221 - backend.ml_service.multilevel_detector - DEBUG - Распределение time_series_level_score: Min=0.0298, Max=1.0000, Mean=0.5518
2025-05-21 05:43:55,221 - backend.ml_service.multilevel_detector - INFO - Расчет итогового многоуровневого скора...
2025-05-21 05:43:55,223 - backend.ml_service.multilevel_detector - DEBUG - Распределение multilevel_score (перед порогом): Min=0.0118, Max=0.6089, Mean=0.2169
2025-05-21 05:43:55,224 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8307, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,225 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:43:55,225 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-29 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,226 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-29 00:00:00
2025-05-21 05:43:55,230 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
583 2018-07-29          188      32085.4  145.842727             150               188               2018-07-29  35787.032857         0.896565           0.879612                           0.830683                       0.928541    2018-07-29
2025-05-21 05:43:55,231 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}]
2025-05-21 05:43:55,232 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,232 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.8306826658975347, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}]
2025-05-21 05:43:55,232 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9285, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,233 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:43:55,233 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-29 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,234 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-29 00:00:00
2025-05-21 05:43:55,235 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
583 2018-07-29          188      32085.4  145.842727             150               188               2018-07-29  35787.032857         0.896565           0.879612                           0.830683                       0.928541    2018-07-29
2025-05-21 05:43:55,236 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-07-29 00:00:00", "current_value": 32085.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 28389.394285714287, "deviation_in_std": 6.991176294646339, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (32085.40) отклоняется от базовой линии (3696.01) на 28389.39, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:43:55,236 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,236 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.8306826658975347, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.928540895759355, "explanation": {"detector_specific_info": {"date": "2018-07-29 00:00:00", "current_value": 32085.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 28389.394285714287, "deviation_in_std": 6.991176294646339, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (32085.40) отклоняется от базовой линии (3696.01) на 28389.39, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:43:55,237 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,237 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:43:55,238 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,239 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-03 00:00:00
2025-05-21 05:43:55,240 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales  avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
588 2018-08-03          314     45036.63  125.10175             216               314               2018-08-03  39138.992857         1.150684           0.972436                                1.0                       0.944872    2018-08-03
2025-05-21 05:43:55,241 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:43:55,241 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,242 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:43:55,242 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9449, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,242 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:43:55,242 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,243 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-03 00:00:00
2025-05-21 05:43:55,245 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales  avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
588 2018-08-03          314     45036.63  125.10175             216               314               2018-08-03  39138.992857         1.150684           0.972436                                1.0                       0.944872    2018-08-03
2025-05-21 05:43:55,246 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-03 00:00:00", "current_value": 45036.63, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 41340.624285714286, "deviation_in_std": 10.18054804563417, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (45036.63) отклоняется от базовой линии (3696.01) на 41340.62, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:43:55,247 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,247 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9448723295452219, "explanation": {"detector_specific_info": {"date": "2018-08-03 00:00:00", "current_value": 45036.63, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 41340.624285714286, "deviation_in_std": 10.18054804563417, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (45036.63) отклоняется от базовой линии (3696.01) на 41340.62, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:43:55,247 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,247 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:43:55,248 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,248 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-03 00:00:00
2025-05-21 05:43:55,250 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
527 2018-06-03          191      31535.8  137.112174             149               191               2018-06-03  27063.432857         1.165255           0.903771                                1.0                       0.807541    2018-06-03
2025-05-21 05:43:55,251 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}]
2025-05-21 05:43:55,251 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,252 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}]
2025-05-21 05:43:55,252 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8075, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,252 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:43:55,252 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,253 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-03 00:00:00
2025-05-21 05:43:55,255 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
527 2018-06-03          191      31535.8  137.112174             149               191               2018-06-03  27063.432857         1.165255           0.903771                                1.0                       0.807541    2018-06-03
2025-05-21 05:43:55,255 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-03 00:00:00", "current_value": 31535.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 27839.794285714284, "deviation_in_std": 6.855831720089102, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (31535.80) отклоняется от базовой линии (3696.01) на 27839.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:43:55,256 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,256 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8075414451585549, "explanation": {"detector_specific_info": {"date": "2018-06-03 00:00:00", "current_value": 31535.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 27839.794285714284, "deviation_in_std": 6.855831720089102, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (31535.80) отклоняется от базовой линии (3696.01) на 27839.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:43:55,256 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 26323, order_id: 0812eb902a67711a1cb742b3cdaa65ae, level: transaction): Detector Column: 'trans_transaction_vae_price_score', Score: 0.8649, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,257 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'transaction_vae_price': TransactionVAEDetector
2025-05-21 05:43:55,262 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'transaction_vae_price':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id  product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
26323              1  0812eb902a67711a1cb742b3cdaa65ae  489ae2aa008f021502940f251d4cce7f  e3b4998c7a498169dc7bce44e6bb6277  6735.0         194.31      2017-02-12 20:37:36  c6e2731c5b391845f6800c97401a43a9  utilidades_domesticas                 31.0                       875.0                 2.0           30000.0               60.0               61.0              33.0                    housewares             MS           SP  credit_card                   8.0        6929.31           5.0                           74.309637                0.028851                 0.932469                    True                           0.864939                                       1.0              0.398596                False                           0.15721                                   0.639983                 0.189451                           0.367431                        0.01147                   False          0.549402        True                       None
2025-05-21 05:43:55,263 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Метод get_explanation_details не реализован специфично, будет использована реализация get_shap_explanations (если есть).
2025-05-21 05:43:55,264 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:43:55,265 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:43:55,265 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:43:55,265 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:43:55,265 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:43:55,266 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Вычисление SHAP values для 1 экземпляров...
2025-05-21 05:43:55,266 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Используется nsamples=50 для SHAP
2025-05-21 05:43:55,267 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Запрос SHAP объяснений: explainer=True, background_data_exists=True, model=True
2025-05-21 05:43:55,267 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Создание GradientExplainer с размерами данных: torch.Size([50, 4])
2025-05-21 05:43:55,288 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw type: <class 'numpy.ndarray'>
2025-05-21 05:43:55,288 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw (ndarray) shape: (1, 4, 1)
2025-05-21 05:43:55,288 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно создан и вычислены SHAP-значения
2025-05-21 05:43:55,289 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values_raw уже является ndarray, shape: (1, 4, 1)
2025-05-21 05:43:55,289 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Начальная форма shap_values_arr: (1, 4, 1), ndim: 3
2025-05-21 05:43:55,289 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values после squeeze(-1): (1, 4)
2025-05-21 05:43:55,289 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP values успешно вычислены для 1 экземпляров.
2025-05-21 05:43:55,290 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'transaction_vae_price': [{"shap_values": {"price": 39.67469415561068, "freight_value": -2.0017080626913684, "product_weight_g": 2.9985126328804985, "freight_to_price_ratio": -0.5073102302306934}}]
2025-05-21 05:43:55,290 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'transaction_vae_price' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,290 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.8649387131195773, "explanation": {"shap_values": {"price": 39.67469415561068, "freight_value": -2.0017080626913684, "product_weight_g": 2.9985126328804985, "freight_to_price_ratio": -0.5073102302306934}}}]
2025-05-21 05:43:55,290 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 26323, order_id: 0812eb902a67711a1cb742b3cdaa65ae, level: transaction): Detector Column: 'trans_category_price_outlier_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,291 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'category_price_outlier_model': CategoryPriceOutlierDetector
2025-05-21 05:43:55,296 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'category_price_outlier_model':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id  product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
26323              1  0812eb902a67711a1cb742b3cdaa65ae  489ae2aa008f021502940f251d4cce7f  e3b4998c7a498169dc7bce44e6bb6277  6735.0         194.31      2017-02-12 20:37:36  c6e2731c5b391845f6800c97401a43a9  utilidades_domesticas                 31.0                       875.0                 2.0           30000.0               60.0               61.0              33.0                    housewares             MS           SP  credit_card                   8.0        6929.31           5.0                           74.309637                0.028851                 0.932469                    True                           0.864939                                       1.0              0.398596                False                           0.15721                                   0.639983                 0.189451                           0.367431                        0.01147                   False          0.549402        True                       None
2025-05-21 05:43:55,297 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'category_price_outlier_model': [{"detector_specific_info": {"category": "utilidades_domesticas", "price": 6735.0, "category_mean_price": 90.63427371273713, "category_std_price": 140.19371115720259, "category_min_price": 3.06, "category_max_price": 6735.0, "category_count": 7380, "z_score": 47.394178179909765, "threshold": 2.8, "explanation": "Цена 6735.00 отличается от средней цены в категории 'utilidades_domesticas' (90.63) на 47.39 стандартных отклонений (порог: 2.8)."}}]
2025-05-21 05:43:55,298 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'category_price_outlier_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,298 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.8649387131195773, "explanation": {"shap_values": {"price": 39.67469415561068, "freight_value": -2.0017080626913684, "product_weight_g": 2.9985126328804985, "freight_to_price_ratio": -0.5073102302306934}}}, {"detector_name": "category_price_outlier_model", "detector_type": "CategoryPriceOutlierDetector", "score": 1.0, "explanation": {"detector_specific_info": {"category": "utilidades_domesticas", "price": 6735.0, "category_mean_price": 90.63427371273713, "category_std_price": 140.19371115720259, "category_min_price": 3.06, "category_max_price": 6735.0, "category_count": 7380, "z_score": 47.394178179909765, "threshold": 2.8, "explanation": "Цена 6735.00 отличается от средней цены в категории 'utilidades_domesticas' (90.63) на 47.39 стандартных отклонений (порог: 2.8)."}}}]
2025-05-21 05:43:55,298 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,299 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:43:55,299 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-25 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,300 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-25 00:00:00
2025-05-21 05:43:55,301 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
579 2018-07-25          268     40753.19  122.750572             201               268               2018-07-25  35288.758571         1.154849           0.959618                                1.0                       0.919235    2018-07-25
2025-05-21 05:43:55,302 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:43:55,302 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,302 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:43:55,303 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9192, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,303 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:43:55,303 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-25 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,304 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-25 00:00:00
2025-05-21 05:43:55,306 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
579 2018-07-25          268     40753.19  122.750572             201               268               2018-07-25  35288.758571         1.154849           0.959618                                1.0                       0.919235    2018-07-25
2025-05-21 05:43:55,307 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-07-25 00:00:00", "current_value": 40753.19, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37057.18428571429, "deviation_in_std": 9.125707498979427, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (40753.19) отклоняется от базовой линии (3696.01) на 37057.18, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:43:55,307 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,308 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9192352183494302, "explanation": {"detector_specific_info": {"date": "2018-07-25 00:00:00", "current_value": 40753.19, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37057.18428571429, "deviation_in_std": 9.125707498979427, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (40753.19) отклоняется от базовой линии (3696.01) на 37057.18, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:43:55,308 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 42860, order_id: 90674f59a21207f91a7387785c66f340, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,308 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:43:55,309 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-14 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,310 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-14 00:00:00
2025-05-21 05:43:55,311 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
599 2018-08-14          315     44682.42  128.397759             228               315               2018-08-14  37562.228571         1.189557           0.989198                                1.0                       0.978396    2018-08-14
2025-05-21 05:43:55,312 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:43:55,312 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,313 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:43:55,313 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 42860, order_id: 90674f59a21207f91a7387785c66f340, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9784, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,313 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:43:55,313 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-14 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,314 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-14 00:00:00
2025-05-21 05:43:55,316 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
599 2018-08-14          315     44682.42  128.397759             228               315               2018-08-14  37562.228571         1.189557           0.989198                                1.0                       0.978396    2018-08-14
2025-05-21 05:43:55,317 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-14 00:00:00", "current_value": 44682.42, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 40986.41428571429, "deviation_in_std": 10.093320240405061, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (44682.42) отклоняется от базовой линии (3696.01) на 40986.41, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:43:55,317 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,317 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9783962277530719, "explanation": {"detector_specific_info": {"date": "2018-08-14 00:00:00", "current_value": 44682.42, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 40986.41428571429, "deviation_in_std": 10.093320240405061, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (44682.42) отклоняется от базовой линии (3696.01) на 40986.41, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:43:55,318 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: transaction): Detector Column: 'trans_transaction_vae_price_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,318 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'transaction_vae_price': TransactionVAEDetector
2025-05-21 05:43:55,324 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'transaction_vae_price':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
57579              1  3dd5626c63f493f8b8f8788c2be24baa  3a1855685a49813f60e6193864f7215e  c510bc1718f0f2961eaa42a23330681a  2699.0         306.06      2018-04-27 19:50:43  a8f345f82667eb421151dc7626147636                 bebes                 54.0                      2583.0                10.0           11450.0               57.0               78.0              44.0                          baby             SC           SP  credit_card                  10.0        3005.06           5.0                           19.887203                0.113398                 0.620279                    True                                1.0                                  0.240557              0.379093                False                          0.147594                                   0.610592                 0.823398                           0.928073                       0.718724                    True          0.608859        True                       None
2025-05-21 05:43:55,324 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Метод get_explanation_details не реализован специфично, будет использована реализация get_shap_explanations (если есть).
2025-05-21 05:43:55,326 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:43:55,326 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:43:55,326 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:43:55,326 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:43:55,327 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:43:55,327 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Вычисление SHAP values для 1 экземпляров...
2025-05-21 05:43:55,327 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Используется nsamples=50 для SHAP
2025-05-21 05:43:55,328 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Запрос SHAP объяснений: explainer=True, background_data_exists=True, model=True
2025-05-21 05:43:55,328 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Создание GradientExplainer с размерами данных: torch.Size([50, 4])
2025-05-21 05:43:55,347 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw type: <class 'numpy.ndarray'>
2025-05-21 05:43:55,347 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw (ndarray) shape: (1, 4, 1)
2025-05-21 05:43:55,347 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно создан и вычислены SHAP-значения
2025-05-21 05:43:55,347 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values_raw уже является ndarray, shape: (1, 4, 1)
2025-05-21 05:43:55,347 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Начальная форма shap_values_arr: (1, 4, 1), ndim: 3
2025-05-21 05:43:55,348 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values после squeeze(-1): (1, 4)
2025-05-21 05:43:55,348 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP values успешно вычислены для 1 экземпляров.
2025-05-21 05:43:55,348 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'transaction_vae_price': [{"shap_values": {"price": 72.61447204226951, "freight_value": -24.176216642716817, "product_weight_g": -5.459494830147285, "freight_to_price_ratio": 3.02428729800075}}]
2025-05-21 05:43:55,349 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'transaction_vae_price' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,349 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 1.0, "explanation": {"shap_values": {"price": 72.61447204226951, "freight_value": -24.176216642716817, "product_weight_g": -5.459494830147285, "freight_to_price_ratio": 3.02428729800075}}}]
2025-05-21 05:43:55,349 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: transaction): Detector Column: 'trans_category_price_outlier_model_score', Score: 0.2406, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,349 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'category_price_outlier_model': CategoryPriceOutlierDetector
2025-05-21 05:43:55,354 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'category_price_outlier_model':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
57579              1  3dd5626c63f493f8b8f8788c2be24baa  3a1855685a49813f60e6193864f7215e  c510bc1718f0f2961eaa42a23330681a  2699.0         306.06      2018-04-27 19:50:43  a8f345f82667eb421151dc7626147636                 bebes                 54.0                      2583.0                10.0           11450.0               57.0               78.0              44.0                          baby             SC           SP  credit_card                  10.0        3005.06           5.0                           19.887203                0.113398                 0.620279                    True                                1.0                                  0.240557              0.379093                False                          0.147594                                   0.610592                 0.823398                           0.928073                       0.718724                    True          0.608859        True                       None
2025-05-21 05:43:55,355 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'category_price_outlier_model': [{"detector_specific_info": {"category": "bebes", "price": 2699.0, "category_mean_price": 135.71541510611735, "category_std_price": 224.82969338108902, "category_min_price": 3.54, "category_max_price": 3899.0, "category_count": 3204, "z_score": 11.401005562681993, "threshold": 2.8, "explanation": "Цена 2699.00 отличается от средней цены в категории 'bebes' (135.72) на 11.40 стандартных отклонений (порог: 2.8)."}}]
2025-05-21 05:43:55,355 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'category_price_outlier_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,356 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 1.0, "explanation": {"shap_values": {"price": 72.61447204226951, "freight_value": -24.176216642716817, "product_weight_g": -5.459494830147285, "freight_to_price_ratio": 3.02428729800075}}}, {"detector_name": "category_price_outlier_model", "detector_type": "CategoryPriceOutlierDetector", "score": 0.24055704531923383, "explanation": {"detector_specific_info": {"category": "bebes", "price": 2699.0, "category_mean_price": 135.71541510611735, "category_std_price": 224.82969338108902, "category_min_price": 3.54, "category_max_price": 3899.0, "category_count": 3204, "z_score": 11.401005562681993, "threshold": 2.8, "explanation": "Цена 2699.00 отличается от средней цены в категории 'bebes' (135.72) на 11.40 стандартных отклонений (порог: 2.8)."}}}]
2025-05-21 05:43:55,356 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.9281, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,356 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:43:55,356 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-04-27 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,357 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-04-27 00:00:00
2025-05-21 05:43:55,359 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
490 2018-04-27          242     41231.39  140.242823             165               242               2018-04-27  35298.295714         1.168084           0.823398                           0.928073                       0.718724    2018-04-27
2025-05-21 05:43:55,360 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:43:55,360 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,360 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9280726698190791, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:43:55,360 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.7187, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,361 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:43:55,361 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-04-27 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,362 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-04-27 00:00:00
2025-05-21 05:43:55,364 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
490 2018-04-27          242     41231.39  140.242823             165               242               2018-04-27  35298.295714         1.168084           0.823398                           0.928073                       0.718724    2018-04-27
2025-05-21 05:43:55,365 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-04-27 00:00:00", "current_value": 41231.39, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37535.38428571429, "deviation_in_std": 9.243469099331083, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (41231.39) отклоняется от базовой линии (3696.01) на 37535.38, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:43:55,365 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,365 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9280726698190791, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.718723936134046, "explanation": {"detector_specific_info": {"date": "2018-04-27 00:00:00", "current_value": 41231.39, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37535.38428571429, "deviation_in_std": 9.243469099331083, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (41231.39) отклоняется от базовой линии (3696.01) на 37535.38, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:43:55,366 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 74778, order_id: 94fca82966c05ba707f4e7dc0c50aa3c, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,366 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:43:55,366 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,367 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:43:55,369 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:43:55,369 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:43:55,370 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,370 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:43:55,370 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 74778, order_id: 94fca82966c05ba707f4e7dc0c50aa3c, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9819, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,370 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:43:55,371 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,372 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:43:55,373 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:43:55,374 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:43:55,374 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,374 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9819435388597458, "explanation": {"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:43:55,375 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 75482, order_id: 4160b6447ad70e6d73f7221dd970bbe9, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,375 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:43:55,375 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,376 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:43:55,378 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:43:55,379 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:43:55,379 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,379 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:43:55,380 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 75482, order_id: 4160b6447ad70e6d73f7221dd970bbe9, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9819, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,380 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:43:55,380 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,381 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:43:55,384 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:43:55,385 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:43:55,385 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,385 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9819435388597458, "explanation": {"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:43:55,386 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.9481, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,386 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:43:55,386 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-01-26 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,387 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-01-26 00:00:00
2025-05-21 05:43:55,389 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
399 2018-01-26          228     34533.35  125.575818             151               228               2018-01-26       31895.5         1.082703           0.722093                           0.948138                       0.496047    2018-01-26
2025-05-21 05:43:55,389 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:43:55,390 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,390 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9481383115297547, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:43:55,390 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.4960, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,390 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:43:55,391 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-01-26 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,392 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-01-26 00:00:00
2025-05-21 05:43:55,393 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
399 2018-01-26          228     34533.35  125.575818             151               228               2018-01-26       31895.5         1.082703           0.722093                           0.948138                       0.496047    2018-01-26
2025-05-21 05:43:55,394 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-01-26 00:00:00", "current_value": 34533.35, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 30837.344285714284, "deviation_in_std": 7.594008811544785, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34533.35) отклоняется от базовой линии (3696.01) на 30837.34, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:43:55,394 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,394 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9481383115297547, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.496047165599019, "explanation": {"detector_specific_info": {"date": "2018-01-26 00:00:00", "current_value": 34533.35, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 30837.344285714284, "deviation_in_std": 7.594008811544785, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34533.35) отклоняется от базовой линии (3696.01) на 30837.34, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:43:55,395 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87594, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8164, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,395 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:43:55,395 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,396 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:43:55,398 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:43:55,399 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:43:55,399 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,399 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:43:55,400 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87594, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8123, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,400 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:43:55,400 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,401 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:43:55,403 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:43:55,403 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:43:55,404 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,404 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8122690239748033, "explanation": {"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:43:55,404 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87595, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8164, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,404 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:43:55,405 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,406 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:43:55,407 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:43:55,408 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:43:55,408 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,408 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:43:55,408 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87595, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8123, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,409 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:43:55,409 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,410 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:43:55,412 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:43:55,413 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:43:55,413 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,413 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8122690239748033, "explanation": {"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:43:55,414 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,414 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:43:55,414 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-03-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,415 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-03-15 00:00:00
2025-05-21 05:43:55,417 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
447 2018-03-15          286      46096.4  135.180059             174               286               2018-03-15  32494.021429         1.418612           0.804803                                1.0                       0.609605    2018-03-15
2025-05-21 05:43:55,417 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}]
2025-05-21 05:43:55,418 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,418 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}}]
2025-05-21 05:43:55,418 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.6096, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:43:55,418 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:43:55,418 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-03-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:43:55,419 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-03-15 00:00:00
2025-05-21 05:43:55,421 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
447 2018-03-15          286      46096.4  135.180059             174               286               2018-03-15  32494.021429         1.418612           0.804803                                1.0                       0.609605    2018-03-15
2025-05-21 05:43:55,422 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-03-15 00:00:00", "current_value": 46096.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42400.39428571429, "deviation_in_std": 10.441527157312704, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46096.40) отклоняется от базовой линии (3696.01) на 42400.39, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:43:55,422 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:43:55,422 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.609605020859105, "explanation": {"detector_specific_info": {"date": "2018-03-15 00:00:00", "current_value": 46096.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42400.39428571429, "deviation_in_std": 10.441527157312704, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46096.40) отклоняется от базовой линии (3696.01) на 42400.39, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:43:55,424 - backend.ml_service.multilevel_detector - INFO - Сгенерированы объяснения для 13 из 13 аномалий
2025-05-21 05:43:55,424 - backend.ml_service.multilevel_detector - INFO - Многоуровневая детекция завершена. Обнаружено 13 аномалий.
2025-05-21 05:43:55,438 - backend.ml_service.multilevel_service - INFO - Обнаружено 13 multilevel аномалий до сохранения.
2025-05-21 05:43:55,438 - backend.ml_service.multilevel_service - INFO - Начало сохранения multilevel аномалий в БД...
2025-05-21 05:43:55,503 - backend.ml_service.multilevel_service - INFO - Статистика сохранения multilevel аномалий: {'total_detected_anomalies_before_save': 13, 'newly_saved_anomalies_count': 12, 'newly_saved_anomaly_ids': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], 'skipped_duplicates_count': 1, 'errors_on_save': 0}
2025-05-21 05:43:55,504 - backend.ml_service.multilevel_service - DEBUG - Сессия БД (db_for_crud) для multilevel detect закрыта.
2025-05-21 05:43:55,504 - backend.ml_service.multilevel_service - DEBUG - Сессия БД (db_for_load_detect) для multilevel detect закрыта.
2025-05-21 05:43:55,527 - backend.ml_service.multilevel_service - INFO - [TaskID: 29042a7c-136c-4d97-afbd-aae9c2c23661] Детекция и сохранение аномалий успешно завершены.
2025-05-21 05:45:56,773 - backend.ml_service.multilevel_service - INFO - [TaskID: 220fbbdd-8e76-41f8-97d0-f31d461ed31f] Обертка detect_async_task_wrapper запущена.
2025-05-21 05:45:56,774 - backend.ml_service.multilevel_service - INFO - Начало обнаружения аномалий (multilevel) с сохранением в БД...
2025-05-21 05:45:56,775 - backend.ml_service.multilevel_service - INFO - Загрузка данных из БД для multilevel detect...
2025-05-21 05:45:56,775 - backend.ml_service.common - INFO - Загрузка данных из БД за период: 1998-01-03 05:45:56.772543 - None (с ассоциациями)
2025-05-21 05:46:00,793 - backend.ml_service.common - INFO - Загружено 118310 записей OrderItem.
2025-05-21 05:46:00,793 - backend.ml_service.multilevel_service - INFO - Данные для multilevel detect (118310 строк) подготовлены. Применение инженерии признаков...
2025-05-21 05:46:00,938 - backend.ml_service.common - INFO - Добавлен признак: 'price_deviation_from_category_mean'
2025-05-21 05:46:00,940 - backend.ml_service.common - INFO - Добавлен признак: 'freight_to_price_ratio'
2025-05-21 05:46:00,940 - backend.ml_service.multilevel_service - INFO - Инженерия признаков для детекции завершена.
2025-05-21 05:46:00,941 - backend.ml_service.multilevel_service - INFO - Запуск multilevel_detector.detect()...
2025-05-21 05:46:00,965 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: transaction...
2025-05-21 05:46:00,965 - backend.ml_service.multilevel_detector - INFO - Уровень 'transaction': Запуск детектора 'transaction_vae_price'...
2025-05-21 05:46:00,991 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Запуск детекции...
2025-05-21 05:46:01,263 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:46:01,263 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:46:01,264 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:46:01,264 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:46:01,264 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:46:02,191 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детекция завершена. Время: 1.20 сек.
2025-05-21 05:46:02,206 - backend.ml_service.multilevel_detector - INFO - Детектор 'transaction_vae_price' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0068
2025-05-21 05:46:02,206 - backend.ml_service.multilevel_detector - INFO - Уровень 'transaction': Запуск детектора 'category_price_outlier_model'...
2025-05-21 05:46:02,701 - backend.ml_service.transaction_detectors - INFO - Для 10 товаров с неизвестными категориями присвоен высокий скор аномальности.
2025-05-21 05:46:02,702 - backend.ml_service.transaction_detectors - INFO - Детектор category_price_outlier_model: обнаружено 2104 аномалий из 118310 транзакций
2025-05-21 05:46:02,730 - backend.ml_service.multilevel_detector - INFO - Детектор 'category_price_outlier_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0115
2025-05-21 05:46:02,746 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction): Матрица скоров (shape (2, 118310)), метод: weighted_average
2025-05-21 05:46:02,751 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction, метод: weighted_average): Используемые веса: {'transaction_vae_price': 1.0, 'category_price_outlier_model': 1.0}, массив весов: [1. 1.]
2025-05-21 05:46:02,752 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: transaction, метод: weighted_average): Распределение combined_scores: Min=0.0000, Max=0.9430, Mean=0.0092
2025-05-21 05:46:02,775 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'transaction' завершен. Добавлен столбец 'transaction_score' и индивидуальные скоры детекторов.
2025-05-21 05:46:02,777 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: behavior...
2025-05-21 05:46:02,896 - backend.ml_service.multilevel_detector - INFO - Детектор 'graph_graph_analysis' типа GraphAnomalyDetector получит оригинальные данные, а не агрегированные
2025-05-21 05:46:02,896 - backend.ml_service.multilevel_detector - INFO - Уровень 'behavior': Запуск детектора 'graph_graph_analysis'...
2025-05-21 05:46:02,916 - backend.ml_service.graph_detector - INFO - Построение графа...
2025-05-21 05:46:07,121 - backend.ml_service.graph_detector - INFO - Граф построен за 4.13 сек. Узлов: 346028, Ребер: 436616
2025-05-21 05:46:07,179 - backend.ml_service.graph_detector - INFO - Расчет графовых аномальных скоров для 112650 узлов OrderItem...
2025-05-21 05:46:08,764 - backend.ml_service.graph_detector - INFO - Детектор graph_graph_analysis: обнаружено 0 аномалий из 118310 (112650 обработано графом)
2025-05-21 05:46:08,817 - backend.ml_service.multilevel_detector - INFO - Детектор 'graph_graph_analysis' обработан. Распределение нормализованных скоров: Min=0.0000, Max=0.6667, Mean=0.1571
2025-05-21 05:46:08,817 - backend.ml_service.multilevel_detector - INFO - Уровень 'behavior': Запуск детектора 'seller_pricing_behavior_model'...
2025-05-21 05:46:08,820 - backend.ml_service.behavior_detectors - INFO - Детектор seller_pricing_behavior_model: обнаружено 389 аномалий из 3095 продавцов
2025-05-21 05:46:08,833 - backend.ml_service.multilevel_detector - INFO - Детектор 'seller_pricing_behavior_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.0644
2025-05-21 05:46:08,834 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior): Матрица скоров (shape (2, 3095)), метод: weighted_average
2025-05-21 05:46:08,835 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior, метод: weighted_average): Используемые веса: {'graph_graph_analysis': 1.0, 'seller_pricing_behavior_model': 1.0}, массив весов: [1. 1.]
2025-05-21 05:46:08,835 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: behavior, метод: weighted_average): Распределение combined_scores: Min=0.0000, Max=0.5785, Mean=0.1108
2025-05-21 05:46:08,837 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'behavior' завершен. Добавлен столбец 'behavior_score' и индивидуальные скоры детекторов.
2025-05-21 05:46:08,979 - backend.ml_service.multilevel_detector - INFO - Запуск анализа на уровне: time_series...
2025-05-21 05:46:09,058 - backend.ml_service.multilevel_detector - INFO - Уровень 'time_series': Запуск детектора 'seasonal_deviation_model'...
2025-05-21 05:46:09,062 - backend.ml_service.time_series_detectors - INFO - Детектор seasonal_deviation_model: обнаружено 160 аномалий из 616 временных точек
2025-05-21 05:46:09,063 - backend.ml_service.multilevel_detector - INFO - Детектор 'seasonal_deviation_model' обработан. Распределение нормализованных скоров: Min=0.0012, Max=1.0000, Mean=0.6384
2025-05-21 05:46:09,063 - backend.ml_service.multilevel_detector - INFO - Уровень 'time_series': Запуск детектора 'cumulative_sum_model'...
2025-05-21 05:46:09,092 - backend.ml_service.time_series_detectors - INFO - Детектор cumulative_sum_model: обнаружено 614 аномалий из 616 временных точек
2025-05-21 05:46:09,093 - backend.ml_service.multilevel_detector - INFO - Детектор 'cumulative_sum_model' обработан. Распределение нормализованных скоров: Min=0.0000, Max=1.0000, Mean=0.3781
2025-05-21 05:46:09,094 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: time_series): Матрица скоров (shape (2, 616)), метод: average
2025-05-21 05:46:09,095 - backend.ml_service.multilevel_detector - DEBUG - _combine_scores_for_single_level (Уровень: time_series, метод: average): Распределение combined_scores: Min=0.0298, Max=1.0000, Mean=0.5082
2025-05-21 05:46:09,096 - backend.ml_service.multilevel_detector - INFO - Анализ на уровне 'time_series' завершен. Добавлен столбец 'time_series_score' и индивидуальные скоры детекторов.
2025-05-21 05:46:09,125 - backend.ml_service.multilevel_detector - INFO - Слияние временных данных: result_df имеет 118310 строк, 616 уникальных дат
2025-05-21 05:46:09,125 - backend.ml_service.multilevel_detector - INFO - Слияние временных данных: ts_scores_to_merge имеет 616 строк, 616 уникальных дат
2025-05-21 05:46:09,194 - backend.ml_service.multilevel_detector - DEBUG - Распределение transaction_level_score: Min=0.0000, Max=0.9430, Mean=0.0092
2025-05-21 05:46:09,195 - backend.ml_service.multilevel_detector - DEBUG - Распределение behavior_level_score: Min=0.0000, Max=0.5785, Mean=0.1589
2025-05-21 05:46:09,196 - backend.ml_service.multilevel_detector - DEBUG - Распределение time_series_level_score: Min=0.0298, Max=1.0000, Mean=0.5518
2025-05-21 05:46:09,196 - backend.ml_service.multilevel_detector - INFO - Расчет итогового многоуровневого скора...
2025-05-21 05:46:09,198 - backend.ml_service.multilevel_detector - DEBUG - Распределение multilevel_score (перед порогом): Min=0.0116, Max=0.6089, Mean=0.2169
2025-05-21 05:46:09,200 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: behavior): Detector Column: 'behav_graph_graph_analysis_score', Score: 0.1563, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,200 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'graph_graph_analysis': GraphAnomalyDetector
2025-05-21 05:46:09,201 - backend.ml_service.multilevel_detector - DEBUG -     Using original row data for graph detector
2025-05-21 05:46:09,205 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for behavior detector 'graph_graph_analysis':
      order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
3179              1  b239ca7cd485940b31882363b52e6674  dd113cb02b2af9c8e5787e8f1f0722f6  821fb029fc6e495ca4f08a35d51e53a5  4059.0         104.51      2018-07-29 08:39:48  e9b0d0eb3015ef1c9ce6cf5b9dcbee9f         esporte_lazer                 51.0                      1511.0                 1.0            8000.0               55.0               25.0              45.0                sports_leisure             MG           SP   debit_card                   1.0        4163.51           4.0                           35.496405                0.025748                  0.48633                   False                           0.460364                                  0.512296              0.433102                 True                          0.156335                                   0.709869                 0.879612                           0.830683                       0.928541                    True          0.588346        True                       None
2025-05-21 05:46:09,206 - backend.ml_service.graph_detector - INFO - Построение графа...
2025-05-21 05:46:09,206 - backend.ml_service.graph_detector - INFO - Граф построен за 0.00 сек. Узлов: 5, Ребер: 4
2025-05-21 05:46:09,207 - backend.ml_service.multilevel_detector - DEBUG - Explanation from behavior detector 'graph_graph_analysis': [{"detector_specific_info": {"raw_graph_metrics": {"num_seller_states": 1.0, "num_product_categories": 1.0, "seller_degree": 1.0}, "normalized_graph_metrics": {"norm_num_seller_states": 0.0, "norm_num_product_categories": 0.3333333333333333, "norm_seller_degree": 0.0}, "weights": {"seller_state_weight": 0.3, "category_diversity_weight": 0.4, "seller_degree_weight": 0.3}, "final_score": 0.13333333333333333, "explanation": "Продавец связан с 1 другими узлами в графе, что обычно."}}]
2025-05-21 05:46:09,207 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'graph_graph_analysis' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,207 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for behavior_level: [{"detector_name": "graph_graph_analysis", "detector_type": "GraphAnomalyDetector", "score": 0.1563352375070763, "explanation": {"detector_specific_info": {"raw_graph_metrics": {"num_seller_states": 1.0, "num_product_categories": 1.0, "seller_degree": 1.0}, "normalized_graph_metrics": {"norm_num_seller_states": 0.0, "norm_num_product_categories": 0.3333333333333333, "norm_seller_degree": 0.0}, "weights": {"seller_state_weight": 0.3, "category_diversity_weight": 0.4, "seller_degree_weight": 0.3}, "final_score": 0.13333333333333333, "explanation": "Продавец связан с 1 другими узлами в графе, что обычно."}}}]
2025-05-21 05:46:09,207 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: behavior): Detector Column: 'behav_seller_pricing_behavior_model_score', Score: 0.7099, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,208 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seller_pricing_behavior_model': SellerPricingBehaviorDetector
2025-05-21 05:46:09,208 - backend.ml_service.multilevel_detector - DEBUG -     Looking for seller_id=821fb029fc6e495ca4f08a35d51e53a5 in aggregated_behavior_data_with_scores
2025-05-21 05:46:09,208 - backend.ml_service.multilevel_detector - DEBUG -     Found matching seller_id row in aggregated data
2025-05-21 05:46:09,211 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for behavior detector 'seller_pricing_behavior_model':
                             seller_id  mean_price   std_price  count  min_price  max_price  mean_freight  std_freight                                                                   categories  category_count  price_volatility  price_range_ratio  freight_to_price_ratio  unique_categories  category_diversity  normalized_diversity  behavior_score  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score
1601  821fb029fc6e495ca4f08a35d51e53a5  652.547333  931.135718     30       17.9     4059.0     54.545667    29.185866  [esporte_lazer, casa_construcao, utilidades_domesticas, eletrodomesticos_2]               4          1.426924         226.759777                0.083589                  4            0.133333              0.482995        0.433102                          0.156335                                   0.709869
2025-05-21 05:46:09,211 - backend.ml_service.multilevel_detector - DEBUG - Explanation from behavior detector 'seller_pricing_behavior_model': [{"detector_specific_info": {"seller_id": "821fb029fc6e495ca4f08a35d51e53a5", "anomaly_factors": [{"factor": "price_volatility", "value": 1.4269244090555202, "threshold": 0.5, "description": "Высокая волатильность цен (1.43 > 0.50)"}, {"factor": "price_range_ratio", "value": 226.75977653631287, "threshold": 5.0, "description": "Широкий диапазон цен (max/min = 226.76 > 5.00)"}], "text_explanation": "Выявлены следующие аномалии в ценовом поведении продавца:\n- Высокая волатильность цен (1.43 > 0.50)\n- Широкий диапазон цен (max/min = 226.76 > 5.00)", "raw_metrics": {"mean_price": 652.5473333333333, "std_price": 931.1357179974221, "price_volatility": 1.4269244090555202, "price_range_ratio": 226.75977653631287, "freight_to_price_ratio": 0.0835888277836295, "transaction_count": 30}}}]
2025-05-21 05:46:09,212 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seller_pricing_behavior_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,212 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for behavior_level: [{"detector_name": "graph_graph_analysis", "detector_type": "GraphAnomalyDetector", "score": 0.1563352375070763, "explanation": {"detector_specific_info": {"raw_graph_metrics": {"num_seller_states": 1.0, "num_product_categories": 1.0, "seller_degree": 1.0}, "normalized_graph_metrics": {"norm_num_seller_states": 0.0, "norm_num_product_categories": 0.3333333333333333, "norm_seller_degree": 0.0}, "weights": {"seller_state_weight": 0.3, "category_diversity_weight": 0.4, "seller_degree_weight": 0.3}, "final_score": 0.13333333333333333, "explanation": "Продавец связан с 1 другими узлами в графе, что обычно."}}}, {"detector_name": "seller_pricing_behavior_model", "detector_type": "SellerPricingBehaviorDetector", "score": 0.7098685117282175, "explanation": {"detector_specific_info": {"seller_id": "821fb029fc6e495ca4f08a35d51e53a5", "anomaly_factors": [{"factor": "price_volatility", "value": 1.4269244090555202, "threshold": 0.5, "description": "Высокая волатильность цен (1.43 > 0.50)"}, {"factor": "price_range_ratio", "value": 226.75977653631287, "threshold": 5.0, "description": "Широкий диапазон цен (max/min = 226.76 > 5.00)"}], "text_explanation": "Выявлены следующие аномалии в ценовом поведении продавца:\n- Высокая волатильность цен (1.43 > 0.50)\n- Широкий диапазон цен (max/min = 226.76 > 5.00)", "raw_metrics": {"mean_price": 652.5473333333333, "std_price": 931.1357179974221, "price_volatility": 1.4269244090555202, "price_range_ratio": 226.75977653631287, "freight_to_price_ratio": 0.0835888277836295, "transaction_count": 30}}}}]
2025-05-21 05:46:09,212 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8307, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,212 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:46:09,213 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-29 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,214 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-29 00:00:00
2025-05-21 05:46:09,215 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
583 2018-07-29          188      32085.4  145.842727             150               188               2018-07-29  35787.032857         0.896565           0.879612                           0.830683                       0.928541    2018-07-29
2025-05-21 05:46:09,216 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}]
2025-05-21 05:46:09,216 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,216 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.8306826658975347, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}]
2025-05-21 05:46:09,216 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 3179, order_id: b239ca7cd485940b31882363b52e6674, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9285, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,216 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:46:09,217 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-29 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,217 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-29 00:00:00
2025-05-21 05:46:09,219 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
583 2018-07-29          188      32085.4  145.842727             150               188               2018-07-29  35787.032857         0.896565           0.879612                           0.830683                       0.928541    2018-07-29
2025-05-21 05:46:09,220 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-07-29 00:00:00", "current_value": 32085.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 28389.394285714287, "deviation_in_std": 6.991176294646339, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (32085.40) отклоняется от базовой линии (3696.01) на 28389.39, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:46:09,220 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,220 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.8306826658975347, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-29 00:00:00", "current_value": 32085.4, "expected_value": 18683.428202247193, "absolute_deviation": 13401.971797752809, "relative_deviation": 0.7173186661825187, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-29 00:00:00 значение total_sales (32085.40) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.928540895759355, "explanation": {"detector_specific_info": {"date": "2018-07-29 00:00:00", "current_value": 32085.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 28389.394285714287, "deviation_in_std": 6.991176294646339, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (32085.40) отклоняется от базовой линии (3696.01) на 28389.39, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:46:09,221 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: behavior): Detector Column: 'behav_graph_graph_analysis_score', Score: 0.1735, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,221 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'graph_graph_analysis': GraphAnomalyDetector
2025-05-21 05:46:09,222 - backend.ml_service.multilevel_detector - DEBUG -     Using original row data for graph detector
2025-05-21 05:46:09,227 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for behavior detector 'graph_graph_analysis':
       order_item_id                          order_id                        product_id                         seller_id    price  freight_value order_purchase_timestamp                       customer_id  product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
13794              1  426a9742b533fc6fed17d1fd6d143d7e  a1beef8f3992dbd4cd8726796aa69c53  512d298ac2a96d1931b6bd30aa21f61d  4399.87         113.45      2018-08-03 21:10:16  1afc82cd60e303ef09b4ef9837c9505c  instrumentos_musicais                 59.0                       944.0                 3.0            3550.0               71.0               34.0              22.0           musical_instruments             SP           RJ  credit_card                  10.0        4513.32           5.0                           14.996218                0.025785                 0.387641                   False                             0.5824                                  0.192881              0.451242                 True                          0.173479                                   0.729005                 0.972436                                1.0                       0.944872                    True           0.58216        True                       None
2025-05-21 05:46:09,227 - backend.ml_service.graph_detector - INFO - Построение графа...
2025-05-21 05:46:09,228 - backend.ml_service.graph_detector - INFO - Граф построен за 0.00 сек. Узлов: 5, Ребер: 4
2025-05-21 05:46:09,228 - backend.ml_service.multilevel_detector - DEBUG - Explanation from behavior detector 'graph_graph_analysis': [{"detector_specific_info": {"raw_graph_metrics": {"num_seller_states": 1.0, "num_product_categories": 1.0, "seller_degree": 1.0}, "normalized_graph_metrics": {"norm_num_seller_states": 0.0, "norm_num_product_categories": 0.3333333333333333, "norm_seller_degree": 0.0}, "weights": {"seller_state_weight": 0.3, "category_diversity_weight": 0.4, "seller_degree_weight": 0.3}, "final_score": 0.13333333333333333, "explanation": "Продавец связан с 1 другими узлами в графе, что обычно."}}]
2025-05-21 05:46:09,228 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'graph_graph_analysis' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,229 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for behavior_level: [{"detector_name": "graph_graph_analysis", "detector_type": "GraphAnomalyDetector", "score": 0.1734792342133704, "explanation": {"detector_specific_info": {"raw_graph_metrics": {"num_seller_states": 1.0, "num_product_categories": 1.0, "seller_degree": 1.0}, "normalized_graph_metrics": {"norm_num_seller_states": 0.0, "norm_num_product_categories": 0.3333333333333333, "norm_seller_degree": 0.0}, "weights": {"seller_state_weight": 0.3, "category_diversity_weight": 0.4, "seller_degree_weight": 0.3}, "final_score": 0.13333333333333333, "explanation": "Продавец связан с 1 другими узлами в графе, что обычно."}}}]
2025-05-21 05:46:09,229 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: behavior): Detector Column: 'behav_seller_pricing_behavior_model_score', Score: 0.7290, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,229 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seller_pricing_behavior_model': SellerPricingBehaviorDetector
2025-05-21 05:46:09,229 - backend.ml_service.multilevel_detector - DEBUG -     Looking for seller_id=512d298ac2a96d1931b6bd30aa21f61d in aggregated_behavior_data_with_scores
2025-05-21 05:46:09,230 - backend.ml_service.multilevel_detector - DEBUG -     Found matching seller_id row in aggregated data
2025-05-21 05:46:09,234 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for behavior detector 'seller_pricing_behavior_model':
                            seller_id  mean_price    std_price  count  min_price  max_price  mean_freight  std_freight                                        categories  category_count  price_volatility  price_range_ratio  freight_to_price_ratio  unique_categories  category_diversity  normalized_diversity  behavior_score  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score
971  512d298ac2a96d1931b6bd30aa21f61d  616.828333  1235.913112     12       18.9    4399.87       26.8275    28.753741  [instrumentos_musicais, eletronicos, brinquedos]               3          2.003658         232.797354                0.043493                  3                0.25              0.416029        0.451242                          0.173479                                   0.729005
2025-05-21 05:46:09,234 - backend.ml_service.multilevel_detector - DEBUG - Explanation from behavior detector 'seller_pricing_behavior_model': [{"detector_specific_info": {"seller_id": "512d298ac2a96d1931b6bd30aa21f61d", "anomaly_factors": [{"factor": "price_volatility", "value": 2.0036581408594487, "threshold": 0.5, "description": "Высокая волатильность цен (2.00 > 0.50)"}, {"factor": "price_range_ratio", "value": 232.79735449735452, "threshold": 5.0, "description": "Широкий диапазон цен (max/min = 232.80 > 5.00)"}], "text_explanation": "Выявлены следующие аномалии в ценовом поведении продавца:\n- Высокая волатильность цен (2.00 > 0.50)\n- Широкий диапазон цен (max/min = 232.80 > 5.00)", "raw_metrics": {"mean_price": 616.8283333333333, "std_price": 1235.9131115960988, "price_volatility": 2.0036581408594487, "price_range_ratio": 232.79735449735452, "freight_to_price_ratio": 0.04349265192638687, "transaction_count": 12}}}]
2025-05-21 05:46:09,235 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seller_pricing_behavior_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,235 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for behavior_level: [{"detector_name": "graph_graph_analysis", "detector_type": "GraphAnomalyDetector", "score": 0.1734792342133704, "explanation": {"detector_specific_info": {"raw_graph_metrics": {"num_seller_states": 1.0, "num_product_categories": 1.0, "seller_degree": 1.0}, "normalized_graph_metrics": {"norm_num_seller_states": 0.0, "norm_num_product_categories": 0.3333333333333333, "norm_seller_degree": 0.0}, "weights": {"seller_state_weight": 0.3, "category_diversity_weight": 0.4, "seller_degree_weight": 0.3}, "final_score": 0.13333333333333333, "explanation": "Продавец связан с 1 другими узлами в графе, что обычно."}}}, {"detector_name": "seller_pricing_behavior_model", "detector_type": "SellerPricingBehaviorDetector", "score": 0.7290054725146806, "explanation": {"detector_specific_info": {"seller_id": "512d298ac2a96d1931b6bd30aa21f61d", "anomaly_factors": [{"factor": "price_volatility", "value": 2.0036581408594487, "threshold": 0.5, "description": "Высокая волатильность цен (2.00 > 0.50)"}, {"factor": "price_range_ratio", "value": 232.79735449735452, "threshold": 5.0, "description": "Широкий диапазон цен (max/min = 232.80 > 5.00)"}], "text_explanation": "Выявлены следующие аномалии в ценовом поведении продавца:\n- Высокая волатильность цен (2.00 > 0.50)\n- Широкий диапазон цен (max/min = 232.80 > 5.00)", "raw_metrics": {"mean_price": 616.8283333333333, "std_price": 1235.9131115960988, "price_volatility": 2.0036581408594487, "price_range_ratio": 232.79735449735452, "freight_to_price_ratio": 0.04349265192638687, "transaction_count": 12}}}}]
2025-05-21 05:46:09,235 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,236 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:46:09,236 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,236 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-03 00:00:00
2025-05-21 05:46:09,238 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales  avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
588 2018-08-03          314     45036.63  125.10175             216               314               2018-08-03  39138.992857         1.150684           0.972436                                1.0                       0.944872    2018-08-03
2025-05-21 05:46:09,238 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:46:09,238 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,239 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:46:09,239 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 13794, order_id: 426a9742b533fc6fed17d1fd6d143d7e, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9449, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,239 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:46:09,239 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,240 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-03 00:00:00
2025-05-21 05:46:09,242 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales  avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
588 2018-08-03          314     45036.63  125.10175             216               314               2018-08-03  39138.992857         1.150684           0.972436                                1.0                       0.944872    2018-08-03
2025-05-21 05:46:09,243 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-03 00:00:00", "current_value": 45036.63, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 41340.624285714286, "deviation_in_std": 10.18054804563417, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (45036.63) отклоняется от базовой линии (3696.01) на 41340.62, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:46:09,243 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,243 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-03 00:00:00", "current_value": 45036.63, "expected_value": 23364.508863636365, "absolute_deviation": 21672.121136363632, "relative_deviation": 0.9275658762120739, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-03 00:00:00 значение total_sales (45036.63) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9448723295452219, "explanation": {"detector_specific_info": {"date": "2018-08-03 00:00:00", "current_value": 45036.63, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 41340.624285714286, "deviation_in_std": 10.18054804563417, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (45036.63) отклоняется от базовой линии (3696.01) на 41340.62, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:46:09,243 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: transaction): Detector Column: 'trans_transaction_vae_price_score', Score: 0.0025, Threshold: 0.05, Passes Threshold: False
2025-05-21 05:46:09,243 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: transaction): Detector Column: 'trans_category_price_outlier_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,244 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'category_price_outlier_model': CategoryPriceOutlierDetector
2025-05-21 05:46:09,249 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'category_price_outlier_model':
       order_item_id                          order_id                        product_id                         seller_id  price  freight_value order_purchase_timestamp                       customer_id          product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
21734              1  cb53f0b6e8f9082a9f5a113765dd1236  8cfc3506cedc0626364457d254429118  dbb9b48c841a0e39e21f98e1a6b2ec3e  89.99           7.49      2018-06-03 22:34:58  035c08a68b237ef4afc82109e61a7380  fashion_roupa_infanto_juvenil                 47.0                       327.0                 3.0             300.0               30.0               20.0              20.0     fashion_childrens_clothes             SP           SP  credit_card                   6.0          97.48           5.0                             1.26335                0.083231                 0.501239                    True                           0.002477                                       1.0              0.114793                False                          0.175094                                   0.054492                 0.903771                                1.0                       0.807541                    True          0.506065        True                       None
2025-05-21 05:46:09,250 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'category_price_outlier_model': [{"detector_specific_info": {"category": "fashion_roupa_infanto_juvenil", "price": 89.99, "explanation": "Категория 'fashion_roupa_infanto_juvenil' не встречалась в обучающих данных, статистики отсутствуют."}}]
2025-05-21 05:46:09,250 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'category_price_outlier_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,250 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "category_price_outlier_model", "detector_type": "CategoryPriceOutlierDetector", "score": 1.0, "explanation": {"detector_specific_info": {"category": "fashion_roupa_infanto_juvenil", "price": 89.99, "explanation": "Категория 'fashion_roupa_infanto_juvenil' не встречалась в обучающих данных, статистики отсутствуют."}}}]
2025-05-21 05:46:09,250 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,250 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:46:09,251 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,251 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-03 00:00:00
2025-05-21 05:46:09,253 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
527 2018-06-03          191      31535.8  137.112174             149               191               2018-06-03  27063.432857         1.165255           0.903771                                1.0                       0.807541    2018-06-03
2025-05-21 05:46:09,253 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}]
2025-05-21 05:46:09,253 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,254 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}]
2025-05-21 05:46:09,254 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 21734, order_id: cb53f0b6e8f9082a9f5a113765dd1236, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8075, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,254 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:46:09,255 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-03 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,256 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-03 00:00:00
2025-05-21 05:46:09,258 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
527 2018-06-03          191      31535.8  137.112174             149               191               2018-06-03  27063.432857         1.165255           0.903771                                1.0                       0.807541    2018-06-03
2025-05-21 05:46:09,258 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-03 00:00:00", "current_value": 31535.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 27839.794285714284, "deviation_in_std": 6.855831720089102, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (31535.80) отклоняется от базовой линии (3696.01) на 27839.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:46:09,258 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,258 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-03 00:00:00", "current_value": 31535.8, "expected_value": 18683.428202247193, "absolute_deviation": 12852.371797752807, "relative_deviation": 0.6879022232229821, "threshold": 2.5, "day_of_week": 6, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-03 00:00:00 значение total_sales (31535.80) в пределах нормальных отклонений от сезонного паттерна (18683.43)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8075414451585549, "explanation": {"detector_specific_info": {"date": "2018-06-03 00:00:00", "current_value": 31535.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 27839.794285714284, "deviation_in_std": 6.855831720089102, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (31535.80) отклоняется от базовой линии (3696.01) на 27839.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:46:09,259 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 26323, order_id: 0812eb902a67711a1cb742b3cdaa65ae, level: transaction): Detector Column: 'trans_transaction_vae_price_score', Score: 0.8860, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,259 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'transaction_vae_price': TransactionVAEDetector
2025-05-21 05:46:09,264 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'transaction_vae_price':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id  product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
26323              1  0812eb902a67711a1cb742b3cdaa65ae  489ae2aa008f021502940f251d4cce7f  e3b4998c7a498169dc7bce44e6bb6277  6735.0         194.31      2017-02-12 20:37:36  c6e2731c5b391845f6800c97401a43a9  utilidades_domesticas                 31.0                       875.0                 2.0           30000.0               60.0               61.0              33.0                    housewares             MS           SP  credit_card                   8.0        6929.31           5.0                           74.309637                0.028851                 0.942999                    True                           0.885999                                       1.0              0.398596                False                           0.15721                                   0.639983                 0.189451                           0.367431                        0.01147                   False          0.553614        True                       None
2025-05-21 05:46:09,265 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Метод get_explanation_details не реализован специфично, будет использована реализация get_shap_explanations (если есть).
2025-05-21 05:46:09,266 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:46:09,266 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:46:09,267 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:46:09,267 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:46:09,267 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:46:09,268 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Вычисление SHAP values для 1 экземпляров...
2025-05-21 05:46:09,268 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Используется nsamples=50 для SHAP
2025-05-21 05:46:09,268 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Запрос SHAP объяснений: explainer=True, background_data_exists=True, model=True
2025-05-21 05:46:09,269 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Создание GradientExplainer с размерами данных: torch.Size([50, 4])
2025-05-21 05:46:09,287 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw type: <class 'numpy.ndarray'>
2025-05-21 05:46:09,288 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw (ndarray) shape: (1, 4, 1)
2025-05-21 05:46:09,288 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно создан и вычислены SHAP-значения
2025-05-21 05:46:09,288 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values_raw уже является ndarray, shape: (1, 4, 1)
2025-05-21 05:46:09,288 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Начальная форма shap_values_arr: (1, 4, 1), ndim: 3
2025-05-21 05:46:09,288 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values после squeeze(-1): (1, 4)
2025-05-21 05:46:09,289 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP values успешно вычислены для 1 экземпляров.
2025-05-21 05:46:09,289 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'transaction_vae_price': [{"shap_values": {"price": 38.267464385804296, "freight_value": -1.8212190986813797, "product_weight_g": 2.8664425011792476, "freight_to_price_ratio": -0.4031670334803337}}]
2025-05-21 05:46:09,289 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'transaction_vae_price' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,290 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.8859988417937514, "explanation": {"shap_values": {"price": 38.267464385804296, "freight_value": -1.8212190986813797, "product_weight_g": 2.8664425011792476, "freight_to_price_ratio": -0.4031670334803337}}}]
2025-05-21 05:46:09,290 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 26323, order_id: 0812eb902a67711a1cb742b3cdaa65ae, level: transaction): Detector Column: 'trans_category_price_outlier_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,290 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'category_price_outlier_model': CategoryPriceOutlierDetector
2025-05-21 05:46:09,297 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'category_price_outlier_model':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id  product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
26323              1  0812eb902a67711a1cb742b3cdaa65ae  489ae2aa008f021502940f251d4cce7f  e3b4998c7a498169dc7bce44e6bb6277  6735.0         194.31      2017-02-12 20:37:36  c6e2731c5b391845f6800c97401a43a9  utilidades_domesticas                 31.0                       875.0                 2.0           30000.0               60.0               61.0              33.0                    housewares             MS           SP  credit_card                   8.0        6929.31           5.0                           74.309637                0.028851                 0.942999                    True                           0.885999                                       1.0              0.398596                False                           0.15721                                   0.639983                 0.189451                           0.367431                        0.01147                   False          0.553614        True                       None
2025-05-21 05:46:09,297 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'category_price_outlier_model': [{"detector_specific_info": {"category": "utilidades_domesticas", "price": 6735.0, "category_mean_price": 90.63427371273713, "category_std_price": 140.19371115720259, "category_min_price": 3.06, "category_max_price": 6735.0, "category_count": 7380, "z_score": 47.394178179909765, "threshold": 2.8, "explanation": "Цена 6735.00 отличается от средней цены в категории 'utilidades_domesticas' (90.63) на 47.39 стандартных отклонений (порог: 2.8)."}}]
2025-05-21 05:46:09,298 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'category_price_outlier_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,298 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.8859988417937514, "explanation": {"shap_values": {"price": 38.267464385804296, "freight_value": -1.8212190986813797, "product_weight_g": 2.8664425011792476, "freight_to_price_ratio": -0.4031670334803337}}}, {"detector_name": "category_price_outlier_model", "detector_type": "CategoryPriceOutlierDetector", "score": 1.0, "explanation": {"detector_specific_info": {"category": "utilidades_domesticas", "price": 6735.0, "category_mean_price": 90.63427371273713, "category_std_price": 140.19371115720259, "category_min_price": 3.06, "category_max_price": 6735.0, "category_count": 7380, "z_score": 47.394178179909765, "threshold": 2.8, "explanation": "Цена 6735.00 отличается от средней цены в категории 'utilidades_domesticas' (90.63) на 47.39 стандартных отклонений (порог: 2.8)."}}}]
2025-05-21 05:46:09,298 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: transaction): Detector Column: 'trans_transaction_vae_price_score', Score: 0.9632, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,299 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'transaction_vae_price': TransactionVAEDetector
2025-05-21 05:46:09,305 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'transaction_vae_price':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
33735              1  fefacc66af859508bf1a7934eab1e97f  69c590f7ffc7bf8db97190b6cb6ed62e  80ceebb4ee9b31afb6c6a916a574a1e2  6729.0         193.21      2018-07-25 18:10:17  f48d464a0baaea338cb25f816991ab1f                   pcs                 50.0                      1935.0                 4.0            5660.0               54.0               18.0              47.0                     computers             ES           PR       boleto                   1.0        6922.21           NaN                            6.096825                0.028713                 0.573272                    True                           0.963203                                  0.183342              0.078431                False                          0.156863                                        0.0                 0.959618                                1.0                       0.919235                    True          0.540724        True                       None
2025-05-21 05:46:09,305 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Метод get_explanation_details не реализован специфично, будет использована реализация get_shap_explanations (если есть).
2025-05-21 05:46:09,307 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:46:09,307 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:46:09,308 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:46:09,308 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:46:09,308 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:46:09,309 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Вычисление SHAP values для 1 экземпляров...
2025-05-21 05:46:09,309 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Используется nsamples=50 для SHAP
2025-05-21 05:46:09,310 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Запрос SHAP объяснений: explainer=True, background_data_exists=True, model=True
2025-05-21 05:46:09,310 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Создание GradientExplainer с размерами данных: torch.Size([50, 4])
2025-05-21 05:46:09,326 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw type: <class 'numpy.ndarray'>
2025-05-21 05:46:09,326 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw (ndarray) shape: (1, 4, 1)
2025-05-21 05:46:09,326 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно создан и вычислены SHAP-значения
2025-05-21 05:46:09,326 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values_raw уже является ndarray, shape: (1, 4, 1)
2025-05-21 05:46:09,326 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Начальная форма shap_values_arr: (1, 4, 1), ndim: 3
2025-05-21 05:46:09,327 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values после squeeze(-1): (1, 4)
2025-05-21 05:46:09,327 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP values успешно вычислены для 1 экземпляров.
2025-05-21 05:46:09,327 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'transaction_vae_price': [{"shap_values": {"price": 42.61682323971959, "freight_value": 3.2823096826298355, "product_weight_g": -0.8580847055610086, "freight_to_price_ratio": -0.5183044681180908}}]
2025-05-21 05:46:09,328 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'transaction_vae_price' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,328 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.9632033612785232, "explanation": {"shap_values": {"price": 42.61682323971959, "freight_value": 3.2823096826298355, "product_weight_g": -0.8580847055610086, "freight_to_price_ratio": -0.5183044681180908}}}]
2025-05-21 05:46:09,328 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: transaction): Detector Column: 'trans_category_price_outlier_model_score', Score: 0.1833, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,329 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'category_price_outlier_model': CategoryPriceOutlierDetector
2025-05-21 05:46:09,334 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'category_price_outlier_model':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
33735              1  fefacc66af859508bf1a7934eab1e97f  69c590f7ffc7bf8db97190b6cb6ed62e  80ceebb4ee9b31afb6c6a916a574a1e2  6729.0         193.21      2018-07-25 18:10:17  f48d464a0baaea338cb25f816991ab1f                   pcs                 50.0                      1935.0                 4.0            5660.0               54.0               18.0              47.0                     computers             ES           PR       boleto                   1.0        6922.21           NaN                            6.096825                0.028713                 0.573272                    True                           0.963203                                  0.183342              0.078431                False                          0.156863                                        0.0                 0.959618                                1.0                       0.919235                    True          0.540724        True                       None
2025-05-21 05:46:09,335 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'category_price_outlier_model': [{"detector_specific_info": {"category": "pcs", "price": 6729.0, "category_mean_price": 1103.6891363636364, "category_std_price": 647.3819106149692, "category_min_price": 34.5, "category_max_price": 6729.0, "category_count": 220, "z_score": 8.68932352201917, "threshold": 2.8, "explanation": "Цена 6729.00 отличается от средней цены в категории 'pcs' (1103.69) на 8.69 стандартных отклонений (порог: 2.8)."}}]
2025-05-21 05:46:09,335 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'category_price_outlier_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,336 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 0.9632033612785232, "explanation": {"shap_values": {"price": 42.61682323971959, "freight_value": 3.2823096826298355, "product_weight_g": -0.8580847055610086, "freight_to_price_ratio": -0.5183044681180908}}}, {"detector_name": "category_price_outlier_model", "detector_type": "CategoryPriceOutlierDetector", "score": 0.18334153272699158, "explanation": {"detector_specific_info": {"category": "pcs", "price": 6729.0, "category_mean_price": 1103.6891363636364, "category_std_price": 647.3819106149692, "category_min_price": 34.5, "category_max_price": 6729.0, "category_count": 220, "z_score": 8.68932352201917, "threshold": 2.8, "explanation": "Цена 6729.00 отличается от средней цены в категории 'pcs' (1103.69) на 8.69 стандартных отклонений (порог: 2.8)."}}}]
2025-05-21 05:46:09,336 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,336 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:46:09,337 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-25 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,338 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-25 00:00:00
2025-05-21 05:46:09,340 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
579 2018-07-25          268     40753.19  122.750572             201               268               2018-07-25  35288.758571         1.154849           0.959618                                1.0                       0.919235    2018-07-25
2025-05-21 05:46:09,340 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:46:09,341 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,341 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:46:09,341 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 33735, order_id: fefacc66af859508bf1a7934eab1e97f, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9192, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,341 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:46:09,342 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-07-25 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,342 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-07-25 00:00:00
2025-05-21 05:46:09,345 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
579 2018-07-25          268     40753.19  122.750572             201               268               2018-07-25  35288.758571         1.154849           0.959618                                1.0                       0.919235    2018-07-25
2025-05-21 05:46:09,346 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-07-25 00:00:00", "current_value": 40753.19, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37057.18428571429, "deviation_in_std": 9.125707498979427, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (40753.19) отклоняется от базовой линии (3696.01) на 37057.18, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:46:09,346 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,346 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-07-25 00:00:00", "current_value": 40753.19, "expected_value": 25669.474712643678, "absolute_deviation": 15083.715287356325, "relative_deviation": 0.5876129315543311, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-07-25 00:00:00 значение total_sales (40753.19) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9192352183494302, "explanation": {"detector_specific_info": {"date": "2018-07-25 00:00:00", "current_value": 40753.19, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37057.18428571429, "deviation_in_std": 9.125707498979427, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (40753.19) отклоняется от базовой линии (3696.01) на 37057.18, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:46:09,347 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 42860, order_id: 90674f59a21207f91a7387785c66f340, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,347 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:46:09,347 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-14 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,348 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-14 00:00:00
2025-05-21 05:46:09,350 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
599 2018-08-14          315     44682.42  128.397759             228               315               2018-08-14  37562.228571         1.189557           0.989198                                1.0                       0.978396    2018-08-14
2025-05-21 05:46:09,350 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:46:09,350 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,351 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:46:09,351 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 42860, order_id: 90674f59a21207f91a7387785c66f340, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9784, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,351 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:46:09,352 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-14 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,353 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-14 00:00:00
2025-05-21 05:46:09,355 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
599 2018-08-14          315     44682.42  128.397759             228               315               2018-08-14  37562.228571         1.189557           0.989198                                1.0                       0.978396    2018-08-14
2025-05-21 05:46:09,355 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-14 00:00:00", "current_value": 44682.42, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 40986.41428571429, "deviation_in_std": 10.093320240405061, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (44682.42) отклоняется от базовой линии (3696.01) на 40986.41, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:46:09,355 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,356 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-14 00:00:00", "current_value": 44682.42, "expected_value": 26189.295057471263, "absolute_deviation": 18493.124942528735, "relative_deviation": 0.7061329792171336, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-14 00:00:00 значение total_sales (44682.42) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9783962277530719, "explanation": {"detector_specific_info": {"date": "2018-08-14 00:00:00", "current_value": 44682.42, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 40986.41428571429, "deviation_in_std": 10.093320240405061, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (44682.42) отклоняется от базовой линии (3696.01) на 40986.41, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:46:09,356 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: transaction): Detector Column: 'trans_transaction_vae_price_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,356 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'transaction_vae_price': TransactionVAEDetector
2025-05-21 05:46:09,362 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'transaction_vae_price':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
57579              1  3dd5626c63f493f8b8f8788c2be24baa  3a1855685a49813f60e6193864f7215e  c510bc1718f0f2961eaa42a23330681a  2699.0         306.06      2018-04-27 19:50:43  a8f345f82667eb421151dc7626147636                 bebes                 54.0                      2583.0                10.0           11450.0               57.0               78.0              44.0                          baby             SC           SP  credit_card                  10.0        3005.06           5.0                           19.887203                0.113398                 0.620279                    True                                1.0                                  0.240557              0.379093                False                          0.147594                                   0.610592                 0.823398                           0.928073                       0.718724                    True          0.608859        True                       None
2025-05-21 05:46:09,362 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Метод get_explanation_details не реализован специфично, будет использована реализация get_shap_explanations (если есть).
2025-05-21 05:46:09,364 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler type: <class 'sklearn.preprocessing._data.StandardScaler'>
2025-05-21 05:46:09,365 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler has mean_: True
2025-05-21 05:46:09,365 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler mean_ shape: (4,)
2025-05-21 05:46:09,365 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) [Detect_Preprocess] Scaler params: {'copy': True, 'with_mean': True, 'with_std': True}
2025-05-21 05:46:09,365 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler обучен (mean_ присутствует). Выполняется transform.
2025-05-21 05:46:09,366 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Вычисление SHAP values для 1 экземпляров...
2025-05-21 05:46:09,366 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Используется nsamples=50 для SHAP
2025-05-21 05:46:09,366 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Запрос SHAP объяснений: explainer=True, background_data_exists=True, model=True
2025-05-21 05:46:09,367 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Создание GradientExplainer с размерами данных: torch.Size([50, 4])
2025-05-21 05:46:09,384 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw type: <class 'numpy.ndarray'>
2025-05-21 05:46:09,385 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values raw (ndarray) shape: (1, 4, 1)
2025-05-21 05:46:09,385 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно создан и вычислены SHAP-значения
2025-05-21 05:46:09,385 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values_raw уже является ndarray, shape: (1, 4, 1)
2025-05-21 05:46:09,385 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) Начальная форма shap_values_arr: (1, 4, 1), ndim: 3
2025-05-21 05:46:09,386 - backend.ml_service.vae_detector - DEBUG - (transaction_vae_price) SHAP values после squeeze(-1): (1, 4)
2025-05-21 05:46:09,386 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP values успешно вычислены для 1 экземпляров.
2025-05-21 05:46:09,386 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'transaction_vae_price': [{"shap_values": {"price": 74.9342887364288, "freight_value": -29.08333607938732, "product_weight_g": -5.726937328425874, "freight_to_price_ratio": 2.901954277913369}}]
2025-05-21 05:46:09,387 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'transaction_vae_price' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,387 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 1.0, "explanation": {"shap_values": {"price": 74.9342887364288, "freight_value": -29.08333607938732, "product_weight_g": -5.726937328425874, "freight_to_price_ratio": 2.901954277913369}}}]
2025-05-21 05:46:09,387 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: transaction): Detector Column: 'trans_category_price_outlier_model_score', Score: 0.2406, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,388 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'category_price_outlier_model': CategoryPriceOutlierDetector
2025-05-21 05:46:09,394 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for transaction detector 'category_price_outlier_model':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
57579              1  3dd5626c63f493f8b8f8788c2be24baa  3a1855685a49813f60e6193864f7215e  c510bc1718f0f2961eaa42a23330681a  2699.0         306.06      2018-04-27 19:50:43  a8f345f82667eb421151dc7626147636                 bebes                 54.0                      2583.0                10.0           11450.0               57.0               78.0              44.0                          baby             SC           SP  credit_card                  10.0        3005.06           5.0                           19.887203                0.113398                 0.620279                    True                                1.0                                  0.240557              0.379093                False                          0.147594                                   0.610592                 0.823398                           0.928073                       0.718724                    True          0.608859        True                       None
2025-05-21 05:46:09,395 - backend.ml_service.multilevel_detector - DEBUG - Explanation from transaction detector 'category_price_outlier_model': [{"detector_specific_info": {"category": "bebes", "price": 2699.0, "category_mean_price": 135.71541510611735, "category_std_price": 224.82969338108902, "category_min_price": 3.54, "category_max_price": 3899.0, "category_count": 3204, "z_score": 11.401005562681993, "threshold": 2.8, "explanation": "Цена 2699.00 отличается от средней цены в категории 'bebes' (135.72) на 11.40 стандартных отклонений (порог: 2.8)."}}]
2025-05-21 05:46:09,395 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'category_price_outlier_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,396 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for transaction_level: [{"detector_name": "transaction_vae_price", "detector_type": "TransactionVAEDetector", "score": 1.0, "explanation": {"shap_values": {"price": 74.9342887364288, "freight_value": -29.08333607938732, "product_weight_g": -5.726937328425874, "freight_to_price_ratio": 2.901954277913369}}}, {"detector_name": "category_price_outlier_model", "detector_type": "CategoryPriceOutlierDetector", "score": 0.24055704531923383, "explanation": {"detector_specific_info": {"category": "bebes", "price": 2699.0, "category_mean_price": 135.71541510611735, "category_std_price": 224.82969338108902, "category_min_price": 3.54, "category_max_price": 3899.0, "category_count": 3204, "z_score": 11.401005562681993, "threshold": 2.8, "explanation": "Цена 2699.00 отличается от средней цены в категории 'bebes' (135.72) на 11.40 стандартных отклонений (порог: 2.8)."}}}]
2025-05-21 05:46:09,396 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.9281, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,396 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:46:09,396 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-04-27 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,397 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-04-27 00:00:00
2025-05-21 05:46:09,399 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
490 2018-04-27          242     41231.39  140.242823             165               242               2018-04-27  35298.295714         1.168084           0.823398                           0.928073                       0.718724    2018-04-27
2025-05-21 05:46:09,400 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:46:09,400 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,400 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9280726698190791, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:46:09,401 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 57579, order_id: 3dd5626c63f493f8b8f8788c2be24baa, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.7187, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,401 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:46:09,401 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-04-27 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,402 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-04-27 00:00:00
2025-05-21 05:46:09,404 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
490 2018-04-27          242     41231.39  140.242823             165               242               2018-04-27  35298.295714         1.168084           0.823398                           0.928073                       0.718724    2018-04-27
2025-05-21 05:46:09,404 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-04-27 00:00:00", "current_value": 41231.39, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37535.38428571429, "deviation_in_std": 9.243469099331083, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (41231.39) отклоняется от базовой линии (3696.01) на 37535.38, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:46:09,405 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,405 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9280726698190791, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-04-27 00:00:00", "current_value": 41231.39, "expected_value": 23364.508863636365, "absolute_deviation": 17866.881136363634, "relative_deviation": 0.7647017637152634, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-04-27 00:00:00 значение total_sales (41231.39) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.718723936134046, "explanation": {"detector_specific_info": {"date": "2018-04-27 00:00:00", "current_value": 41231.39, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 37535.38428571429, "deviation_in_std": 9.243469099331083, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (41231.39) отклоняется от базовой линии (3696.01) на 37535.38, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:46:09,405 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 74778, order_id: 94fca82966c05ba707f4e7dc0c50aa3c, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,405 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:46:09,406 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,407 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:46:09,409 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:46:09,409 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}]
2025-05-21 05:46:09,409 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,410 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}]
2025-05-21 05:46:09,410 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 74778, order_id: 94fca82966c05ba707f4e7dc0c50aa3c, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.9819, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,410 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:46:09,410 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-08-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,411 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-08-15 00:00:00
2025-05-21 05:46:09,413 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
600 2018-08-15          285      46326.8  141.672171             208               285               2018-08-15  37936.561429         1.221165           0.990972                                1.0                       0.981944    2018-08-15
2025-05-21 05:46:09,413 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:46:09,414 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,414 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-08-15 00:00:00", "current_value": 46326.8, "expected_value": 25669.474712643678, "absolute_deviation": 20657.325287356325, "relative_deviation": 0.8047428129560211, "threshold": 2.5, "day_of_week": 2, "anomaly_factors": [], "explanation_text": "Для даты 2018-08-15 00:00:00 значение total_sales (46326.80) в пределах нормальных отклонений от сезонного паттерна (25669.47)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.9819435388597458, "explanation": {"detector_specific_info": {"date": "2018-08-15 00:00:00", "current_value": 46326.8, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42630.79428571429, "deviation_in_std": 10.498265494244997, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46326.80) отклоняется от базовой линии (3696.01) на 42630.79, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:46:09,414 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: behavior): Detector Column: 'behav_graph_graph_analysis_score', Score: 0.1563, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,414 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'graph_graph_analysis': GraphAnomalyDetector
2025-05-21 05:46:09,416 - backend.ml_service.multilevel_detector - DEBUG -     Using original row data for graph detector
2025-05-21 05:46:09,420 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for behavior detector 'graph_graph_analysis':
       order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
82846              1  a53e05ecd2ed1f46a2b8e1f5828be7c6  dd113cb02b2af9c8e5787e8f1f0722f6  821fb029fc6e495ca4f08a35d51e53a5  3690.0          136.8      2018-01-26 14:30:21  addc91fdf9c2b3045497b57fc710e820         esporte_lazer                 51.0                      1511.0                 1.0            8000.0               55.0               25.0              45.0                sports_leisure             MG           SP  credit_card                  10.0         3826.8           5.0                           32.269459                0.037073                  0.45627                   False                           0.448166                                  0.464374              0.433102                 True                          0.156335                                   0.709869                 0.722093                           0.948138                       0.496047                    True          0.529066        True                       None
2025-05-21 05:46:09,421 - backend.ml_service.graph_detector - INFO - Построение графа...
2025-05-21 05:46:09,421 - backend.ml_service.graph_detector - INFO - Граф построен за 0.00 сек. Узлов: 5, Ребер: 4
2025-05-21 05:46:09,422 - backend.ml_service.multilevel_detector - DEBUG - Explanation from behavior detector 'graph_graph_analysis': [{"detector_specific_info": {"raw_graph_metrics": {"num_seller_states": 1.0, "num_product_categories": 1.0, "seller_degree": 1.0}, "normalized_graph_metrics": {"norm_num_seller_states": 0.0, "norm_num_product_categories": 0.3333333333333333, "norm_seller_degree": 0.0}, "weights": {"seller_state_weight": 0.3, "category_diversity_weight": 0.4, "seller_degree_weight": 0.3}, "final_score": 0.13333333333333333, "explanation": "Продавец связан с 1 другими узлами в графе, что обычно."}}]
2025-05-21 05:46:09,422 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'graph_graph_analysis' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,422 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for behavior_level: [{"detector_name": "graph_graph_analysis", "detector_type": "GraphAnomalyDetector", "score": 0.1563352375070763, "explanation": {"detector_specific_info": {"raw_graph_metrics": {"num_seller_states": 1.0, "num_product_categories": 1.0, "seller_degree": 1.0}, "normalized_graph_metrics": {"norm_num_seller_states": 0.0, "norm_num_product_categories": 0.3333333333333333, "norm_seller_degree": 0.0}, "weights": {"seller_state_weight": 0.3, "category_diversity_weight": 0.4, "seller_degree_weight": 0.3}, "final_score": 0.13333333333333333, "explanation": "Продавец связан с 1 другими узлами в графе, что обычно."}}}]
2025-05-21 05:46:09,422 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: behavior): Detector Column: 'behav_seller_pricing_behavior_model_score', Score: 0.7099, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,422 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seller_pricing_behavior_model': SellerPricingBehaviorDetector
2025-05-21 05:46:09,423 - backend.ml_service.multilevel_detector - DEBUG -     Looking for seller_id=821fb029fc6e495ca4f08a35d51e53a5 in aggregated_behavior_data_with_scores
2025-05-21 05:46:09,423 - backend.ml_service.multilevel_detector - DEBUG -     Found matching seller_id row in aggregated data
2025-05-21 05:46:09,426 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for behavior detector 'seller_pricing_behavior_model':
                             seller_id  mean_price   std_price  count  min_price  max_price  mean_freight  std_freight                                                                   categories  category_count  price_volatility  price_range_ratio  freight_to_price_ratio  unique_categories  category_diversity  normalized_diversity  behavior_score  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score
1601  821fb029fc6e495ca4f08a35d51e53a5  652.547333  931.135718     30       17.9     4059.0     54.545667    29.185866  [esporte_lazer, casa_construcao, utilidades_domesticas, eletrodomesticos_2]               4          1.426924         226.759777                0.083589                  4            0.133333              0.482995        0.433102                          0.156335                                   0.709869
2025-05-21 05:46:09,426 - backend.ml_service.multilevel_detector - DEBUG - Explanation from behavior detector 'seller_pricing_behavior_model': [{"detector_specific_info": {"seller_id": "821fb029fc6e495ca4f08a35d51e53a5", "anomaly_factors": [{"factor": "price_volatility", "value": 1.4269244090555202, "threshold": 0.5, "description": "Высокая волатильность цен (1.43 > 0.50)"}, {"factor": "price_range_ratio", "value": 226.75977653631287, "threshold": 5.0, "description": "Широкий диапазон цен (max/min = 226.76 > 5.00)"}], "text_explanation": "Выявлены следующие аномалии в ценовом поведении продавца:\n- Высокая волатильность цен (1.43 > 0.50)\n- Широкий диапазон цен (max/min = 226.76 > 5.00)", "raw_metrics": {"mean_price": 652.5473333333333, "std_price": 931.1357179974221, "price_volatility": 1.4269244090555202, "price_range_ratio": 226.75977653631287, "freight_to_price_ratio": 0.0835888277836295, "transaction_count": 30}}}]
2025-05-21 05:46:09,426 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seller_pricing_behavior_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,427 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for behavior_level: [{"detector_name": "graph_graph_analysis", "detector_type": "GraphAnomalyDetector", "score": 0.1563352375070763, "explanation": {"detector_specific_info": {"raw_graph_metrics": {"num_seller_states": 1.0, "num_product_categories": 1.0, "seller_degree": 1.0}, "normalized_graph_metrics": {"norm_num_seller_states": 0.0, "norm_num_product_categories": 0.3333333333333333, "norm_seller_degree": 0.0}, "weights": {"seller_state_weight": 0.3, "category_diversity_weight": 0.4, "seller_degree_weight": 0.3}, "final_score": 0.13333333333333333, "explanation": "Продавец связан с 1 другими узлами в графе, что обычно."}}}, {"detector_name": "seller_pricing_behavior_model", "detector_type": "SellerPricingBehaviorDetector", "score": 0.7098685117282175, "explanation": {"detector_specific_info": {"seller_id": "821fb029fc6e495ca4f08a35d51e53a5", "anomaly_factors": [{"factor": "price_volatility", "value": 1.4269244090555202, "threshold": 0.5, "description": "Высокая волатильность цен (1.43 > 0.50)"}, {"factor": "price_range_ratio", "value": 226.75977653631287, "threshold": 5.0, "description": "Широкий диапазон цен (max/min = 226.76 > 5.00)"}], "text_explanation": "Выявлены следующие аномалии в ценовом поведении продавца:\n- Высокая волатильность цен (1.43 > 0.50)\n- Широкий диапазон цен (max/min = 226.76 > 5.00)", "raw_metrics": {"mean_price": 652.5473333333333, "std_price": 931.1357179974221, "price_volatility": 1.4269244090555202, "price_range_ratio": 226.75977653631287, "freight_to_price_ratio": 0.0835888277836295, "transaction_count": 30}}}}]
2025-05-21 05:46:09,427 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.9481, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,427 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:46:09,428 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-01-26 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,429 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-01-26 00:00:00
2025-05-21 05:46:09,431 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
399 2018-01-26          228     34533.35  125.575818             151               228               2018-01-26       31895.5         1.082703           0.722093                           0.948138                       0.496047    2018-01-26
2025-05-21 05:46:09,431 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}]
2025-05-21 05:46:09,431 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,432 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9481383115297547, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}]
2025-05-21 05:46:09,432 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 82846, order_id: a53e05ecd2ed1f46a2b8e1f5828be7c6, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.4960, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,432 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:46:09,433 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-01-26 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,433 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-01-26 00:00:00
2025-05-21 05:46:09,436 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
399 2018-01-26          228     34533.35  125.575818             151               228               2018-01-26       31895.5         1.082703           0.722093                           0.948138                       0.496047    2018-01-26
2025-05-21 05:46:09,436 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-01-26 00:00:00", "current_value": 34533.35, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 30837.344285714284, "deviation_in_std": 7.594008811544785, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34533.35) отклоняется от базовой линии (3696.01) на 30837.34, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:46:09,437 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,437 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.9481383115297547, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-01-26 00:00:00", "current_value": 34533.35, "expected_value": 23364.508863636365, "absolute_deviation": 11168.841136363633, "relative_deviation": 0.47802593247514796, "threshold": 2.5, "day_of_week": 4, "anomaly_factors": [], "explanation_text": "Для даты 2018-01-26 00:00:00 значение total_sales (34533.35) в пределах нормальных отклонений от сезонного паттерна (23364.51)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.496047165599019, "explanation": {"detector_specific_info": {"date": "2018-01-26 00:00:00", "current_value": 34533.35, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 30837.344285714284, "deviation_in_std": 7.594008811544785, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34533.35) отклоняется от базовой линии (3696.01) на 30837.34, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:46:09,437 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87594, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8164, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,437 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:46:09,438 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,439 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:46:09,440 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:46:09,441 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:46:09,441 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,441 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:46:09,441 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87594, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8123, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,442 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:46:09,442 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,443 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:46:09,444 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:46:09,445 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:46:09,445 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,446 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8122690239748033, "explanation": {"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:46:09,446 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87595, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 0.8164, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,446 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:46:09,446 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,447 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:46:09,450 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:46:09,450 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}]
2025-05-21 05:46:09,451 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,451 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}]
2025-05-21 05:46:09,451 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 87595, order_id: 9de73f3e6157169ad6c32b9f313c7dcb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.8123, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,451 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:46:09,451 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-06-05 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,452 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-06-05 00:00:00
2025-05-21 05:46:09,454 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
529 2018-06-05          197     34830.15  141.585976             150               197               2018-06-05       28474.0         1.223226           0.814356                           0.816442                       0.812269    2018-06-05
2025-05-21 05:46:09,455 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:46:09,455 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,455 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 0.816442063316561, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-06-05 00:00:00", "current_value": 34830.15, "expected_value": 26189.295057471263, "absolute_deviation": 8640.854942528738, "relative_deviation": 0.3299384318503709, "threshold": 2.5, "day_of_week": 1, "anomaly_factors": [], "explanation_text": "Для даты 2018-06-05 00:00:00 значение total_sales (34830.15) в пределах нормальных отклонений от сезонного паттерна (26189.30)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.8122690239748033, "explanation": {"detector_specific_info": {"date": "2018-06-05 00:00:00", "current_value": 34830.15, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 31134.144285714287, "deviation_in_std": 7.667098821967979, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (34830.15) отклоняется от базовой линии (3696.01) на 31134.14, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:46:09,456 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: behavior): Detector Column: 'behav_graph_graph_analysis_score', Score: 0.1973, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,456 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'graph_graph_analysis': GraphAnomalyDetector
2025-05-21 05:46:09,457 - backend.ml_service.multilevel_detector - DEBUG -     Using original row data for graph detector
2025-05-21 05:46:09,461 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for behavior detector 'graph_graph_analysis':
        order_item_id                          order_id                        product_id                         seller_id   price  freight_value order_purchase_timestamp                       customer_id product_category_name  product_name_lenght  product_description_lenght  product_photos_qty  product_weight_g  product_length_cm  product_height_cm  product_width_cm product_category_name_english customer_state seller_state payment_type  payment_installments  payment_value  review_score  price_deviation_from_category_mean  freight_to_price_ratio  transaction_level_score  transaction_is_anomaly  trans_transaction_vae_price_score  trans_category_price_outlier_model_score  behavior_level_score  behavior_is_anomaly  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score  time_series_level_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score  time_series_is_anomaly  multilevel_score  is_anomaly detailed_explanations_json
116453              1  a5d11ae16578088b0fcd76de30368bdb  0abc19e41fdc9d6894b8cae651619253  17e34d8224d27a541263c4c64b11a56b  2433.6         157.01      2018-03-15 16:56:41  9c5d7103954595e173781530b10d02e4           eletronicos                 60.0                      3109.0                 6.0           15750.0               70.0               90.0              20.0                   electronics             MG           SP  credit_card                   6.0        2590.61           1.0                           41.495791                0.064518                 0.360232                   False                           0.322136                                  0.398328              0.492535                 True                          0.197347                                   0.787723                 0.804803                                1.0                       0.609605                    True          0.533294        True                       None
2025-05-21 05:46:09,462 - backend.ml_service.graph_detector - INFO - Построение графа...
2025-05-21 05:46:09,462 - backend.ml_service.graph_detector - INFO - Граф построен за 0.00 сек. Узлов: 5, Ребер: 4
2025-05-21 05:46:09,463 - backend.ml_service.multilevel_detector - DEBUG - Explanation from behavior detector 'graph_graph_analysis': [{"detector_specific_info": {"raw_graph_metrics": {"num_seller_states": 1.0, "num_product_categories": 1.0, "seller_degree": 1.0}, "normalized_graph_metrics": {"norm_num_seller_states": 0.0, "norm_num_product_categories": 0.3333333333333333, "norm_seller_degree": 0.0}, "weights": {"seller_state_weight": 0.3, "category_diversity_weight": 0.4, "seller_degree_weight": 0.3}, "final_score": 0.13333333333333333, "explanation": "Продавец связан с 1 другими узлами в графе, что обычно."}}]
2025-05-21 05:46:09,463 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'graph_graph_analysis' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,463 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for behavior_level: [{"detector_name": "graph_graph_analysis", "detector_type": "GraphAnomalyDetector", "score": 0.19734741437371478, "explanation": {"detector_specific_info": {"raw_graph_metrics": {"num_seller_states": 1.0, "num_product_categories": 1.0, "seller_degree": 1.0}, "normalized_graph_metrics": {"norm_num_seller_states": 0.0, "norm_num_product_categories": 0.3333333333333333, "norm_seller_degree": 0.0}, "weights": {"seller_state_weight": 0.3, "category_diversity_weight": 0.4, "seller_degree_weight": 0.3}, "final_score": 0.13333333333333333, "explanation": "Продавец связан с 1 другими узлами в графе, что обычно."}}}]
2025-05-21 05:46:09,463 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: behavior): Detector Column: 'behav_seller_pricing_behavior_model_score', Score: 0.7877, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,464 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seller_pricing_behavior_model': SellerPricingBehaviorDetector
2025-05-21 05:46:09,464 - backend.ml_service.multilevel_detector - DEBUG -     Looking for seller_id=17e34d8224d27a541263c4c64b11a56b in aggregated_behavior_data_with_scores
2025-05-21 05:46:09,465 - backend.ml_service.multilevel_detector - DEBUG -     Found matching seller_id row in aggregated data
2025-05-21 05:46:09,467 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for behavior detector 'seller_pricing_behavior_model':
                            seller_id  mean_price  std_price  count  min_price  max_price  mean_freight  std_freight                                                                                                                                                                                            categories  category_count  price_volatility  price_range_ratio  freight_to_price_ratio  unique_categories  category_diversity  normalized_diversity  behavior_score  behav_graph_graph_analysis_score  behav_seller_pricing_behavior_model_score
280  17e34d8224d27a541263c4c64b11a56b  209.793043  277.45163    276       9.83     2470.5     19.562464    15.354323  [consoles_games, perfumaria, informatica_acessorios, cool_stuff, ferramentas_jardim, telefonia, eletronicos, construcao_ferramentas_construcao, beleza_saude, telefonia_fixa, esporte_lazer, musica]              12          1.322502         251.322482                0.093246                 12            0.043478              0.769745        0.492535                          0.197347                                   0.787723
2025-05-21 05:46:09,468 - backend.ml_service.multilevel_detector - DEBUG - Explanation from behavior detector 'seller_pricing_behavior_model': [{"detector_specific_info": {"seller_id": "17e34d8224d27a541263c4c64b11a56b", "anomaly_factors": [{"factor": "price_volatility", "value": 1.322501574399623, "threshold": 0.5, "description": "Высокая волатильность цен (1.32 > 0.50)"}, {"factor": "price_range_ratio", "value": 251.32248219735504, "threshold": 5.0, "description": "Широкий диапазон цен (max/min = 251.32 > 5.00)"}], "text_explanation": "Выявлены следующие аномалии в ценовом поведении продавца:\n- Высокая волатильность цен (1.32 > 0.50)\n- Широкий диапазон цен (max/min = 251.32 > 5.00)", "raw_metrics": {"mean_price": 209.79304347826087, "std_price": 277.45163029808856, "price_volatility": 1.322501574399623, "price_range_ratio": 251.32248219735504, "freight_to_price_ratio": 0.0932464844581133, "transaction_count": 276}}}]
2025-05-21 05:46:09,468 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seller_pricing_behavior_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,469 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for behavior_level: [{"detector_name": "graph_graph_analysis", "detector_type": "GraphAnomalyDetector", "score": 0.19734741437371478, "explanation": {"detector_specific_info": {"raw_graph_metrics": {"num_seller_states": 1.0, "num_product_categories": 1.0, "seller_degree": 1.0}, "normalized_graph_metrics": {"norm_num_seller_states": 0.0, "norm_num_product_categories": 0.3333333333333333, "norm_seller_degree": 0.0}, "weights": {"seller_state_weight": 0.3, "category_diversity_weight": 0.4, "seller_degree_weight": 0.3}, "final_score": 0.13333333333333333, "explanation": "Продавец связан с 1 другими узлами в графе, что обычно."}}}, {"detector_name": "seller_pricing_behavior_model", "detector_type": "SellerPricingBehaviorDetector", "score": 0.7877234956436056, "explanation": {"detector_specific_info": {"seller_id": "17e34d8224d27a541263c4c64b11a56b", "anomaly_factors": [{"factor": "price_volatility", "value": 1.322501574399623, "threshold": 0.5, "description": "Высокая волатильность цен (1.32 > 0.50)"}, {"factor": "price_range_ratio", "value": 251.32248219735504, "threshold": 5.0, "description": "Широкий диапазон цен (max/min = 251.32 > 5.00)"}], "text_explanation": "Выявлены следующие аномалии в ценовом поведении продавца:\n- Высокая волатильность цен (1.32 > 0.50)\n- Широкий диапазон цен (max/min = 251.32 > 5.00)", "raw_metrics": {"mean_price": 209.79304347826087, "std_price": 277.45163029808856, "price_volatility": 1.322501574399623, "price_range_ratio": 251.32248219735504, "freight_to_price_ratio": 0.0932464844581133, "transaction_count": 276}}}}]
2025-05-21 05:46:09,469 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: time_series): Detector Column: 'ts_seasonal_deviation_model_score', Score: 1.0000, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,469 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'seasonal_deviation_model': SeasonalDeviationDetector
2025-05-21 05:46:09,470 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-03-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,470 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-03-15 00:00:00
2025-05-21 05:46:09,472 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'seasonal_deviation_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
447 2018-03-15          286      46096.4  135.180059             174               286               2018-03-15  32494.021429         1.418612           0.804803                                1.0                       0.609605    2018-03-15
2025-05-21 05:46:09,473 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'seasonal_deviation_model': [{"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}]
2025-05-21 05:46:09,473 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'seasonal_deviation_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,473 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}}]
2025-05-21 05:46:09,473 - backend.ml_service.multilevel_detector - DEBUG - Anomaly Explanation Check (idx: 116453, order_id: a5d11ae16578088b0fcd76de30368bdb, level: time_series): Detector Column: 'ts_cumulative_sum_model_score', Score: 0.6096, Threshold: 0.05, Passes Threshold: True
2025-05-21 05:46:09,474 - backend.ml_service.multilevel_detector - DEBUG -     Detector instance for 'cumulative_sum_model': CumulativeSumDetector
2025-05-21 05:46:09,474 - backend.ml_service.multilevel_detector - DEBUG -     Looking for date=2018-03-15 00:00:00 in aggregated_ts_data_with_scores using column 'date'
2025-05-21 05:46:09,475 - backend.ml_service.multilevel_detector - DEBUG -     Found matching date row(s) in aggregated data for 2018-03-15 00:00:00
2025-05-21 05:46:09,477 - backend.ml_service.multilevel_detector - DEBUG - Data for get_explanation_details for time_series detector 'cumulative_sum_model':
          date  order_count  total_sales   avg_price  unique_sellers  unique_customers order_purchase_timestamp  sales_7d_avg  sales_deviation  time_series_score  ts_seasonal_deviation_model_score  ts_cumulative_sum_model_score merge_date_ts
447 2018-03-15          286      46096.4  135.180059             174               286               2018-03-15  32494.021429         1.418612           0.804803                                1.0                       0.609605    2018-03-15
2025-05-21 05:46:09,477 - backend.ml_service.multilevel_detector - DEBUG - Explanation from time_series detector 'cumulative_sum_model': [{"detector_specific_info": {"date": "2018-03-15 00:00:00", "current_value": 46096.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42400.39428571429, "deviation_in_std": 10.441527157312704, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46096.40) отклоняется от базовой линии (3696.01) на 42400.39, но накопленный эффект не достаточен для объявления аномалии."}}]
2025-05-21 05:46:09,478 - backend.ml_service.multilevel_detector - DEBUG -     Explanation for 'cumulative_sum_model' IS NOT EMPTY. Appending to list.
2025-05-21 05:46:09,478 - backend.ml_service.multilevel_detector - DEBUG -     Appended. Current explanations for time_series_level: [{"detector_name": "seasonal_deviation_model", "detector_type": "SeasonalDeviationDetector", "score": 1.0, "explanation": {"detector_specific_info": {"metric_name": "total_sales", "date": "2018-03-15 00:00:00", "current_value": 46096.4, "expected_value": 24263.594318181815, "absolute_deviation": 21832.805681818187, "relative_deviation": 0.8998174547230158, "threshold": 2.5, "day_of_week": 3, "anomaly_factors": [], "explanation_text": "Для даты 2018-03-15 00:00:00 значение total_sales (46096.40) в пределах нормальных отклонений от сезонного паттерна (24263.59)."}}}, {"detector_name": "cumulative_sum_model", "detector_type": "CumulativeSumDetector", "score": 0.609605020859105, "explanation": {"detector_specific_info": {"date": "2018-03-15 00:00:00", "current_value": 46096.4, "baseline_mean": 3696.0057142857145, "baseline_std": 4060.74644512314, "deviation": 42400.39428571429, "deviation_in_std": 10.441527157312704, "pos_cusum": null, "neg_cusum": null, "max_cusum": 0.0, "threshold": 2.5, "triggered_cusum_type": null, "anomaly_factors": [], "explanation_text": "Значение (46096.40) отклоняется от базовой линии (3696.01) на 42400.39, но накопленный эффект не достаточен для объявления аномалии."}}}]
2025-05-21 05:46:09,480 - backend.ml_service.multilevel_detector - INFO - Сгенерированы объяснения для 12 из 12 аномалий
2025-05-21 05:46:09,480 - backend.ml_service.multilevel_detector - INFO - Многоуровневая детекция завершена. Обнаружено 12 аномалий.
2025-05-21 05:46:09,494 - backend.ml_service.multilevel_service - INFO - Обнаружено 12 multilevel аномалий до сохранения.
2025-05-21 05:46:09,495 - backend.ml_service.multilevel_service - INFO - Начало сохранения multilevel аномалий в БД...
2025-05-21 05:46:09,551 - backend.ml_service.multilevel_service - INFO - Статистика сохранения multilevel аномалий: {'total_detected_anomalies_before_save': 12, 'newly_saved_anomalies_count': 11, 'newly_saved_anomaly_ids': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], 'skipped_duplicates_count': 1, 'errors_on_save': 0}
2025-05-21 05:46:09,552 - backend.ml_service.multilevel_service - DEBUG - Сессия БД (db_for_crud) для multilevel detect закрыта.
2025-05-21 05:46:09,552 - backend.ml_service.multilevel_service - DEBUG - Сессия БД (db_for_load_detect) для multilevel detect закрыта.
2025-05-21 05:46:09,578 - backend.ml_service.multilevel_service - INFO - [TaskID: 220fbbdd-8e76-41f8-97d0-f31d461ed31f] Детекция и сохранение аномалий успешно завершены.
2025-05-21 05:49:17,992 - backend.ml_service - INFO - Логирование настроено с уровнем DEBUG
2025-05-21 05:49:17,992 - backend.ml_service - INFO - Логи записываются в файл: C:\Users\alex\Desktop\AnomaLens3.0\logs\ml_service_2025-05-21.log
2025-05-21 05:49:21,519 - backend.ml_service.multilevel_service - INFO - Базовый путь для моделей (MultilevelService): C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models
2025-05-21 05:49:21,519 - backend.ml_service.multilevel_service - INFO - Создание/инициализация многоуровневой системы на основе настроек из config.yaml.
2025-05-21 05:49:21,520 - backend.ml_service.multilevel_service - DEBUG - Используется следующая конфигурация для MultilevelAnomalyDetector: {
  "transaction_level": [
    {
      "type": "transaction_vae",
      "model_filename": "ml_trans_vae_model.joblib",
      "weight": 1.0,
      "features": [
        "price",
        "freight_value",
        "product_weight_g",
        "freight_to_price_ratio"
      ],
      "encoding_dim": 10,
      "hidden_dim1": 32,
      "hidden_dim2": 16,
      "epochs": 25,
      "kld_weight": 0.5,
      "dropout_rate": 0.1,
      "shap_background_samples": 50
    },
    {
      "type": "category_price_outlier",
      "model_filename": "ml_category_price_model.joblib",
      "weight": 1.0,
      "category_col": "product_category_name",
      "price_col": "price",
      "threshold": 2.8,
      "min_samples_per_category": 10
    }
  ],
  "behavior_level": [
    {
      "type": "graph",
      "model_filename": "ml_graph_model_v3.joblib",
      "weight": 1.0,
      "use_seller_state_spread": true,
      "use_category_diversity": true,
      "use_seller_degree": true,
      "seller_state_weight": 0.3,
      "category_diversity_weight": 0.4,
      "seller_degree_weight": 0.3
    },
    {
      "type": "seller_pricing_behavior",
      "model_filename": "ml_seller_pricing_model.joblib",
      "weight": 1.0,
      "volatility_threshold": 0.5,
      "range_threshold": 5.0,
      "freight_ratio_threshold": 1.0,
      "min_transactions": 5
    }
  ],
  "time_series_level": [
    {
      "type": "seasonal_deviation",
      "model_filename": "seasonal_deviation_model.joblib",
      "weight": 1.0,
      "window_size": 7,
      "threshold": 2.5
    },
    {
      "type": "cumulative_sum",
      "model_filename": "cumulative_sum_model.joblib",
      "weight": 1.0,
      "window_size": 14,
      "threshold": 2.5,
      "drift_threshold": 4.5
    }
  ],
  "combination_weights": {
    "transaction": 0.4,
    "behavior": 0.3,
    "time_series": 0.3
  },
  "transaction_level_combination_method": "weighted_average",
  "behavior_level_combination_method": "weighted_average",
  "time_series_level_combination_method": "average"
}
2025-05-21 05:49:21,521 - backend.ml_service.multilevel_detector - INFO - Инициализация многоуровневой системы обнаружения аномалий...
2025-05-21 05:49:21,522 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'transaction'...
2025-05-21 05:49:21,522 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) VAEDetector инициализирован. Устройство: cpu, Входная размерность: 4, Признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio']
2025-05-21 05:49:21,522 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Сброс базового состояния детектора (из AnomalyDetector._reset_state).
2025-05-21 05:49:21,522 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Специфичное состояние VAEDetector (порог, SHAP) сброшено.
2025-05-21 05:49:21,523 - backend.ml_service.transaction_detectors - INFO - (transaction_vae_price) TransactionVAEDetector инициализирован. Конфигурационные признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], Реально используемые признаки (с генерируемыми): ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], encoding_dim(latent_dim): 10, hidden_dim1(hidden_dim): 32, hidden_dim2: 16, epochs: 25, batch_size: 64, lr: 0.001, kld_w: 0.5, dropout: 0.1
2025-05-21 05:49:21,523 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора transaction_vae_price типа transaction_vae
2025-05-21 05:49:21,523 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_trans_vae_model.joblib' установлен для transaction_vae_price
2025-05-21 05:49:21,523 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib'
2025-05-21 05:49:21,524 - backend.ml_service.detector - INFO - Попытка загрузки модели transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib...
2025-05-21 05:49:21,546 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Загружен порог аномальности: 3.656726
2025-05-21 05:49:21,547 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler успешно инициализирован с параметрами: n_features_in_=4, mean_=(4,), scale_=(4,)
2025-05-21 05:49:21,547 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Фоновые данные SHAP загружены (torch.Size([50, 4]))
2025-05-21 05:49:21,552 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Модель VAE успешно загружена и перемещена на cpu.
2025-05-21 05:49:21,553 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Попытка пересоздания SHAP GradientExplainer после загрузки...
2025-05-21 05:49:21,559 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно ПЕРЕСОЗДАН при загрузке модели. Device=cpu, background_data.shape=torch.Size([50, 4])
2025-05-21 05:49:21,560 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Статус SHAP после загрузки: background_data shape=torch.Size([50, 4]), device=cpu, explainer=создан
2025-05-21 05:49:21,560 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детектор VAE (is_trained=True) успешно загружен.
2025-05-21 05:49:21,560 - backend.ml_service.detector - INFO - Модель transaction_vae_price успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib. is_trained=True
2025-05-21 05:49:21,561 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib
2025-05-21 05:49:21,561 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib.
2025-05-21 05:49:21,561 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) инициализирован с весом 1.0.
2025-05-21 05:49:21,561 - backend.ml_service.transaction_detectors - INFO - CategoryPriceOutlierDetector 'category_price_outlier_model' инициализирован с параметрами: category_col='product_category_name', price_col='price', threshold=2.8, min_samples_per_category=10
2025-05-21 05:49:21,561 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора category_price_outlier_model типа category_price_outlier
2025-05-21 05:49:21,562 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_category_price_model.joblib' установлен для category_price_outlier_model
2025-05-21 05:49:21,562 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib'
2025-05-21 05:49:21,562 - backend.ml_service.detector - INFO - Попытка загрузки модели category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib...
2025-05-21 05:49:21,565 - backend.ml_service.detector - INFO - Модель category_price_outlier_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib. is_trained=True
2025-05-21 05:49:21,568 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib
2025-05-21 05:49:21,568 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib.
2025-05-21 05:49:21,568 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) инициализирован с весом 1.0.
2025-05-21 05:49:21,569 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'behavior'...
2025-05-21 05:49:21,569 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора graph_graph_analysis типа graph
2025-05-21 05:49:21,569 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_graph_model_v3.joblib' установлен для graph_graph_analysis
2025-05-21 05:49:21,569 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib'
2025-05-21 05:49:21,569 - backend.ml_service.detector - INFO - Попытка загрузки модели graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib...
2025-05-21 05:49:21,570 - backend.ml_service.detector - INFO - Модель graph_graph_analysis успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib. is_trained=True
2025-05-21 05:49:21,570 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib
2025-05-21 05:49:21,570 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib.
2025-05-21 05:49:21,570 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) инициализирован с весом 1.0.
2025-05-21 05:49:21,571 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seller_pricing_behavior_model типа seller_pricing_behavior
2025-05-21 05:49:21,571 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_seller_pricing_model.joblib' установлен для seller_pricing_behavior_model
2025-05-21 05:49:21,571 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib'
2025-05-21 05:49:21,571 - backend.ml_service.detector - INFO - Попытка загрузки модели seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib...
2025-05-21 05:49:21,572 - backend.ml_service.detector - INFO - Модель seller_pricing_behavior_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib. is_trained=True
2025-05-21 05:49:21,572 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib
2025-05-21 05:49:21,573 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib.
2025-05-21 05:49:21,573 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) инициализирован с весом 1.0.
2025-05-21 05:49:21,574 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'time_series'...
2025-05-21 05:49:21,574 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seasonal_deviation_model типа seasonal_deviation
2025-05-21 05:49:21,574 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='seasonal_deviation_model.joblib' установлен для seasonal_deviation_model
2025-05-21 05:49:21,575 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib'
2025-05-21 05:49:21,575 - backend.ml_service.detector - INFO - Попытка загрузки модели seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib...
2025-05-21 05:49:21,576 - backend.ml_service.detector - INFO - Модель seasonal_deviation_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib. is_trained=True
2025-05-21 05:49:21,576 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib
2025-05-21 05:49:21,577 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib.
2025-05-21 05:49:21,577 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) инициализирован с весом 1.0.
2025-05-21 05:49:21,577 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора cumulative_sum_model типа cumulative_sum
2025-05-21 05:49:21,577 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='cumulative_sum_model.joblib' установлен для cumulative_sum_model
2025-05-21 05:49:21,578 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib'
2025-05-21 05:49:21,578 - backend.ml_service.detector - INFO - Попытка загрузки модели cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib...
2025-05-21 05:49:21,578 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Загружены baseline_mean=3696.0057142857145, baseline_std=4060.74644512314 из model_state.
2025-05-21 05:49:21,579 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Детектор CUSUM успешно загружен и помечен как обученный.
2025-05-21 05:49:21,579 - backend.ml_service.detector - INFO - Модель cumulative_sum_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib. is_trained=True
2025-05-21 05:49:21,580 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib
2025-05-21 05:49:21,580 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib.
2025-05-21 05:49:21,581 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) инициализирован с весом 1.0.
2025-05-21 05:49:21,581 - backend.ml_service.multilevel_detector - INFO - Многоуровневая система инициализирована: 2 транзакционных детекторов (метод: weighted_average), 2 поведенческих детекторов (метод: weighted_average), 2 детекторов временных рядов (метод: average)
2025-05-21 05:49:21,581 - backend.ml_service.multilevel_service - INFO - Многоуровневая система успешно создана на основе конфигурации из settings.yaml.
2025-05-21 05:49:21,597 - backend.ml_service - INFO - ML Service Logger активен. Уровень: DEBUG. Директория логов ml_service: C:\Users\alex\Desktop\AnomaLens3.0\logs
2025-05-21 12:32:05,730 - backend.ml_service - INFO - Логирование настроено с уровнем DEBUG
2025-05-21 12:32:05,731 - backend.ml_service - INFO - Логи записываются в файл: C:\Users\alex\Desktop\AnomaLens3.0\logs\ml_service_2025-05-21.log
2025-05-21 12:32:08,998 - backend.ml_service.multilevel_service - INFO - Базовый путь для моделей (MultilevelService): C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models
2025-05-21 12:32:08,998 - backend.ml_service.multilevel_service - INFO - Создание/инициализация многоуровневой системы на основе настроек из config.yaml.
2025-05-21 12:32:08,999 - backend.ml_service.multilevel_service - DEBUG - Используется следующая конфигурация для MultilevelAnomalyDetector: {
  "transaction_level": [
    {
      "type": "transaction_vae",
      "model_filename": "ml_trans_vae_model.joblib",
      "weight": 1.0,
      "features": [
        "price",
        "freight_value",
        "product_weight_g",
        "freight_to_price_ratio"
      ],
      "encoding_dim": 10,
      "hidden_dim1": 32,
      "hidden_dim2": 16,
      "epochs": 25,
      "kld_weight": 0.5,
      "dropout_rate": 0.1,
      "shap_background_samples": 50
    },
    {
      "type": "category_price_outlier",
      "model_filename": "ml_category_price_model.joblib",
      "weight": 1.0,
      "category_col": "product_category_name",
      "price_col": "price",
      "threshold": 2.8,
      "min_samples_per_category": 10
    }
  ],
  "behavior_level": [
    {
      "type": "graph",
      "model_filename": "ml_graph_model_v3.joblib",
      "weight": 1.0,
      "use_seller_state_spread": true,
      "use_category_diversity": true,
      "use_seller_degree": true,
      "seller_state_weight": 0.3,
      "category_diversity_weight": 0.4,
      "seller_degree_weight": 0.3
    },
    {
      "type": "seller_pricing_behavior",
      "model_filename": "ml_seller_pricing_model.joblib",
      "weight": 1.0,
      "volatility_threshold": 0.5,
      "range_threshold": 5.0,
      "freight_ratio_threshold": 1.0,
      "min_transactions": 5
    }
  ],
  "time_series_level": [
    {
      "type": "seasonal_deviation",
      "model_filename": "seasonal_deviation_model.joblib",
      "weight": 1.0,
      "window_size": 7,
      "threshold": 2.5
    },
    {
      "type": "cumulative_sum",
      "model_filename": "cumulative_sum_model.joblib",
      "weight": 1.0,
      "window_size": 14,
      "threshold": 2.5,
      "drift_threshold": 4.5
    }
  ],
  "combination_weights": {
    "transaction": 0.4,
    "behavior": 0.3,
    "time_series": 0.3
  },
  "transaction_level_combination_method": "weighted_average",
  "behavior_level_combination_method": "weighted_average",
  "time_series_level_combination_method": "average"
}
2025-05-21 12:32:08,999 - backend.ml_service.multilevel_detector - INFO - Инициализация многоуровневой системы обнаружения аномалий...
2025-05-21 12:32:08,999 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'transaction'...
2025-05-21 12:32:08,999 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) VAEDetector инициализирован. Устройство: cpu, Входная размерность: 4, Признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio']
2025-05-21 12:32:08,999 - backend.ml_service.detector - DEBUG - (transaction_vae_price) Сброс базового состояния детектора (из AnomalyDetector._reset_state).
2025-05-21 12:32:09,000 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Специфичное состояние VAEDetector (порог, SHAP) сброшено.
2025-05-21 12:32:09,000 - backend.ml_service.transaction_detectors - INFO - (transaction_vae_price) TransactionVAEDetector инициализирован. Конфигурационные признаки: ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], Реально используемые признаки (с генерируемыми): ['price', 'freight_value', 'product_weight_g', 'freight_to_price_ratio'], encoding_dim(latent_dim): 10, hidden_dim1(hidden_dim): 32, hidden_dim2: 16, epochs: 25, batch_size: 64, lr: 0.001, kld_w: 0.5, dropout: 0.1
2025-05-21 12:32:09,000 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора transaction_vae_price типа transaction_vae
2025-05-21 12:32:09,000 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_trans_vae_model.joblib' установлен для transaction_vae_price
2025-05-21 12:32:09,000 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib'
2025-05-21 12:32:09,000 - backend.ml_service.detector - INFO - Попытка загрузки модели transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib...
2025-05-21 12:32:09,010 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Загружен порог аномальности: 3.656726
2025-05-21 12:32:09,010 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) StandardScaler успешно инициализирован с параметрами: n_features_in_=4, mean_=(4,), scale_=(4,)
2025-05-21 12:32:09,010 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Фоновые данные SHAP загружены (torch.Size([50, 4]))
2025-05-21 12:32:09,012 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Модель VAE успешно загружена и перемещена на cpu.
2025-05-21 12:32:09,013 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Попытка пересоздания SHAP GradientExplainer после загрузки...
2025-05-21 12:32:09,016 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) SHAP GradientExplainer успешно ПЕРЕСОЗДАН при загрузке модели. Device=cpu, background_data.shape=torch.Size([50, 4])
2025-05-21 12:32:09,017 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Статус SHAP после загрузки: background_data shape=torch.Size([50, 4]), device=cpu, explainer=создан
2025-05-21 12:32:09,017 - backend.ml_service.vae_detector - INFO - (transaction_vae_price) Детектор VAE (is_trained=True) успешно загружен.
2025-05-21 12:32:09,017 - backend.ml_service.detector - INFO - Модель transaction_vae_price успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib. is_trained=True
2025-05-21 12:32:09,017 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора transaction_vae_price из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib
2025-05-21 12:32:09,017 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_trans_vae_model.joblib.
2025-05-21 12:32:09,018 - backend.ml_service.multilevel_detector - INFO -   Детектор 'transaction_vae_price' (тип: transaction_vae) инициализирован с весом 1.0.
2025-05-21 12:32:09,018 - backend.ml_service.transaction_detectors - INFO - CategoryPriceOutlierDetector 'category_price_outlier_model' инициализирован с параметрами: category_col='product_category_name', price_col='price', threshold=2.8, min_samples_per_category=10
2025-05-21 12:32:09,018 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора category_price_outlier_model типа category_price_outlier
2025-05-21 12:32:09,018 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_category_price_model.joblib' установлен для category_price_outlier_model
2025-05-21 12:32:09,019 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib'
2025-05-21 12:32:09,019 - backend.ml_service.detector - INFO - Попытка загрузки модели category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib...
2025-05-21 12:32:09,020 - backend.ml_service.detector - INFO - Модель category_price_outlier_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib. is_trained=True
2025-05-21 12:32:09,021 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора category_price_outlier_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib
2025-05-21 12:32:09,021 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_category_price_model.joblib.
2025-05-21 12:32:09,021 - backend.ml_service.multilevel_detector - INFO -   Детектор 'category_price_outlier_model' (тип: category_price_outlier) инициализирован с весом 1.0.
2025-05-21 12:32:09,021 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'behavior'...
2025-05-21 12:32:09,022 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора graph_graph_analysis типа graph
2025-05-21 12:32:09,022 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_graph_model_v3.joblib' установлен для graph_graph_analysis
2025-05-21 12:32:09,022 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib'
2025-05-21 12:32:09,022 - backend.ml_service.detector - INFO - Попытка загрузки модели graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib...
2025-05-21 12:32:09,023 - backend.ml_service.detector - INFO - Модель graph_graph_analysis успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib. is_trained=True
2025-05-21 12:32:09,023 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора graph_graph_analysis из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib
2025-05-21 12:32:09,023 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_graph_model_v3.joblib.
2025-05-21 12:32:09,023 - backend.ml_service.multilevel_detector - INFO -   Детектор 'graph_graph_analysis' (тип: graph) инициализирован с весом 1.0.
2025-05-21 12:32:09,023 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seller_pricing_behavior_model типа seller_pricing_behavior
2025-05-21 12:32:09,024 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='ml_seller_pricing_model.joblib' установлен для seller_pricing_behavior_model
2025-05-21 12:32:09,024 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib'
2025-05-21 12:32:09,024 - backend.ml_service.detector - INFO - Попытка загрузки модели seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib...
2025-05-21 12:32:09,025 - backend.ml_service.detector - INFO - Модель seller_pricing_behavior_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib. is_trained=True
2025-05-21 12:32:09,025 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seller_pricing_behavior_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib
2025-05-21 12:32:09,026 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\ml_seller_pricing_model.joblib.
2025-05-21 12:32:09,026 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seller_pricing_behavior_model' (тип: seller_pricing_behavior) инициализирован с весом 1.0.
2025-05-21 12:32:09,026 - backend.ml_service.multilevel_detector - INFO - Инициализация детекторов для уровня 'time_series'...
2025-05-21 12:32:09,026 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора seasonal_deviation_model типа seasonal_deviation
2025-05-21 12:32:09,026 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='seasonal_deviation_model.joblib' установлен для seasonal_deviation_model
2025-05-21 12:32:09,026 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib'
2025-05-21 12:32:09,027 - backend.ml_service.detector - INFO - Попытка загрузки модели seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib...
2025-05-21 12:32:09,027 - backend.ml_service.detector - INFO - Модель seasonal_deviation_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib. is_trained=True
2025-05-21 12:32:09,027 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора seasonal_deviation_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib
2025-05-21 12:32:09,028 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\seasonal_deviation_model.joblib.
2025-05-21 12:32:09,028 - backend.ml_service.multilevel_detector - INFO -   Детектор 'seasonal_deviation_model' (тип: seasonal_deviation) инициализирован с весом 1.0.
2025-05-21 12:32:09,028 - backend.ml_service.detector_factory - INFO - Создан экземпляр детектора cumulative_sum_model типа cumulative_sum
2025-05-21 12:32:09,028 - backend.ml_service.detector_factory - DEBUG - Атрибут model_filename='cumulative_sum_model.joblib' установлен для cumulative_sum_model
2025-05-21 12:32:09,028 - backend.ml_service.detector_factory - DEBUG - Проверка существования файла модели: CWD='C:\Users\alex\Desktop\AnomaLens3.0', Путь='C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib'
2025-05-21 12:32:09,029 - backend.ml_service.detector - INFO - Попытка загрузки модели cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib...
2025-05-21 12:32:09,029 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Загружены baseline_mean=3696.0057142857145, baseline_std=4060.74644512314 из model_state.
2025-05-21 12:32:09,029 - backend.ml_service.time_series_detectors - INFO - (cumulative_sum_model) Детектор CUSUM успешно загружен и помечен как обученный.
2025-05-21 12:32:09,029 - backend.ml_service.detector - INFO - Модель cumulative_sum_model успешно обработана при загрузке из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib. is_trained=True
2025-05-21 12:32:09,030 - backend.ml_service.detector_factory - INFO - Успешно загружена модель для детектора cumulative_sum_model из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib
2025-05-21 12:32:09,030 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) попытка создания и загрузки из C:\Users\alex\Desktop\AnomaLens3.0\backend/ml_service/models\cumulative_sum_model.joblib.
2025-05-21 12:32:09,030 - backend.ml_service.multilevel_detector - INFO -   Детектор 'cumulative_sum_model' (тип: cumulative_sum) инициализирован с весом 1.0.
2025-05-21 12:32:09,030 - backend.ml_service.multilevel_detector - INFO - Многоуровневая система инициализирована: 2 транзакционных детекторов (метод: weighted_average), 2 поведенческих детекторов (метод: weighted_average), 2 детекторов временных рядов (метод: average)
2025-05-21 12:32:09,030 - backend.ml_service.multilevel_service - INFO - Многоуровневая система успешно создана на основе конфигурации из settings.yaml.
2025-05-21 12:32:09,040 - backend.ml_service - INFO - ML Service Logger активен. Уровень: DEBUG. Директория логов ml_service: C:\Users\alex\Desktop\AnomaLens3.0\logs
